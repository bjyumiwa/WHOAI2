<!-- FILE: /WHOAI2/whoai_care_music.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãŠä¸–è©± / æ›²ã¥ãã‚Š | WhoAI</title>
<meta name="color-scheme" content="dark light" />
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
    background:#000 url("space_background.png") center/cover fixed no-repeat;
    display:grid;grid-template-rows:auto 1fr auto;gap:10px;padding:16px
  }
  header,footer{display:flex;align-items:center;justify-content:space-between}
  header .left{display:flex;gap:8px;align-items:center}
  .chip{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.25)}
  .wrap{
    display:grid;gap:14px;grid-template-columns: 200px 1fr;align-items:start
  }
  .avatar{
    width:180px;height:180px;object-fit:contain;image-rendering:auto;
    animation:float 4s ease-in-out infinite
  }
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  .panel{
    background:rgba(0,0,0,.35);backdrop-filter:blur(6px);
    border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:14px
  }
  .h{font-weight:700}
  .btns{display:flex;flex-wrap:wrap;gap:8px}
  button,.linkbtn{
    cursor:pointer;border-radius:12px;border:1px solid rgba(255,255,255,.2);
    background:rgba(0,0,0,.25);color:#fff;padding:10px 12px
  }
  button:hover,.linkbtn:hover{background:rgba(255,255,255,.08)}
  .notes{
    display:grid;grid-template-columns:repeat(10, 1fr);gap:6px;margin-top:8px
  }
  .note{
    aspect-ratio:1/1;border-radius:8px;display:grid;place-items:center;
    border:1px dashed rgba(255,255,255,.18);font-size:12px;opacity:.7
  }
  .note.filled{
    border-style:solid;background:rgba(255,255,255,.12);opacity:1;font-weight:700
  }
  .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .small{font-size:12px;opacity:.85}
</style>
</head>
<body>
<header>
  <div class="left">
    <span class="chip" id="charName">ã‚­ãƒ£ãƒ©å</span>
    <span class="chip" id="colorChip">color: -</span>
    <span class="chip">ãŠä¸–è©±ã™ã‚‹ã¨éŸ³ç¬¦ãŒå¢—ãˆã‚‹ã‚ˆ ğŸµ</span>
  </div>
  <a class="linkbtn" href="after10_menu.html">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
</header>

<main class="wrap">
  <div class="panel" style="display:grid;place-items:center">
    <img id="avatar" class="avatar" alt="character" />
    <div class="small" id="mood">çŠ¶æ…‹ï¼šãµã¤ã†</div>
  </div>

  <section class="twoCol">
    <div class="panel">
      <div class="h">ãŠä¸–è©±</div>
      <p class="small">å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§éŸ³ç¬¦ +1ã€‚ä¸€å®šæ•°ãŸã¾ã‚‹ã¨ã€Œ1ãƒ•ãƒ¬ãƒ¼ã‚ºæ¼”å¥ã€ãŒã§ãã¾ã™ã€‚</p>
      <div class="btns">
        <button data-act="meal">ğŸš é£Ÿäº‹</button>
        <button data-act="toilet">ğŸš½ æ’æ³„</button>
        <button data-act="shower">ğŸš¿ ã‚·ãƒ£ãƒ¯ãƒ¼</button>
        <button data-act="pet">ğŸ¤² ãªã§ãªã§</button>
      </div>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="h">éŸ³ç¬¦</div>
        <div class="small">åˆè¨ˆï¼š<b id="noteCount">0</b></div>
      </div>
      <div id="noteGrid" class="notes"></div>

      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="btnPlay" disabled>â–¶ ãƒ©ãƒ³ãƒ€ãƒ ã§1ãƒ•ãƒ¬ãƒ¼ã‚ºæ¼”å¥</button>
        <button id="btnReset">â†º éŸ³ç¬¦ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <p class="small">å¿…è¦éŸ³ç¬¦ï¼š<span id="needSpan">8</span>ï¼ˆæ›²ã«ã‚ˆã£ã¦ãƒ©ãƒ³ãƒ€ãƒ ï¼‰</p>
    </div>
  </section>
</main>

<footer>
  <div class="small">WhoAI</div>
  <a class="linkbtn" href="whoai_talk_evolved.html">ğŸ—¨ï¸ ä¼šè©±ã«è¡Œã</a>
</footer>

<script>
  // ====== æ—¢å­˜ä»•æ§˜ã®ã‚­ãƒ¼ ======
  const TALK_ENDPOINT = localStorage.getItem("TALK_ENDPOINT") || ""; // è§¦ã‚‰ãªã„æ–¹é‡

  // ====== åå‰ã¨è‰²ã®åæ˜  ======
  const charName = localStorage.getItem("characterName") || "ã‚­ãƒ£ãƒ©";
  const color = (localStorage.getItem("macaronColor") || "pink").toLowerCase();
  document.getElementById('charName').textContent = charName;
  document.getElementById('colorChip').textContent = `color: ${color}`;

  // ====== ã‚­ãƒ£ãƒ©ç”»åƒï¼ˆé€²åŒ–å¾Œ closed ã‚’å„ªå…ˆã€ç„¡ã‘ã‚Œã°ã‚¿ãƒï¼‰ ======
  const avatarEl = document.getElementById('avatar');
  const candidates = [`${color}_closed.png`, `tane_${color}.png`];
  (async ()=>{
    for (const src of candidates){
      const ok = await fetch(src,{method:'HEAD'}).then(r=>r.ok).catch(()=>false);
      if(ok){ avatarEl.src = src; return; }
    }
  })();

  // ====== ãŠä¸–è©± â†’ éŸ³ç¬¦ç®¡ç† ======
  const LS_KEY_NOTES = "whoai_notes_total";
  const LS_KEY_MOOD  = "whoai_last_mood";
  const moodEl = document.getElementById('mood');

  let notes = parseInt(localStorage.getItem(LS_KEY_NOTES) || "0", 10);
  let need  = 8; // å¿…è¦éŸ³ç¬¦ã®åˆæœŸå€¤ï¼ˆæ›²ã«ã‚ˆã‚Šä¸Šæ›¸ãï¼‰

  // æ›²ã”ã¨ã«å¿…è¦éŸ³ç¬¦ã¨è­œåˆ—ï¼ˆå‘¨æ³¢æ•°ã¨é•·ã•ï¼‰
  // 1ãƒ•ãƒ¬ãƒ¼ã‚ºã ã‘/ãƒ†ãƒ³ãƒã¯ç°¡æ˜“å›ºå®š
  const SONGS = [
    { name: "ãã‚‰ãã‚‰æ˜Ÿ", need: 8,  seq: "C C G G A A G2 F F E E D D C2" },
    { name: "ãƒãƒƒãƒ”ãƒ¼ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼", need: 10, seq: "C C D C F E2 C C D C G F2" },
    { name: "ãƒ­ãƒ³ãƒ‰ãƒ³æ©‹", need: 8,  seq: "G A G F E F G D E F E F G2" }
  ];

  // éŸ³åâ†’å‘¨æ³¢æ•°ï¼ˆC4=261.63ï¼‰ç°¡æ˜“
  const NOTE_FREQ = {
    'C':261.63,'D':293.66,'E':329.63,'F':349.23,'G':392.00,'A':440.00,'B':493.88
  };

  // UI
  const noteCountEl = document.getElementById('noteCount');
  const needSpan = document.getElementById('needSpan');
  const noteGrid = document.getElementById('noteGrid');
  const btnPlay = document.getElementById('btnPlay');
  const btnReset = document.getElementById('btnReset');

  function renderNotes(){
    noteCountEl.textContent = notes;
    noteGrid.innerHTML = "";
    const cells = Math.max(10, need); // æœ€ä½10ãƒã‚¹è¡¨ç¤º
    for (let i=0;i<cells;i++){
      const d = document.createElement('div');
      d.className = 'note' + (i < notes ? ' filled':'' );
      d.textContent = i < notes ? 'â™ª' : '';
      noteGrid.appendChild(d);
    }
    btnPlay.disabled = notes < need;
  }

  function pickSong(){
    const song = SONGS[Math.floor(Math.random()*SONGS.length)];
    need = song.need;
    needSpan.textContent = need;
    return song;
  }

  // åˆæœŸï¼šæ›²æŠ½é¸ï¼ˆãƒšãƒ¼ã‚¸ã”ã¨ã«å¤‰ã‚ã‚‹æ¥½ã—ã•ï¼‰
  let currentSong = pickSong();
  renderNotes();

  // ãŠä¸–è©±æ“ä½œ
  const btns = document.querySelectorAll('button[data-act]');
  btns.forEach(b=>{
    b.addEventListener('click', ()=>{
      const act = b.dataset.act;
      // éŸ³ç¬¦ +1
      notes += 1;
      localStorage.setItem(LS_KEY_NOTES, String(notes));
      // æ°—åˆ†ï¼ˆè¡¨ç¤ºã ã‘ã®æ¼”å‡ºï¼‰
      const moodText = {
        meal:"ãŠãªã‹ã„ã£ã±ã„ï¼",
        toilet:"ã™ã£ãã‚Šï¼",
        shower:"ã•ã£ã±ã‚Šï¼",
        pet:"ã†ã‚Œã—ã„ï¼"
      }[act] || "ãµã¤ã†";
      moodEl.textContent = `çŠ¶æ…‹ï¼š${moodText}`;
      renderNotes();
      // ã¡ã‚‡ã£ã¨ã‚¢ãƒ‹ãƒ¡
      avatarEl.style.transform = "scale(1.04)";
      setTimeout(()=>avatarEl.style.transform="",160);
    });
  });

  // æ¼”å¥ï¼ˆWebAudio åŸå§‹å®Ÿè£…ï¼‰
  btnPlay.addEventListener('click', async ()=>{
    if (notes < need) return;

    // æ¼”å¥å¾Œã¯éŸ³ç¬¦ã‚’æ¶ˆè²»ï¼ˆä½œæ›²ã—ãŸæ„Ÿã˜ã‚’å‡ºã™ï¼‰
    notes -= need;
    if (notes < 0) notes = 0;
    localStorage.setItem(LS_KEY_NOTES, String(notes));
    renderNotes();

    // æ¬¡ã®æ›²ã‚’æŠ½é¸
    currentSong = pickSong();

    // å†ç”Ÿ
    await playPhrase(currentSong.seq);
  });

  // ãƒªã‚»ãƒƒãƒˆ
  btnReset.addEventListener('click', ()=>{
    notes = 0;
    localStorage.setItem(LS_KEY_NOTES, "0");
    renderNotes();
  });

  // ç°¡æ˜“ã‚·ãƒ¼ã‚±ãƒ³ã‚µï¼š "C C G G A A G2" ãªã©ã‚’å†ç”Ÿ
  async function playPhrase(seqStr){
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const unit = 0.25; // 1å˜ä½ï¼ˆç§’ï¼‰
    let t = ctx.currentTime + 0.05;

    const tokens = seqStr.trim().split(/\s+/);
    for (const tok of tokens){
      // æœ«å°¾ã«é•·ã•ï¼ˆæ•°å­—ï¼‰ãŒä»˜ã‘ã° Ã—lengthã€ç„¡ã‘ã‚Œã°1
      const m = tok.match(/^([A-G])(\d+)?$/i);
      if (!m){ t += unit; continue; }
      const name = m[1].toUpperCase();
      const mult = m[2] ? parseInt(m[2],10) : 1;
      const freq = NOTE_FREQ[name] || 0;
      const dur = unit * mult;

      if (freq>0){
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = freq;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.5, t+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
        o.connect(g).connect(ctx.destination);
        o.start(t);
        o.stop(t+dur+0.02);
      }
      t += dur * 1.05; // ã¡ã‚‡ã„é–“ã‚’ç©ºã‘ã‚‹
      await sleep(dur*1000*0.5); // ä½“æ„Ÿã®ãŸã‚è»½ãå¾…ã¤ï¼ˆéŸ³åˆ‡ã‚Œé˜²æ­¢ç”¨ã§ã¯ãªã„ï¼‰
    }
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
</script>
</body>
</html>
