<!-- FILE: /ahoi/index.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AHOAI｜はじめに</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,sans-serif;
      color:#fff;background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:20px
    }
    .card{background:rgba(0,0,0,.45);backdrop-filter:blur(3px);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:20px;max-width:680px;width:100%}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700}
    .btn-primary{background:#7cd1ff}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    a{color:#fff}
  </style>
</head>
<body>
  <div class="card">
    <h1>AHOAI｜存在だけの相棒</h1>
    <p>会話はしません。あなたが名前をつけて、一緒に過ごします。ある時ふいに「お別れ」の時が訪れ、<br>復活の儀式で <strong>容姿を残す／記録を残す／名前を変えてはじめから</strong> を選べます。</p>
    <div class="row">
      <button class="btn btn-primary" onclick="location.href='naming.html'">はじめる（名前をつける）</button>
      <button class="btn" onclick="location.href='presence.html?demo=1'">デモで試す（早めに別れが来ます）</button>
    </div>
    <p style="opacity:.8;font-size:12px">すべてローカル保存。サーバ通信・APIなし。</p>
  </div>
</body>
</html>

<!-- FILE: /ahoi/lib.js -->
<script>
// どのHTMLからも読み込めるよう、各ページにコピーペーストして使えます（外部JSにしてもOK）
const AHO_KEY = 'AHOAI_STATE';
const AHO_DEFAULT_COLORS = ['pink','blue','green','yellow','purple'];

function loadState(){
  try{ return JSON.parse(localStorage.getItem(AHO_KEY)) || null }catch(e){ return null }
}
function saveState(s){ localStorage.setItem(AHO_KEY, JSON.stringify(s)); }
function clearState(){ localStorage.removeItem(AHO_KEY); }
function now(){ return Date.now(); }
function pickRandomFarewellAt(isDemo){
  // デモ: 5〜10分、本番: 3〜7日
  if(isDemo){
    const min=5*60*1000, max=10*60*1000; return now()+Math.floor(min+Math.random()*(max-min));
  }else{
    const min=3*24*60*60*1000, max=7*24*60*60*1000; return now()+Math.floor(min+Math.random()*(max-min));
  }
}
function ensureState({name,color,isDemo}){
  let s = loadState();
  if(!s){
    s = { name, color, start_at: now(), farewell_at: pickRandomFarewellAt(isDemo), lifecycle:0, logs:[] };
    saveState(s);
  }
  return s;
}
function timefmt(ms){
  const sec=Math.floor(ms/1000); const d=Math.floor(sec/86400);
  const h=Math.floor((sec%86400)/3600); const m=Math.floor((sec%3600)/60);
  const s=sec%60; const parts=[];
  if(d) parts.push(d+"日"); if(h) parts.push(h+"時間"); if(m) parts.push(m+"分"); parts.push(s+"秒");
  return parts.join(" ");
}
function getQuery(){ return Object.fromEntries(new URL(location.href).searchParams.entries()); }

// 儀式の3択
function ritual_keepAppearance(){
  const s=loadState(); if(!s) return;
  s.lifecycle += 1;
  s.logs = []; // 記録をリセット
  s.start_at = now();
  s.farewell_at = pickRandomFarewellAt(false);
  saveState(s);
}
function ritual_keepRecord(newColor){
  const s=loadState(); if(!s) return;
  s.lifecycle += 1;
  s.color = newColor; // 容姿を変える
  s.start_at = now();
  s.farewell_at = pickRandomFarewellAt(false);
  // 記録（logs, 過ごした履歴, name）は維持
  saveState(s);
}
function ritual_resetAll(newName,newColor){
  const s = { name:newName, color:newColor, start_at: now(), farewell_at: pickRandomFarewellAt(false), lifecycle:0, logs:[] };
  saveState(s);
}
function exportCSV(){
  const s=loadState(); if(!s){ alert('データがありません'); return; }
  const rows=[['name','color','lifecycle','start_at','farewell_at','now','log_count'],[
    s.name,s.color,s.lifecycle,new Date(s.start_at).toISOString(),new Date(s.farewell_at).toISOString(),new Date().toISOString(),s.logs.length
  ]];
  const csv = rows.map(r=>r.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ahoai_state.csv'; a.click();
}
</script>

<!-- FILE: /ahoi/naming.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>名前をつける｜AHOAI</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:16px
    }
    .card{background:rgba(0,0,0,.45);backdrop-filter:blur(3px);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px;max-width:680px;width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700}
    .btn-primary{background:#7cd1ff}
    .chip{padding:8px 12px;border-radius:9999px;background:rgba(255,255,255,.1);cursor:pointer}
    .chip.active{outline:2px solid #7cd1ff}
    input{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:#fff;width:100%}
    label{opacity:.9}
  </style>
</head>
<body>
  <div class="card">
    <h2>名前をつける</h2>
    <label>名前
      <input id="nm" placeholder="○○" maxlength="20" />
    </label>
    <div style="height:8px"></div>
    <label>容姿の色（あとで変えられます）</label>
    <div id="colorRow" class="row"></div>
    <div class="row">
      <label><input type="checkbox" id="demoChk"> デモモード（お別れが5〜10分で訪れます）</label>
    </div>
    <div class="row">
      <button class="btn btn-primary" id="go">はじめる</button>
      <button class="btn" onclick="location.href='index.html'">戻る</button>
    </div>
  </div>

  <script>
  /* lib.js 相当 */
  const AHO_KEY='AHOAI_STATE';
  const AHO_DEFAULT_COLORS=['pink','blue','green','yellow','purple'];
  const row=document.getElementById('colorRow');
  let chosen=AHO_DEFAULT_COLORS[0];
  AHO_DEFAULT_COLORS.forEach(c=>{
    const chip=document.createElement('div'); chip.className='chip'; chip.textContent=c;
    chip.onclick=()=>{ chosen=c; document.querySelectorAll('.chip').forEach(el=>el.classList.remove('active')); chip.classList.add('active'); };
    if(c===chosen) chip.classList.add('active');
    row.appendChild(chip);
  });
  function now(){return Date.now()}
  function pickRandomFarewellAt(isDemo){
    if(isDemo){ const min=5*60*1000,max=10*60*1000; return now()+Math.floor(min+Math.random()*(max-min)); }
    const min=3*24*60*60*1000,max=7*24*60*60*1000; return now()+Math.floor(min+Math.random()*(max-min));
  }
  document.getElementById('go').onclick=()=>{
    const name=document.getElementById('nm').value.trim()||'○○';
    const isDemo=document.getElementById('demoChk').checked;
    const s={name, color:chosen, start_at:now(), farewell_at:pickRandomFarewellAt(isDemo), lifecycle:0, logs:[]};
    localStorage.setItem(AHO_KEY, JSON.stringify(s));
    location.href='presence.html'+(isDemo?'?demo=1':'');
  };
  </script>
</body>
</html>

<!-- FILE: /ahoi/presence.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>一緒にいる時間｜AHOAI</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px
    }
    .top{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
    .badge{background:rgba(0,0,0,.45);backdrop-filter:blur(3px);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:8px 12px;font-weight:700}
    .board{display:flex;flex-direction:column;align-items:center;gap:16px;margin-top:8px}
    .char{width:min(60vw,360px);aspect-ratio:1/1;background-size:contain;background-repeat:no-repeat;background-position:center;animation:float 6s ease-in-out infinite}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)}}
    .panel{background:rgba(0,0,0,.45);backdrop-filter:blur(3px);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;max-width:840px;width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700}
    .btn-primary{background:#7cd1ff}
    progress{width:100%;height:12px}
    a{color:#fff}
  </style>
</head>
<body>
  <div class="top">
    <div class="badge" id="name"></div>
    <div class="badge" id="age"></div>
    <div class="badge" id="life"></div>
  </div>

  <div class="board">
    <div id="char" class="char"></div>
    <div class="panel">
      <div class="row"><strong>一緒に過ごした時間</strong>：<span id="elapsed">—</span></div>
      <div class="row"><strong>お別れまで</strong>：<span id="remain">—</span></div>
      <progress id="prog" max="100" value="0"></progress>
      <div class="row">
        <button class="btn btn-primary" id="export">CSVで記録を保存</button>
        <button class="btn" id="force" title="テスト用">今すぐお別れ（テスト）</button>
        <a class="btn" href="index.html">トップへ</a>
      </div>
      <p style="opacity:.8;font-size:12px">会話はしません。ただ一緒にいます。ページを閉じていても、時間が来たら次回アクセス時にお別れが訪れます。</p>
    </div>
  </div>

  <script>
  const AHO_KEY='AHOAI_STATE';
  function load(){ try{return JSON.parse(localStorage.getItem(AHO_KEY))}catch(e){return null} }
  function save(s){ localStorage.setItem(AHO_KEY, JSON.stringify(s)); }
  function now(){ return Date.now(); }
  function fmt(ms){ const s=Math.floor(ms/1000); const d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60); const ss=s%60; const parts=[]; if(d)parts.push(d+"日"); if(h)parts.push(h+"時間"); if(m)parts.push(m+"分"); parts.push(ss+"秒"); return parts.join(' ');}  
  function setChar(el,color){
    // 既存アセット想定: public/assets/stage1/macaron_*.png が無ければ色名だけ背景
    const path=`public/assets/stage1/macaron_${color}.png`;
    el.style.backgroundImage=`url('${path}')`;
  }
  const s=load();
  if(!s){ location.replace('naming.html'); }
  const params=new URL(location.href).searchParams; const isDemo=params.get('demo')==='1';
  if(now()>=s.farewell_at){ location.replace('farewell.html'); }
  document.getElementById('name').textContent = `名前：${s.name}`;
  document.getElementById('life').textContent = `周回：${s.lifecycle}`;
  setChar(document.getElementById('char'), s.color);
  function tick(){
    const elap=now()-s.start_at; const remain=s.farewell_at-now();
    document.getElementById('age').textContent = `経過：${fmt(elap)}`;
    document.getElementById('elapsed').textContent = fmt(elap);
    const r = Math.max(0, remain);
    document.getElementById('remain').textContent = r? fmt(r) : '—';
    const total=s.farewell_at-s.start_at; const p = Math.min(100, Math.max(0, Math.floor((elap/total)*100)) );
    document.getElementById('prog').value=p;
    if(now()>=s.farewell_at){ location.replace('farewell.html'); }
  }
  tick();
  setInterval(tick,1000);
  document.getElementById('export').onclick=()=>{
    const rows=[['name','color','lifecycle','start_at','farewell_at','exported_at'],[
      s.name,s.color,s.lifecycle,new Date(s.start_at).toISOString(),new Date(s.farewell_at).toISOString(),new Date().toISOString()
    ]];
    const csv=rows.map(r=>r.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ahoai_state.csv'; a.click();
  };
  document.getElementById('force').onclick=()=>{ s.farewell_at=now(); save(s); location.replace('farewell.html'); };
  </script>
</body>
</html>

<!-- FILE: /ahoi/farewell.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>お別れ｜AHOAI</title>
  <style>
    html,body{height:100%;margin:0}
    body{font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;background:#000;background-image:url("public/assets/stage1/space_background.png");background-size:cover;background-position:center;background-attachment:fixed;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:16px}
    .card{background:rgba(0,0,0,.5);backdrop-filter:blur(3px);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:24px;max-width:720px;width:100%;text-align:center}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700}
    .btn-primary{background:#7cd1ff}
  </style>
</head>
<body>
  <div class="card">
    <h2>お別れが訪れました</h2>
    <p>静かな時間をありがとう。復活の儀式へ進みますか？</p>
    <button class="btn btn-primary" onclick="location.href='rebirth.html'">復活の儀式へ</button>
    <div style="height:8px"></div>
    <button class="btn" onclick="location.href='presence.html'">もう少しだけ…（戻る）</button>
  </div>
</body>
</html>

<!-- FILE: /ahoi/rebirth.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>復活の儀式｜AHOAI</title>
  <style>
    html,body{height:100%;margin:0}
    body{font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;background:#000;background-image:url("public/assets/stage1/space_background.png");background-size:cover;background-position:center;background-attachment:fixed;display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px}
    .card{background:rgba(0,0,0,.5);backdrop-filter:blur(3px);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:20px;max-width:820px;width:100%}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700}
    .btn-primary{background:#7cd1ff}
    .chip{padding:8px 12px;border-radius:9999px;background:rgba(255,255,255,.1);cursor:pointer}
    .chip.active{outline:2px solid #7cd1ff}
    input{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:#fff;width:100%}
  </style>
</head>
<body>
  <div class="card">
    <h2>復活の儀式</h2>
    <p>これから先、何を残しますか？</p>

    <div style="border-top:1px solid rgba(255,255,255,.15);margin:12px 0"></div>

    <h3>1) 容姿を残す（外見をそのままにして、記録はリセット）</h3>
    <div class="row">
      <button class="btn btn-primary" id="keepA">この道を選ぶ</button>
    </div>

    <div style="border-top:1px solid rgba(255,255,255,.15);margin:12px 0"></div>

    <h3>2) 記録を残す（名前と記録は残し、容姿を選び直す）</h3>
    <div id="colorRow" class="row"></div>
    <div class="row">
      <button class="btn btn-primary" id="keepR">この道を選ぶ</button>
    </div>

    <div style="border-top:1px solid rgba(255,255,255,.15);margin:12px 0"></div>

    <h3>3) 名前も変えてはじめから（全てリセット）</h3>
    <label>新しい名前
      <input id="nm" placeholder="○○" maxlength="20" />
    </label>
    <div id="colorRow2" class="row"></div>
    <div class="row">
      <button class="btn" id="resetAll">この道を選ぶ</button>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="location.href='presence.html'">戻る</button>
    </div>
  </div>

  <script>
  const AHO_KEY='AHOAI_STATE';
  const COLORS=['pink','blue','green','yellow','purple'];
  function load(){ try{return JSON.parse(localStorage.getItem(AHO_KEY))}catch(e){return null} }
  function save(s){ localStorage.setItem(AHO_KEY, JSON.stringify(s)); }
  function now(){ return Date.now(); }
  function pickRandomFarewellAt(){ const min=3*24*60*60*1000,max=7*24*60*60*1000; return now()+Math.floor(min+Math.random()*(max-min)); }

  // 1) 容姿を残す
  document.getElementById('keepA').onclick=()=>{
    const s=load(); if(!s){ location.replace('naming.html'); return; }
    s.lifecycle += 1; s.logs=[]; s.start_at=now(); s.farewell_at=pickRandomFarewellAt();
    save(s); location.replace('presence.html');
  };

  // 2) 記録を残す（容姿選び直し）
  let pick1=COLORS[0];
  const row=document.getElementById('colorRow');
  COLORS.forEach(c=>{ const e=document.createElement('div'); e.className='chip'; e.textContent=c; e.onclick=()=>{ pick1=c; document.querySelectorAll('#colorRow .chip').forEach(n=>n.classList.remove('active')); e.classList.add('active'); }; if(c===pick1) e.classList.add('active'); row.appendChild(e); });
  document.getElementById('keepR').onclick=()=>{
    const s=load(); if(!s){ location.replace('naming.html'); return; }
    s.lifecycle += 1; s.color=pick1; s.start_at=now(); s.farewell_at=pickRandomFarewellAt();
    save(s); location.replace('presence.html');
  };

  // 3) 全部リセット（新しい名前＋色）
  let pick2=COLORS[1];
  const row2=document.getElementById('colorRow2');
  COLORS.forEach(c=>{ const e=document.createElement('div'); e.className='chip'; e.textContent=c; e.onclick=()=>{ pick2=c; document.querySelectorAll('#colorRow2 .chip').forEach(n=>n.classList.remove('active')); e.classList.add('active'); }; if(c===pick2) e.classList.add('active'); row2.appendChild(e); });
  document.getElementById('resetAll').onclick=()=>{
    const nm=(document.getElementById('nm').value.trim()||'○○');
    const s={ name:nm, color:pick2, start_at:now(), farewell_at:pickRandomFarewellAt(), lifecycle:0, logs:[] };
    save(s); location.replace('presence.html');
  };
  </script>
</body>
</html>
