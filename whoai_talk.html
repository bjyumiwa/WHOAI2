<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- FILE: /whoai_talk.html (Observation mode: no user chat, feed macarons) -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¦³å¯Ÿãƒ¢ãƒ¼ãƒ‰ | WhoAIï¼ˆã‚¿ãƒï¼‰</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --glass: rgba(0,0,0,.45);
      --glass-strong: rgba(0,0,0,.6);
      --text: #fff;
      --accent: #8de0ff;
      --shadow: 0 10px 40px rgba(0,0,0,.35);
      --radius: 20px;
    }
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Yu Gothic", sans-serif;
      color:var(--text);
      background:#000 url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:10px;padding:10px
    }

    .topbar{position:fixed;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .badge{background:var(--glass);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);border-radius:14px;padding:8px 12px;box-shadow:var(--shadow);font-weight:700}
    .chips{display:flex;gap:8px;align-items:center}
    .chip{appearance:none;border:0;cursor:pointer;border-radius:999px;padding:6px 10px;font-weight:700;background:var(--glass);color:#fff}
    .chip[aria-pressed="true"]{outline:2px solid var(--accent)}

    main{margin-top:56px;display:grid;grid-template-columns:1fr;place-items:center;gap:12px;width:min(96vw,980px)}

    .stage{width:min(90vw,680px);aspect-ratio:1/1;border-radius:24px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.35);box-shadow:var(--shadow);display:grid;place-items:center;overflow:hidden}
    .stage img{width:85%;height:85%;object-fit:contain;animation:float 5s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

    .log{width:min(96vw,980px);max-height:40vh;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:10px}
    .bubble{align-self:center;max-width:720px;background:var(--glass);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:10px 14px}

    .controls{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .btn{appearance:none;border:0;cursor:pointer;border-radius:16px;padding:12px 16px;font-weight:900;background:linear-gradient(135deg,#9df,#fcf);color:#111;box-shadow:var(--shadow)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .meter{height:10px;width:min(96vw,420px);border-radius:999px;background:rgba(255,255,255,.15);overflow:hidden}
    .fill{height:100%;width:0;background:linear-gradient(90deg,#9df,#bdff9d);transition:width .35s ease}

    .note{font-size:12px;opacity:.85;text-align:center}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="badge" id="who">ã‚ãªãŸï¼šâ€” ï¼ ã‚­ãƒ£ãƒ©ï¼šâ€”</div>
    <div class="chips" role="group" aria-label="Language Switch">
      <button class="chip" data-lang="ja" aria-pressed="true">æ—¥æœ¬èª</button>
      <button class="chip" data-lang="en">English</button>
      <button class="chip" data-lang="zh-CN">ç®€ä½“</button>
      <button class="chip" data-lang="zh-TW">ç¹é«”</button>
      <button class="chip" data-lang="ko">í•œêµ­ì–´</button>
    </div>
  </div>

  <main>
    <section class="stage" aria-live="polite">
      <img id="charImg" src="" alt="tane character" onerror="this.style.display='none'" />
    </section>

    <div class="meter" aria-label="XP">
      <div id="xpFill" class="fill"></div>
    </div>

    <section class="controls">
      <button id="feedBtn" class="btn">ğŸ¬ ãƒã‚«ãƒ­ãƒ³ã‚’ã‚ã’ã‚‹</button>
      <button id="restBtn" class="btn">ğŸ’¤ è¦³å¯Ÿã™ã‚‹ï¼ˆè‡ªå‹•ï¼‰</button>
    </section>

    <section id="log" class="log" aria-live="polite"></section>

    <p id="footNote" class="note">â€» ä¼šè©±å…¥åŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚çœºã‚ã¦ã€ã¨ãã©ããƒã‚«ãƒ­ãƒ³ã‚’ã‚ã’ã¦ãã ã•ã„ã€‚ä¸€å®šã®XPã§é€²åŒ–ã‚¤ãƒ™ãƒ³ãƒˆã¸ã€‚</p>
  </main>

  <script>
    // ===== Keys & i18n =====
    const KEY = {
      lang:  'whoai_lang',
      you:   'whoai_player_name',
      buddy: 'whoai_char_name',
      color: 'whoai_color',
      xp:    'whoai_xp',
      log:   'whoai_log',
      stage: 'whoai_stage'
    };

    const I18N = {
      'ja': {
        feed: 'ğŸ¬ ãƒã‚«ãƒ­ãƒ³ã‚’ã‚ã’ã‚‹', rest: 'ğŸ’¤ è¦³å¯Ÿã™ã‚‹ï¼ˆè‡ªå‹•ï¼‰',
        lines: [
          'â€¦â€¦ ãã‚‡ã‚ ãã‚‡ã‚',
          'ãµã‚ãµã‚â€¦â€¦',
          'ï¼ˆã‚ãªãŸã‚’è¦‹ä¸Šã’ã¦ã„ã‚‹ï¼‰',
          'ãã‚‰ã‚Šâ˜…',
          'ã™ã‚„â€¦â€¦ï¼ˆã†ã¨ã†ã¨ï¼‰'
        ],
        react: ['ã±ã‚ã£ï¼','ã‚‚ãã‚‚ã','ã´ã‚‡ã‚“ï¼','ã«ã“ã£'],
        foot: 'â€» ä¼šè©±å…¥åŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚çœºã‚ã¦ã€ã¨ãã©ããƒã‚«ãƒ­ãƒ³ã‚’ã‚ã’ã¦ãã ã•ã„ã€‚ä¸€å®šã®XPã§é€²åŒ–ã‚¤ãƒ™ãƒ³ãƒˆã¸ã€‚',
        evoReady: 'ãã‚ãã‚å¤‰åŒ–ã®äºˆæ„Ÿâ€¦â€¦ï¼ˆãƒã‚«ãƒ­ãƒ³ã‚’ã‚‚ã†ä¸€ã¤ï¼Ÿï¼‰',
        evoGo: 'é€²åŒ–ã®æ°—é…ãŒæº€ã¡ãŸï¼ æ¬¡ã¸é€²ã¿ã¾ã™ã€‚'
      },
      'en': {
        feed: 'ğŸ¬ Give a macaron', rest: 'ğŸ’¤ Observe (auto)',
        lines: ['â€¦looking around','floatingâ€¦','(stares at you)','sparkleâ˜…','dozingâ€¦'],
        react: ['yay!','munch munch','hop!','smile'],
        foot: 'No chat input. Just observe and feed macarons. Evolves at certain XP.',
        evoReady: 'Something is about to changeâ€¦ (one more macaron?)',
        evoGo: 'Evolution aura is full! Moving on.'
      },
      'zh-CN': {
        feed: 'ğŸ¬ é€’ä¸€å—é©¬å¡é¾™', rest: 'ğŸ’¤ è§‚å¯Ÿï¼ˆè‡ªåŠ¨ï¼‰',
        lines: ['â€¦â€¦ä¸œå¼ è¥¿æœ›','è½»è½»é£˜åŠ¨â€¦â€¦','ï¼ˆæŠ¬å¤´çœ‹ç€ä½ ï¼‰','é—ªé—ªå‘å…‰â˜…','æ‰“ç›¹â€¦â€¦'],
        react: ['è€¶ï¼','å’€åš¼å’€åš¼','è·³ï¼','ç¬‘'],
        foot: 'ä¸éœ€è¦å¯¹è¯è¾“å…¥ã€‚åªè¦è§‚å¯Ÿå¹¶å¶å°”å–‚é©¬å¡é¾™ã€‚è¾¾åˆ°ä¸€å®šXPä¼šè¿›åŒ–ã€‚',
        evoReady: 'è¦å˜åŒ–äº†â€¦â€¦ï¼ˆå†æ¥ä¸€å—ï¼Ÿï¼‰',
        evoGo: 'è¿›åŒ–æ°”æ¯æ»¡äº†ï¼ç»§ç»­å‰è¿›ã€‚'
      },
      'zh-TW': {
        feed: 'ğŸ¬ çµ¦ä¸€å¡Šé¦¬å¡é¾', rest: 'ğŸ’¤ è§€å¯Ÿï¼ˆè‡ªå‹•ï¼‰',
        lines: ['â€¦â€¦æ±å¼µè¥¿æœ›','è¼•è¼•æ¼‚æµ®â€¦â€¦','ï¼ˆæŠ¬é ­çœ‹è‘—ä½ ï¼‰','é–ƒé–ƒç™¼äº®â˜…','æ‰“ç›¹â€¦â€¦'],
        react: ['è€¶ï¼','å’€åš¼å’€åš¼','è·³ï¼','ç¬‘'],
        foot: 'ä¸éœ€è¦è¼¸å…¥å°è©±ã€‚åªéœ€è§€å¯Ÿã€å¶çˆ¾é¤µé¦¬å¡é¾ã€‚é”åˆ°ä¸€å®šXPæœƒé€²åŒ–ã€‚',
        evoReady: 'å¥½åƒè¦è®ŠåŒ–äº†â€¦â€¦ï¼ˆå†é¤µä¸€å¡Šï¼Ÿï¼‰',
        evoGo: 'é€²åŒ–çš„æ°£æ¯æ»¿äº†ï¼å‰å¾€ä¸‹ä¸€æ­¥ã€‚'
      },
      'ko': {
        feed: 'ğŸ¬ ë§ˆì¹´ë¡± ì£¼ê¸°', rest: 'ğŸ’¤ ê´€ì°°í•˜ê¸°(ìë™)',
        lines: ['â€¦ë‘ë¦¬ë²ˆ','ë‘¥ì‹¤ë‘¥ì‹¤â€¦','(ë‹¹ì‹ ì„ ì˜¬ë ¤ë‹¤ë³¸ë‹¤)','ë°˜ì§â˜…','ì¡¸â€¦'],
        react: ['ì™€ì•„!','ëƒ ëƒ ','í´ì§!','ì›ƒìŒ'],
        foot: 'ëŒ€í™” ì…ë ¥ì€ ì—†ì–´ìš”. ê´€ì°°í•˜ê³  ê°€ë” ë§ˆì¹´ë¡±ì„ ì£¼ì„¸ìš”. ì¼ì • XPê°€ ë˜ë©´ ì§„í™”í•©ë‹ˆë‹¤.',
        evoReady: 'ê³§ ë³€í™”ê°€ ì˜¬ ë“¯â€¦ (í•˜ë‚˜ ë”?)',
        evoGo: 'ì§„í™” ê¸°ìš´ì´ ê°€ë“! ë‹¤ìŒìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.'
      }
    };

    function r(a){return a[Math.floor(Math.random()*a.length)]}

    const chips=[...document.querySelectorAll('.chip')];
    const who=document.getElementById('who');
    const img=document.getElementById('charImg');
    const logEl=document.getElementById('log');
    const feedBtn=document.getElementById('feedBtn');
    const restBtn=document.getElementById('restBtn');
    const xpFill=document.getElementById('xpFill');
    const foot=document.getElementById('footNote');

    // Init language
    function detectLang(){
      const saved=localStorage.getItem(KEY.lang); if(saved && I18N[saved]) return saved;
      const nav=(navigator.language||'ja').toLowerCase();
      if(nav.startsWith('ja')) return 'ja';
      if(nav.startsWith('en')) return 'en';
      if(nav.startsWith('zh')){ if(nav.includes('tw')||nav.includes('hk')||nav.includes('mo')) return 'zh-TW'; return 'zh-CN'; }
      if(nav.startsWith('ko')) return 'ko';
      return 'ja';
    }

    let lang = detectLang();

    function applyLang(newLang){
      lang=newLang; localStorage.setItem(KEY.lang, lang);
      feedBtn.textContent = I18N[lang].feed; restBtn.textContent = I18N[lang].rest; foot.textContent = I18N[lang].foot;
      chips.forEach(ch=>ch.setAttribute('aria-pressed',String(ch.dataset.lang===lang)));
    }

    chips.forEach(ch=>ch.addEventListener('click',()=>applyLang(ch.dataset.lang)));
    applyLang(lang);

    // Names & header
    const you = localStorage.getItem(KEY.you)||'â€”';
    const buddy = localStorage.getItem(KEY.buddy)||'â€”';
    who.textContent = `ã‚ãªãŸï¼š${you} ï¼ ã‚­ãƒ£ãƒ©ï¼š${buddy}`;

    // Stage & assets
    localStorage.setItem(KEY.stage,'tane');
    const color = localStorage.getItem(KEY.color)||'pink';
    const imgPath = `tane_${color}.png`;
    img.src = imgPath;

    // XP & log
    let xp = parseInt(localStorage.getItem(KEY.xp)||'0',10);
    const XP_TO_EVOLVE = 3; // â˜… è¦³å¯Ÿãƒ¢ãƒ¼ãƒ‰ç”¨ã®é–¾å€¤ï¼ˆå¿…è¦ãªã‚‰èª¿æ•´ï¼‰

    function saveXP(){ localStorage.setItem(KEY.xp, String(xp)); }

    function setFill(){
      const pct = Math.max(0, Math.min(100, Math.round((xp/XP_TO_EVOLVE)*100)));
      xpFill.style.width = pct + '%';
    }
    setFill();

    function pushLine(text){
      const b = document.createElement('div'); b.className='bubble'; b.textContent=text; logEl.appendChild(b); logEl.scrollTop=logEl.scrollHeight;
      // è¿½è¨˜ã‚’log(JSON)ã«ã‚‚ä¿å­˜ï¼ˆè»½é‡ï¼‰
      try{
        const arr = JSON.parse(localStorage.getItem(KEY.log)||'[]');
        arr.push({t:Date.now(), s:'sys', msg:text});
        localStorage.setItem(KEY.log, JSON.stringify(arr).slice(-5000));
      }catch(e){}
    }

    // Idle auto lines
    let autoTimer=null;
    function startAuto(){
      if(autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(()=>{ pushLine(r(I18N[lang].lines)); }, 4500);
    }
    startAuto();

    // Feed action
    function feed(){
      pushLine(r(I18N[lang].react));
      xp++; setFill(); saveXP();
      if(xp===XP_TO_EVOLVE-1){ pushLine(I18N[lang].evoReady); }
      if(xp>=XP_TO_EVOLVE){
        pushLine(I18N[lang].evoGo);
        // æ¬¡ã®ç”»é¢ï¼ˆ2å›ç›®ã®ãƒã‚«ãƒ­ãƒ³é¸æŠ â†’ é€²åŒ–æ¼”å‡ºï¼‰ã¸
        setTimeout(()=>{ location.href = 'macaron_select.html'; }, 1200);
      }
    }

    feedBtn.addEventListener('click', feed);

    // Restarts auto-idle narrative
    restBtn.addEventListener('click', ()=>{ startAuto(); });

    // First line greet
    pushLine(r(I18N[lang].lines));
  </script>
</body>
</html>
