<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>キャラと会話する | WhoAI2</title>
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
    background:#000; /* 画像はJSで存在チェック後に適用 */
    display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px
  }
  h1{margin:8px 0 0;font-size:clamp(22px,5vw,36px)}
  #stageTag{opacity:.85;font-size:14px}
  #characterImg{width:min(60vw,340px);height:auto}
  .chat{
    width:min(92vw,980px);
    display:flex;flex-direction:column;gap:10px;
    background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:12px
  }
  .log{max-height:50vh;overflow:auto;display:flex;flex-direction:column;gap:8px}
  .bubble{max-width:80%;padding:10px 12px;border-radius:14px;line-height:1.7}
  .me   {align-self:flex-end;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2)}
  .bot  {align-self:flex-start;background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14)}
  .composer{display:flex;gap:8px}
  .composer input{
    flex:1;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.25);
    background:rgba(0,0,0,.35);color:#fff
  }
  .composer button{
    padding:10px 14px;border-radius:12px;border:0;cursor:pointer;
    background:#f7b0bf;color:#222;font-weight:800
  }
  .nav{margin-top:8px}.nav a{color:#fff;text-decoration:underline}
  small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;opacity:.8}
</style>
</head>
<body>
  <h1>キャラと会話する</h1>
  <div id="stageTag"></div>
  <img id="characterImg" alt="キャラクターが読み込み中…" />

  <section class="chat" aria-label="chat">
    <div class="log" id="log"></div>
    <form class="composer" id="composer">
      <input id="msg" type="text" autocomplete="off" placeholder="メッセージを入力（Enterで送信）" />
      <button id="sendBtn" type="submit">送信</button>
    </form>
    <div class="nav">
      <a href="macaron_select.html">2回目のマカロンを選ぶ</a>
      &nbsp;|&nbsp;<a href="index.html">最初に戻る</a>
      &nbsp;|&nbsp;<button type="button" id="resetBtn">リセット</button>
      <div><small class="mono">エンドポイント: <span id="ep"></span></small></div>
    </div>
  </section>

<script>
/* ========= 設定 =========
 * GitHub Pages から Vercel の Serverless Function へPOSTします。
 * ここをあなたのデプロイURLに変更してください。
 */
const TALK_ENDPOINT = "https://YOUR-APP-NAME.vercel.app/api/talk"; // ←★要変更★

document.getElementById("ep").textContent = TALK_ENDPOINT;

/* ========= 背景：存在すれば適用 ========= */
(function(){
  const bg = "space_background.png";
  const t = new Image();
  t.onload  = ()=>{ Object.assign(document.body.style,{
    backgroundImage:`url('${bg}')`,backgroundSize:"cover",
    backgroundPosition:"center",backgroundAttachment:"fixed"
  }); };
  t.onerror = ()=>{};
  t.src = bg;
})();

/* ========= ステート（色/段階）と画像フォールバック ========= */
const stage = localStorage.getItem("whoai_stage") || "tane";
const color = localStorage.getItem("whoai_color") || "pink";
document.getElementById("stageTag").textContent =
  (stage==="evolved") ? `
