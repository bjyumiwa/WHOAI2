<!-- FILE: /whoai_talk.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¼šè©± | WhoAIï¼ˆé€²åŒ–å¾Œï¼‰</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
      /* åŒéšå±¤å‚ç…§ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä»•æ§˜ï¼‰ */
      background:#000 url("space_background.png") center/cover fixed no-repeat;
      display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    .chip{background:rgba(0,0,0,.35);backdrop-filter:blur(3px);padding:6px 10px;border-radius:999px;font-size:12px}
    .title{font-size:28px;font-weight:800;letter-spacing:.06em;margin-top:2px}
    .subtitle{font-size:12px;opacity:.9;margin-top:-4px}
    .hero{display:flex;flex-direction:column;align-items:center;gap:6px;margin:4px 0}
    .hero img{width:180px;max-width:52vw;height:auto;filter:drop-shadow(0 8px 22px rgba(0,0,0,.5))}
    .hero small{opacity:.85}
    .card{width:min(920px,96vw);background:rgba(0,0,0,.35);backdrop-filter:blur(4px);border-radius:18px;padding:12px}
    #chatArea{max-height:38vh;overflow-y:auto;scroll-behavior:smooth;background:rgba(255,255,255,.10);border-radius:14px;padding:12px}
    .msg{display:flex;margin:10px 0}
    .msg.user{justify-content:flex-end}
    .msg.assistant{justify-content:flex-start}
    .bubble{max-width:82%;padding:12px 14px;border-radius:16px;line-height:1.7;white-space:pre-wrap;word-wrap:break-word;background:rgba(255,255,255,.12)}
    .msg.user .bubble{background:rgba(61,180,255,.20)}
    .msg.assistant .bubble{background:rgba(255,97,200,.20)}
    .role{display:block;font-size:12px;opacity:.8;margin-bottom:4px}
    .controls{display:flex;gap:6px;align-items:center;margin-top:8px;flex-wrap:wrap}
    input[type=text]{flex:1;min-width:200px;padding:12px 14px;border:none;border-radius:12px;background:rgba(255,255,255,.92);color:#111;outline:none}
    button,select,label.switch{padding:10px 12px;border:none;border-radius:12px;background:#ffd1ec;color:#111;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    select{padding:10px;font-weight:600}
    .switch{display:flex;gap:6px;align-items:center;background:rgba(255,255,255,.2)}
    .switch input{accent-color:#6f4cff}
    .hint{font-size:12px;opacity:.85;margin:4px 2px 0}
    /* å³ä¸Šãƒˆãƒƒãƒ—ãƒãƒ¼ */
    .topbar{position:fixed;top:10px;right:10px;display:flex;gap:8px;z-index:10}
    .ghostbtn{
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;border-radius:12px;padding:8px 12px;cursor:pointer
    }
    .ghostbtn:active{transform:translateY(1px)}
  </style>
</head>
<body>
  <!-- å³ä¸ŠãƒŠãƒ“ï¼šå®ç®± / ãƒ›ãƒ¼ãƒ  -->
  <div class="topbar">
    <button class="ghostbtn" onclick="location.href='chest.html'">ğŸ å®ç®±</button>
    <button class="ghostbtn" onclick="location.href='index.html'">ğŸ  ãƒ›ãƒ¼ãƒ </button>
  </div>

  <div class="chips">
    <span class="chip"><span id="chipColor">-</span> | evolved</span>
    <span class="chip">turn: <span id="turnChip">0</span>/10</span>
  </div>
  <div class="title">ä¼šè©±</div>
  <div class="subtitle">é€²åŒ–ã‚­ãƒ£ãƒ©ã§10å›ä¼šè©±ã™ã‚‹ã¨ã€å¾©æ´»ã®å„€å¼ or ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¸</div>

  <div class="hero">
    <img id="charImg" alt="é€²åŒ–å¾Œã‚­ãƒ£ãƒ©">
    <small id="charLabel">ã‚­ãƒ£ãƒ©</small>
  </div>

  <div class="card">
    <div id="chatArea"></div>
    <div class="controls">
      <input id="userInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ï¼ˆéŸ³å£°ã§ã‚‚OKï¼‰">
      <button id="btnSend">é€ä¿¡</button>
      <button id="btnMic">ğŸ™ï¸</button>
      <button id="btnTTS">ğŸ”Š</button>
      <select id="langSelect">
        <option value="ja-JP">æ—¥æœ¬èª</option>
        <option value="en-US">English</option>
        <option value="zh-CN">ä¸­æ–‡(ç®€ä½“)</option>
        <option value="zh-TW">ä¸­æ–‡(ç¹é«”)</option>
        <option value="ko-KR">í•œêµ­ì–´</option>
      </select>
      <label class="switch"><input type="checkbox" id="autoSend" checked> è‡ªå‹•é€ä¿¡</label>
    </div>
    <div class="hint">â€» ä¼šè©±ã¯ localStorage ã«ä¿å­˜ã€‚10ã‚¿ãƒ¼ãƒ³åˆ°é”ã§ã€Œå¾©æ´»ã®å„€å¼ã€ã¾ãŸã¯ã€Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã€ã¸ã€‚</div>
  </div>

<script>
  /* === è¨­å®š === */
  const TALK_ENDPOINT="https://macaron-one.vercel.app/api/talk";
  const WINDOW_N=12, TURN_LIMIT=10;

  /* === å¾©æ´»ãƒ¢ãƒ¼ãƒ‰å‡¦ç†ï¼ˆæ—¢å­˜ä»•æ§˜è¸è¥²ï¼‰ === */
  const keepMode=localStorage.getItem("whoai_keep");
  if(keepMode==="appearance"){
    localStorage.removeItem("whoai_keep");
    localStorage.removeItem(`whoai:evolved:${localStorage.getItem('whoai_userId')}:evolved_conversation:chatLog`);
    localStorage.removeItem(`whoai:evolved:${localStorage.getItem('whoai_userId')}:evolved_conversation:turn`);
  }else if(keepMode==="memory"){
    localStorage.removeItem("whoai_keep");
  }

  /* === åŒéšå±¤ã®é€²åŒ–å¾Œç”»åƒ === */
  const EVOLVED_SRC={
    pink:   {closed:'pink_closed.png',   open:'pink_open.png'},
    blue:   {closed:'blue_closed.png',   open:'blue_open.png'},
    green:  {closed:'green_closed.png',  open:'green_open.png'},
    purple: {closed:'purple_closed.png', open:'purple_open.png'}
  };

  const color=(localStorage.getItem('macaronColor')||'pink').toLowerCase();
  document.getElementById('chipColor').textContent=color;

  /* === ID / ãƒ­ã‚° === */
  const getOrCreate=(k)=>{let v=localStorage.getItem(k);if(v)return v;v=crypto.randomUUID();localStorage.setItem(k,v);return v;};
  const userId=getOrCreate('whoai_userId');
  const convoId='evolved_conversation';
  const key=(s)=>`whoai:evolved:${userId}:${convoId}:${s}`;
  const readLog=()=>JSON.parse(localStorage.getItem(key('chatLog'))||'[]');
  const writeLog=(log)=>localStorage.setItem(key('chatLog'),JSON.stringify(log));
  const readTurn=()=>parseInt(localStorage.getItem(key('turn'))||'0',10);
  const writeTurn=(n)=>localStorage.setItem(key('turn'),String(n));

  /* === ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤º === */
  const charImg=document.getElementById('charImg');
  const charName=localStorage.getItem("whoai_name")||"ã‚­ãƒ£ãƒ©";
  document.getElementById("charLabel").textContent=charName;

  function loadWithFallback(kind){
    const c=EVOLVED_SRC[color] || EVOLVED_SRC.pink;
    const primary=c[kind], fallback=EVOLVED_SRC.pink[kind];
    // å…ˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º â†’ æˆåŠŸã—ãŸã‚‰å·®ã—æ›¿ãˆ
    charImg.src = fallback;
    const t=new Image();
    t.onload=()=>{charImg.src=primary;};
    t.src=primary; // å¤±æ•—æ™‚ã¯fallbackã®ã¾ã¾
  }
  const setClosed=()=>loadWithFallback('closed');
  const setOpen=()=>loadWithFallback('open');
  setClosed();

  /* === ä¼šè©± UI === */
  const chatArea=document.getElementById('chatArea');
  const playerName=localStorage.getItem('whoai_player_name')||'ã‚ãªãŸ';
  const assistantName=charName;
  function render(){
    const log=readLog();chatArea.innerHTML='';
    for(const m of log){
      const row=document.createElement('div');row.className=`msg ${m.role}`;
      const b=document.createElement('div');b.className='bubble';
      const r=document.createElement('span');r.className='role';
      r.textContent=(m.role==='user'?playerName:assistantName)+'ï¼š';
      b.appendChild(r);b.appendChild(document.createTextNode(m.content||''));row.appendChild(b);
      chatArea.appendChild(row);
    }
    chatArea.scrollTop=chatArea.scrollHeight;
    document.getElementById('turnChip').textContent=String(readTurn());
  }
  render();

  /* === ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…±æœ‰ï¼ˆå®ç®±ã¨åŒã˜ã‚­ãƒ¼ï¼‰ === */
  const STATE_KEY="whoai_state_v1";
  const defaultState={hunger:50, energy:50, mood:50, bond:10};
  const clamp=(v,min=0,max=100)=>Math.max(min,Math.min(max,v));
  const loadState=()=>{try{const raw=localStorage.getItem(STATE_KEY);return raw?{...defaultState,...JSON.parse(raw)}:{...defaultState};}catch{return {...defaultState}}};
  const saveState=(st)=>localStorage.setItem(STATE_KEY, JSON.stringify(st));

  /* === é€ä¿¡å‡¦ç† === */
  async function talk(text){
    if(!text.trim())return;
    if(readTurn()>=TURN_LIMIT){
      const phase = localStorage.getItem("whoai_phase") || "pre";
      if(phase === "pre"){ setTimeout(()=>location.href='rebirth.html',900); }
      else { setTimeout(()=>location.href='identity_check.html',900); }
      return;
    }

    let log=readLog();log.push({role:'user',content:text,ts:Date.now()});writeLog(log);render();
    setOpen();

    const history=log.slice(-WINDOW_N).map(({role,content})=>({role,content}));
    const messages=[
      {role:'system',content:'You are a kind partner AI. Reply briefly in the userâ€™s language.'},
      ...history,
      {role:'user',content:text}
    ];
    let reply='â€¦';
    try{
      const res=await fetch(TALK_ENDPOINT,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({model:'gpt-4o-mini',temperature:0.7,max_tokens:220,messages})
      });
      const data=await res.json().catch(()=>({}));reply=data.reply||reply;
    }catch(e){reply='ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰';console.error(e);}

    log=readLog();log.push({role:'assistant',content:reply,ts:Date.now()});writeLog(log);render();
    setTimeout(setClosed,450);
    speakCute(reply,document.getElementById('langSelect').value);

    // ä¼šè©±ã§å°‘ã—ã ã‘ â€œæ„›ç€ / ã”ãã’ã‚“â€ ã‚’ä¸Šã’ã‚‹ï¼ˆå®ç®±ã¨åŒã˜ã‚¹ãƒ†ãƒ¼ãƒˆã«åŠ ç‚¹ï¼‰
    const st = loadState();
    st.bond = clamp(st.bond + 1);
    st.mood = clamp(st.mood + 1);
    saveState(st);

    const t=readTurn()+1;writeTurn(t);
    document.getElementById('turnChip').textContent=String(t);
  }

  /* === å…¥åŠ›UI === */
  const userInput=document.getElementById('userInput');
  document.getElementById('btnSend').onclick=()=>{
    const v=userInput.value.trim();if(!v)return;userInput.value='';talk(v);
  };
  userInput.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'&&!e.isComposing){e.preventDefault();document.getElementById('btnSend').click();}
  });

  /* === éŸ³å£°èªè­˜ === */
  let recognition=null,recognizing=false;
  const btnMic=document.getElementById('btnMic');
  const autoSend=document.getElementById('autoSend');
  function ensureRec(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR)return null;
    if(recognition)return recognition;
    recognition=new SR();recognition.interimResults=false;recognition.continuous=false;recognition.maxAlternatives=1;
    recognition.onresult=(e)=>{
      const t=e.results[0][0].transcript||'';
      if(autoSend.checked){talk(t);}else{userInput.value=t;userInput.focus();}
    };
    recognition.onend=()=>{recognizing=false;btnMic.textContent='ğŸ™ï¸';};
    recognition.onerror=()=>{recognizing=false;btnMic.textContent='ğŸ™ï¸';};
    return recognition;
  }
  btnMic.onclick=()=>{
    const rec=ensureRec();if(!rec){alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«æœªå¯¾å¿œã§ã™');return;}
    rec.lang=document.getElementById('langSelect').value||(navigator.language||'ja-JP');
    if(recognizing){rec.stop();return;}
    recognizing=true;btnMic.textContent='ğŸ›‘';
    try{rec.start();}catch{}
  };

  /* === èª­ã¿ä¸Šã’ === */
  document.getElementById('btnTTS').onclick=()=>{
    const last=[...readLog()].reverse().find(m=>m.role==='assistant');
    if(last)speakCute(last.content,document.getElementById('langSelect').value);
  };
  function speakCute(text,lang){
    if(!('speechSynthesis' in window))return;
    const u=new SpeechSynthesisUtterance(text);
    u.lang=lang;u.rate=1.05;u.pitch=1.6;u.volume=1;
    const voices=speechSynthesis.getVoices();
    const cute=voices.find(v=>v.lang===lang && /(girl|child|female|Kyoko|Google æ—¥æœ¬èª)/i.test(v.name))
               || voices.find(v=>v.lang.startsWith(lang.split('-')[0]));
    if(cute)u.voice=cute;
    try{window.speechSynthesis.cancel();}catch{}
    window.speechSynthesis.speak(u);
  }
  if('speechSynthesis' in window){speechSynthesis.getVoices();speechSynthesis.onvoiceschanged=()=>{};}
</script>
</body>
</html>
