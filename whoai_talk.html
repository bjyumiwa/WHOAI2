<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>キャラと会話する | WhoAI2</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
      background:#000; /* ← まずは黒。画像が見つかったらJSで上書き */
      display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px
    }
    h1{margin:8px 0 0;font-size:clamp(22px,5vw,36px)}
    #stageTag{opacity:.85;font-size:14px}
    #characterImg{width:min(60vw,340px);height:auto}
    .box{width:min(92vw,900px);background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:12px}
    .nav{margin-top:8px}.nav a{color:#fff;text-decoration:underline}
    .debug{font-size:12px;opacity:.8}
    .btn{padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.4);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <h1>キャラと会話する</h1>
  <div id="stageTag"></div>
  <img id="characterImg" alt="キャラクターが読み込み中…" />

  <div class="box">
    （ここに既存の会話UIを入れてください）
    <div class="nav" style="margin-top:8px">
      <a href="macaron_select.html">2回目のマカロンを選ぶ</a>
      &nbsp;|&nbsp;
      <button class="btn" id="resetBtn" type="button">リセット</button>
    </div>
    <div class="debug" id="debug"></div>
  </div>

  <script>
    // --- 背景画像：存在すれば適用 ---
    (function setBg(){
      const bg = "space_background.png"; // /WHOAI2/ 直下
      const t = new Image();
      t.onload  = ()=>{ document.body.style.backgroundImage = `url('${bg}')`;
                        document.body.style.backgroundSize = "cover";
                        document.body.style.backgroundPosition = "center";
                        document.body.style.backgroundAttachment = "fixed"; };
      t.onerror = ()=>{ /* 見つからなければ黒のまま */ };
      t.src = bg;
    })();

    // --- ステート読み込み（未設定でも動く） ---
    const stage = localStorage.getItem("whoai_stage") || "tane";  // "tane" | "evolved"
    const color = localStorage.getItem("whoai_color") || "pink";  // "pink" など

    // --- キャラ画像の候補を段階的に試行（存在チェック付き） ---
    const candidates = (stage === "evolved")
      ? [`${color}_open.png`, `${color}_closed.png`, `pink_open.png`]
      : [`tane_${color}.png`, `tane_pink.png`, `pink_closed.png`];

    const imgEl = document.getElementById("characterImg");
    const tagEl = document.getElementById("stageTag");
    const debugEl = document.getElementById("debug");

    tagEl.textContent = (stage === "evolved")
      ? `進化キャラ（色：${color}）`
      : `タネキャラ（色：${color}）`;

    function tryLoad(i){
      if(i >= candidates.length){
        imgEl.alt = "画像が見つかりません（ファイル名を確認してください）";
        debugEl.textContent = "試した候補: " + candidates.join(", ");
        return;
      }
      const path = candidates[i];
      const tester = new Image();
      tester.onload  = ()=>{ imgEl.src = path; debugEl.textContent = "使用画像: " + path; };
      tester.onerror = ()=>{ tryLoad(i+1); };
      tester.src = path;
    }
    tryLoad(0);

    // --- 開発用リセット（状態が怪しい時に） ---
    document.getElementById("resetBtn").onclick = ()=>{
      localStorage.removeItem("whoai_history");
      localStorage.removeItem("whoai_color");
      localStorage.removeItem("whoai_stage");
      location.href = "macaron.html";
    };
  </script>
</body>
</html>
