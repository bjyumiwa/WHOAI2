<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WhoAI ‰ºöË©±„É¢„Éº„Éâ</title>
<meta name="color-scheme" content="dark light" />
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
    background:#000 url("space_background.png") center/cover fixed no-repeat;
    display:flex;align-items:center;justify-content:center;padding:14px;
  }
  .wrap{width:min(960px,94vw);display:grid;grid-template-rows:auto 1fr auto;gap:12px;
        background:rgba(0,0,0,.35);backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px);
        border:1px solid rgba(255,255,255,.18);border-radius:20px;padding:16px;box-shadow:0 10px 26px rgba(0,0,0,.3)}
  .header{display:flex;align-items:center;gap:12px}
  .char{width:84px;height:84px;object-fit:contain;filter:drop-shadow(0 8px 18px rgba(0,0,0,.45))}
  .title{font-weight:800}
  .log{overflow:auto;max-height:58vh;display:flex;flex-direction:column;gap:10px}
  .msg{max-width:78%;padding:10px 12px;border-radius:14px;line-height:1.5}
  .me{align-self:flex-end;background:#2b82ff}
  .bot{align-self:flex-start;background:#27ae60}
  .input{display:flex;gap:8px}
  .input input{flex:1;padding:10px 12px;border:none;border-radius:10px;font-size:16px}
  .input button{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:800}
  .ghost{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.28)}
</style>
</head>
<body>
  <main class="wrap">
    <div class="header">
      <img id="charImg" class="char" alt="„Ç≠„É£„É©">
      <div class="title">‰ºöË©±„É¢„Éº„Éâ</div>
      <div style="margin-left:auto;opacity:.85" id="modeHint">Ôºà„Åì„Åì„ÅØ‰ºöË©±„Éö„Éº„Ç∏Ôºâ</div>
    </div>

    <div id="log" class="log"></div>

    <div class="input">
      <input id="txt" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ‚Ä¶" />
      <button id="send" class="ghost">ÈÄÅ‰ø°</button>
      <button id="toObserve" class="ghost" title="Ë¶≥ÂØü„Å∏ÁßªÂãï">üëÄ Ë¶≥ÂØü</button>
    </div>
  </main>

<script>
(() => {
  const params=new URLSearchParams(location.search);
  const form=params.get('form');            // "tane" „Å™„Çâ„Çø„ÉçÂõ∫ÂÆö
  const color=(localStorage.getItem('whoai_color')||localStorage.getItem('macaronColor')||'pink').toLowerCase();
  const name =(localStorage.getItem('whoai_name')||'„Å™„Å™„Åó');
  const logEl=document.getElementById('log');
  const imgEl=document.getElementById('charImg');

  // === ÁîªÂÉè ===
  function setImg(url){ imgEl.src=url; }
  if(form==='tane'){
    // „Çø„ÉçÂõ∫ÂÆö
    const s1=`tane_${color}.png`, s2='tane.png';
    const t=new Image(); t.onload=()=>setImg(s1); t.onerror=()=>setImg(s2); t.src=s1;
  }else{
    // ÈÄ≤ÂåñÂè£„Éë„ÇØÔºà„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
    const open=`${color}_open.png`, closed=`${color}_closed.png`;
    let hasO=false,hasC=false,isOpen=false;
    const p=(u,cb)=>{const i=new Image();i.onload=()=>cb(true);i.onerror=()=>cb(false);i.src=u};
    p(open, ok=>hasO=ok); p(closed, ok=>hasC=ok);
    setImg(hasC?closed:(hasO?open:`tane_${color}.png`));
    setInterval(()=>{isOpen=!isOpen; setImg(isOpen?(hasO?open:closed):(hasC?closed:open));},1000);
  }

  // === „É≠„Ç∞ ===
  function push(text,who){
    const d=document.createElement('div'); d.className=`msg ${who}`; d.textContent=text;
    logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight;
  }
  push(`„Åì„Çì„Å´„Å°„ÅØ„ÄÅ${name}„ÄÇË©±„Åó„Åã„Åë„Å¶„Å≠ÔºÅ`,'bot');

  // === ÈÄÅ‰ø°Ôºà„ÉÄ„Éü„ÉºÂøúÁ≠îÔºâ===
  document.getElementById('send').onclick=()=>{
    const v=document.getElementById('txt').value.trim(); if(!v) return;
    document.getElementById('txt').value='';
    push(v,'me');
    setTimeout(()=>push('„ÅÜ„Çì„ÅÜ„Çì„ÄÅ„Åù„Çå„Åß„Åù„Çå„ÅßÔºü','bot'),500);
  };

  // Ë¶≥ÂØü„Å∏ÔºàÂøÖ„ÅöË¶≥ÂØü„Éö„Éº„Ç∏„Å∏ÈÅ∑ÁßªÔºâ
  document.getElementById('toObserve').onclick=()=>location.assign('/WHOAI2/whoai_talk_evolved.html?form=tane&from=talk');
})();
</script>
</body>
</html>
