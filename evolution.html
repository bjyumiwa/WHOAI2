<!-- FILE: /WHOAI2/evolution.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>進化演出 | WhoAI</title>
<meta name="color-scheme" content="dark light" />
<style>
  /* 背景は body だけに一枚 */
  html,body{height:100%;margin:0;overflow:hidden}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
    background:#000 url("space_background.png") center/cover fixed no-repeat;
    display:flex;align-items:center;justify-content:center;padding:12px;
  }

  /* ガラス風ステージ（背景は持たせない） */
  .stage{
    position:relative; width:min(92vw,860px); aspect-ratio:1/0.75;
    border-radius:24px; overflow:hidden;
    background:rgba(0,0,0,.22);
    backdrop-filter:blur(3px); -webkit-backdrop-filter:blur(3px);
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 10px 28px rgba(0,0,0,.25), inset 0 10px 28px rgba(0,0,0,.25);
  }

  /* 進化演出 */
  .beam{
    position:absolute; inset:0; pointer-events:none; opacity:0;
    background:radial-gradient(60% 40% at 50% 30%, rgba(255,255,255,.45), rgba(255,255,255,0)),
               radial-gradient(40% 25% at 50% 60%, rgba(125,200,255,.35), rgba(0,0,0,0));
    mix-blend-mode:screen; filter:blur(2px);
    animation: beam 2.6s ease-out .2s both;
  }
  @keyframes beam{
    0%{opacity:0; transform:scale(1.05)}
    20%{opacity:.9}
    70%{opacity:.75}
    100%{opacity:0; transform:scale(1)}
  }

  .charWrap{
    position:absolute; left:50%; top:58%; transform:translate(-50%,-50%) scale(.7);
    filter:drop-shadow(0 12px 26px rgba(0,0,0,.5));
    animation: pop 1200ms cubic-bezier(.2,.9,.2,1.05) .4s both, breathe 6s ease-in-out 1.8s infinite;
  }
  @keyframes pop{
    0%{ transform:translate(-50%,-50%) scale(.1); opacity:0 }
    60%{ transform:translate(-50%,-50%) scale(1.1); opacity:1 }
    100%{ transform:translate(-50%,-50%) scale(1) }
  }
  @keyframes breathe{
    0%,100%{ transform:translate(-50%,-50%) scale(1) }
    50%{ transform:translate(-50%,-50%) scale(1.04) }
  }
  .charImg{ width:min(28vw,260px); max-width:42vmin; object-fit:contain }

  /* CTA（演出後に出現） */
  .cta{
    position:absolute; left:0; right:0; bottom:16px;
    display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    opacity:0; transform:translateY(16px);
    transition:opacity .5s ease, transform .5s ease;
  }
  .cta.show{ opacity:1; transform:none }

  .btn{
    appearance:none; border:none; border-radius:14px; cursor:pointer;
    padding:10px 14px; font-weight:800; font-size:clamp(14px,2.5vw,16px);
    box-shadow:0 6px 18px rgba(0,0,0,.28);
  }
  .btn-primary{ background:#fff; color:#111 }
  .btn-ghost{ background:rgba(255,255,255,.18); color:#fff; border:1px solid rgba(255,255,255,.28) }

  /* 上部の案内 */
  .head{
    position:absolute; left:0; right:0; top:10px; text-align:center;
    font-weight:700; text-shadow:0 2px 6px rgba(0,0,0,.35);
  }
</style>
</head>
<body>
  <main class="stage">
    <div class="head">進化したよ！</div>
    <div class="beam" aria-hidden="true"></div>
    <div class="charWrap"><img id="charImg" class="charImg" alt="evolved character" /></div>

    <!-- 進化後の選択肢：観察 or 会話 -->
    <div id="cta" class="cta" aria-live="polite" aria-label="次の行き先を選択">
      <button id="btnObserve" class="btn btn-ghost" type="button">👀 観察をつづける</button>
      <button id="btnTalk" class="btn btn-primary" type="button">💬 会話する（WhoAI）</button>
    </div>
  </main>

<script>
  // === 設定 ===
  const KEY={color:'whoai_color', xp:'whoai_xp'};
  const color = localStorage.getItem(KEY.color) || 'pink';

  // 画像フォールバック（存在する物を順に）
  function setWithFallback(imgEl, candidates){
    let i=0;
    function next(){
      if(i>=candidates.length){ imgEl.style.display='none'; return; }
      const url=candidates[i++]; imgEl.onerror=next; imgEl.src=url;
    }
    next();
  }
  const candidates = [
    `/WHOAI2/evolved_${color}.png`,
    `/WHOAI2/evolved_${color}_open.png`,
    `/WHOAI2/public/assets/stage2/evolved_${color}.png`,
    `/WHOAI2/tane_${color}.png` // 最終手段
  ];
  setWithFallback(document.getElementById('charImg'), candidates);

  // === 演出終了後にボタンを表示 ===
  const cta = document.getElementById('cta');
  const SHOW_DELAY_MS = 2600;  // beam/popupが終わる時間に合わせる
  setTimeout(()=>cta.classList.add('show'), SHOW_DELAY_MS);

  // === 行き先 ===
  // 観察モード（会話なし）：進化キャラを眺める画面
  const OBSERVE_URL = 'whoai_talk_evolved.html';
  // 会話したくなったら：WhoAIの会話モードへ（必要なら変更OK）
  const TALK_URL    = 'whoai_talk.html';

  document.getElementById('btnObserve').addEventListener('click', ()=>location.href=OBSERVE_URL);
  document.getElementById('btnTalk').addEventListener('click',     ()=>location.href=TALK_URL);

  // キーボードショートカット（O=観察, T=会話）
  addEventListener('keydown', (e)=>{
    const k=e.key.toLowerCase();
    if(k==='o') location.href=OBSERVE_URL;
    if(k==='t') location.href=TALK_URL;
  });

  // 背景フォールバック（無い場合にだけグラデ）
  (function bgFallback(){
    const img=new Image(); img.onload=()=>{}; img.onerror=()=>{
      document.body.style.background='radial-gradient(1200px 600px at 65% 10%, rgba(255,255,255,.18), rgba(0,0,0,0)) #000';
    };
    img.src='space_background.png';
  })();
</script>
</body>
</html>
