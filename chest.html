<!-- FILE: /observe.htmlï¼ˆè¦³å¯Ÿãƒ»å…¨ç”»é¢ï¼‰ -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhoAI | è¦³å¯Ÿï¼ˆå…¨ç”»é¢ï¼‰</title>
<meta name="color-scheme" content="dark light" />
<style>
  html,body{height:100%;margin:0;overflow:hidden}
  body{
    position:relative;
    font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
    background:#000 url("space_background.png") center/cover fixed no-repeat;
  }
  .chips{position:fixed;left:50%;top:10px;transform:translateX(-50%);display:flex;gap:8px;flex-wrap:wrap;z-index:30}
  .chip{background:rgba(0,0,0,.35);backdrop-filter:blur(3px);border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;font-size:12px}
  .guide{position:fixed;left:12px;top:12px;z-index:30;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:10px;font-size:12px;opacity:.95}

  #charWrap{
    position:absolute; left:50%; top:60%; transform:translate(-50%,-50%); z-index:10;
    transition:left var(--dur,3s) ease-in-out, top var(--dur,3s) ease-in-out; will-change:left, top;
  }
  #char{
    width: clamp(90px, 22vw, 200px); height:auto; object-fit:contain;
    filter: drop-shadow(0 8px 22px rgba(0,0,0,.55)); animation:bob 7s ease-in-out infinite;
  }
  @keyframes bob{0%,100%{transform:translateY(-6px)}50%{transform:translateY(6px)}}
  .wiggle{animation:wiggle .55s ease}
  @keyframes wiggle{0%{transform:rotate(0) scale(1)}30%{transform:rotate(8deg) scale(1.03)}60%{transform:rotate(-6deg) scale(1.01)}100%{transform:rotate(0) scale(1)}}
  .hop{animation:hop .5s ease}
  @keyframes hop{0%{transform:translateY(0)}50%{transform:translateY(-14px)}100%{transform:translateY(0)}}
  .sway{animation:sway .8s ease}
  @keyframes sway{0%{transform:rotate(0)}25%{transform:rotate(6deg)}50%{transform:rotate(-6deg)}75%{transform:rotate(4deg)}100%{transform:rotate(0)}}

  /* æ¨ªæ›¸ãå›ºå®šã®åå‰ï¼ˆã‚¯ãƒªãƒƒã‚¯ç”¨ã¯1ã¤ã ã‘ï¼‰ */
  .nameWrap{position:absolute;opacity:0;transition:opacity .35s ease;pointer-events:none;z-index:20}
  .nameWrap.show{opacity:1;pointer-events:auto}
  .nameHit{position:relative;display:inline-block;padding:18px 26px;background:transparent;border:none;outline:none;box-shadow:none;-webkit-tap-highlight-color:transparent}
  #nameText{
    position:absolute;left:0;top:0;transform:translate(18px,8px);
    font-weight:900;font-size:clamp(18px,5vw,28px);text-shadow:0 4px 16px rgba(0,0,0,.45);
    user-select:none;pointer-events:none;
    writing-mode: horizontal-tb; text-orientation: mixed; white-space: nowrap; direction:ltr;
  }

  .cheer{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.25);
    padding:6px 10px;border-radius:12px;font-weight:700;opacity:0;z-index:15;
    transition:opacity .4s ease, transform 1.1s ease, left 1.1s ease, top 1.1s ease;
    box-shadow:0 6px 14px rgba(0,0,0,.25);font-size:clamp(12px,3.4vw,16px)
  }
  .cheer.show{opacity:1}

  .controls{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);display:flex;gap:10px;flex-wrap:wrap;z-index:30}
  .btn{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:800;background:#ffd1ec;color:#222}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-ghost{background:rgba(255,255,255,.14);color:#fff;border:1px solid rgba(255,255,255,.25)}
  .pop{animation:pop .18s ease}
  @keyframes pop{0%{transform:scale(1.02)}100%{transform:scale(1)}}

  /* ---- Care Dock & Modal ---- */
  .care-dock{
    position:fixed;left:50%;bottom:64px;transform:translateX(-50%);
    display:flex;gap:10px;z-index:28;flex-wrap:wrap;justify-content:center
  }
  .cbtn{
    background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.18);
    color:#fff;border-radius:14px;padding:10px 14px;cursor:pointer;font-weight:800
  }
  .cbtn:active{transform:translateY(1px)}
  .badge{
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.18);
    border-radius:10px;padding:6px 10px;font-size:12px
  }
  #careStats{position:fixed;left:10px;top:10px;display:flex;gap:6px;z-index:29;flex-wrap:wrap}

  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,.5);
    display:none;align-items:center;justify-content:center;z-index:40
  }
  .modal.open{display:flex}
  .modal .box{
    width:min(520px,92vw);
    background:rgba(0,0,0,.55);backdrop-filter:blur(6px);
    border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:16px
  }
</style>
</head>
<body>
  <div class="guide">åå‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ +1pt ï½œ 20ptã§ã€Œãƒã‚«ãƒ­ãƒ³ã‚’é¸ã¶ã€</div>
  <div class="chips">
    <span class="chip">è‰²: <span id="chipColor">-</span></span>
    <span class="chip">æ®µéš: evolved</span>
    <span class="chip">pts: <span id="pts">0</span> / 20</span>
  </div>

  <!-- å·¦ä¸Šï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç°¡æ˜“ãƒãƒƒã‚¸ -->
  <div id="careStats" aria-live="polite">
    <span class="badge">æº€è…¹:<span id="b_hunger">â€”</span></span>
    <span class="badge">å…ƒæ°—:<span id="b_energy">â€”</span></span>
    <span class="badge">ã”ãã’ã‚“:<span id="b_mood">â€”</span></span>
    <span class="badge">æ„›ç€:<span id="b_bond">â€”</span></span>
    <span class="badge">ãã‚Œã„:<span id="b_hygiene">â€”</span></span>
  </div>

  <!-- ã‚­ãƒ£ãƒ© -->
  <div id="charWrap"><img id="char" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼"></div>

  <!-- æµ®éŠã™ã‚‹åå‰ã‚¯ãƒªãƒƒã‚¯ -->
  <div id="nameWrap" class="nameWrap">
    <div id="nameHit" class="nameHit" role="button" aria-label="åå‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚¤ãƒ³ãƒˆ"></div>
    <div id="nameText">-</div>
  </div>

  <div id="cheer" class="cheer">ãŒã‚“ã°ã£ãŸã­ï¼</div>

  <!-- ã‚±ã‚¢ãƒ»ãƒ‰ãƒƒã‚¯ï¼ˆãŠä¸–è©±ç³»ï¼‰ -->
  <div class="care-dock">
    <button id="btnToilet" class="cbtn">ğŸ§» ãƒˆã‚¤ãƒ¬æƒé™¤</button>
    <button id="btnPlay" class="cbtn">ğŸ® ã‚ãã¶</button>
    <button class="cbtn" onclick="location.href='chest.html'">ğŸ å®ç®±</button>
  </div>

  <!-- ä¸‹éƒ¨ãƒŠãƒ“ -->
  <div class="controls">
    <button class="btn-ghost" onclick="location.href='whoai_talk.html'">ä¼šè©±ãƒ¢ãƒ¼ãƒ‰ã¸</button>
    <button id="btnMacaron" class="btn" disabled onclick="location.href='macaron_select.html'">ãƒã‚«ãƒ­ãƒ³ã‚’é¸ã¶</button>
    <button class="btn-ghost" onclick="resetPts()">ptsãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <!-- ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ï¼ˆ5ç§’ã‚¿ãƒƒãƒ—ï¼‰ -->
  <div id="playModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pmTitle">
    <div class="box">
      <h3 id="pmTitle" style="margin:0 0 6px">ğŸ® ã‚¿ãƒƒãƒ—ã‚²ãƒ¼ãƒ ï¼ˆ5ç§’ï¼‰</h3>
      <p style="margin:0 0 8px;opacity:.9">5ç§’é–“ã« <b>15å›</b> ä»¥ä¸Šã‚¿ãƒƒãƒ—ã§ããŸã‚‰æˆåŠŸï¼</p>
      <div style="display:flex;gap:8px;align-items:center;margin:10px 0">
        <button id="pmStart" class="cbtn">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <div>ã‚«ã‚¦ãƒ³ãƒˆ: <b id="pmCount">0</b> | æ®‹ã‚Š: <b id="pmLeft">5.0</b>s</div>
      </div>
      <button id="pmTap" class="cbtn" style="width:100%;height:56px">ã“ã“ã‚’é€£æ‰“ï¼</button>
      <div style="display:flex;justify-content:flex-end;margin-top:10px">
        <button id="pmClose" class="cbtn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

<script>
/* ===== ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®š ===== */
const K={name:"whoai_name",color:"macaronColor",color2:"whoai_color",pts:"whoai_points"};
const STATE_KEY="whoai_state_v1";
const defaultState = { hunger:50, energy:50, mood:50, bond:10, hygiene:100 };
const clamp=(v,min=0,max=100)=>Math.max(min,Math.min(max,v));

const getName =()=>localStorage.getItem(K.name)||"ã‚­ãƒ£ãƒ©";
const getColor=()=> (localStorage.getItem(K.color)||localStorage.getItem(K.color2)||"pink").toLowerCase();
const getPts  =()=> parseInt(localStorage.getItem(K.pts)||"0",10);
const setPts  =(n)=> localStorage.setItem(K.pts,String(n));

function getState(){
  try{ const raw=localStorage.getItem(STATE_KEY);
       return raw? {...defaultState, ...JSON.parse(raw)} : {...defaultState}; }
  catch{ return {...defaultState}; }
}
function setState(st){ localStorage.setItem(STATE_KEY, JSON.stringify(st)); }

/* ===== ç”»åƒãƒ­ãƒ¼ãƒ‰ ===== */
function loadCharImage(imgEl,color){
  const cand=[`${color}_closed.png`,`${color}_open.png`,`tane_${color}.png`,`tane.png`];
  (function tryNext(i){ if(i>=cand.length){imgEl.alt="ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";return;}
    const p=cand[i], t=new Image(); t.onload=()=>imgEl.src=p; t.onerror=()=>tryNext(i+1); t.src=p; })(0);
}

/* ===== ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ãƒ»å‹•ã ===== */
const rand=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;

function targetPosition(){
  const w=innerWidth, h=innerHeight, m=6;
  const wrap=document.getElementById('charWrap');
  const cw=wrap.offsetWidth||160, ch=wrap.offsetHeight||160;
  const topPad=50, bottomPad=90;
  return { x: rand(m, Math.max(m, w - cw - m)), y: rand(topPad, Math.max(topPad, h - ch - bottomPad)) };
}
function roamCharacter(){
  const wrap=document.getElementById('charWrap');
  wrap.style.setProperty('--dur',(rand(22,52)/10)+'s');
  const p=targetPosition(); wrap.style.left=p.x+'px'; wrap.style.top=p.y+'px';
}

/* ===== åå‰ã®ãƒãƒƒãƒ—é…ç½® ===== */
function placeNameAway(){
  const wrap=document.getElementById('nameWrap');
  const rect=document.getElementById('charWrap').getBoundingClientRect();
  const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
  const w=innerWidth, h=innerHeight;
  const x=(cx<w/2)? rand(w*0.60,w*0.90) : rand(w*0.10,w*0.40);
  const y=(cy<h/2)? rand(h*0.60,h*0.85) : rand(h*0.12,h*0.40);
  wrap.style.left=x+'px'; wrap.style.top=y+'px';
}
function cycleName(){
  const wrap=document.getElementById('nameWrap');
  wrap.classList.remove('show');
  setTimeout(()=>{ placeNameAway(); wrap.classList.add('show'); setTimeout(()=>wrap.classList.remove('show'), rand(1800,3200)); }, rand(900,1500));
}

/* ===== ã²ã¨ã“ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===== */
const CHEERS=[
 'ã ã„ã˜ã‚‡ã†ã¶ã€ã‚†ã£ãã‚Šã§ã„ã„ã‚ˆ','ä»Šæ—¥ã®ãŒã‚“ã°ã‚Šã€è¦‹ã¦ãŸã‚ˆ','å°ã•ãªä¸€æ­©ã€ãˆã‚‰ã„ï¼',
 'æ·±å‘¼å¸ã€ã„ã£ã‹ã„ã­','ãã¿ã®ãƒšãƒ¼ã‚¹ã§é€²ã‚‚ã†','ãƒŸã‚¹ã‚‚é€²åŒ–ã®ã‚¿ãƒã ã‚ˆ',
 'ã‚‚ã†ä¸€æ­©ã ã‘ã€ã„ã£ã—ã‚‡ã«','ä¼‘ã‚€ã®ã‚‚å¼·ã•ã ã‚ˆ','ãã‚‰ã£â˜†'
];
function cycleCheer(){
  const el=document.getElementById('cheer');
  const x=rand(10, innerWidth-10), y=rand(10, innerHeight-10);
  el.textContent=CHEERS[rand(0,CHEERS.length-1)];
  el.style.left=x+'px'; el.style.top=y+'px';
  el.classList.add('show');
  const dx=(x<innerWidth/2)? 8 : -8, dy=-10;
  el.style.transform=`translate(${dx}px,${dy}px)`;
  setTimeout(()=>el.classList.remove('show'), rand(1600,2400));
}

/* ===== pts UI ===== */
const THRESHOLD=20;
function refreshPtsUI(){
  const n=getPts(); document.getElementById('pts').textContent=String(n);
  const btn=document.getElementById('btnMacaron');
  if(btn){
    if(n>=THRESHOLD){ btn.disabled=false; btn.classList.add('pop'); setTimeout(()=>btn.classList.remove('pop'),220); }
    else{ btn.disabled=true; }
  }
}
function resetPts(){ setPts(0); refreshPtsUI(); }

/* ===== å£ãƒ‘ã‚¯ or ã‚†ã‚‰ã— ===== */
let hasOpen=false, hasClosed=false;
function probeMouth(color){
  ['open','closed'].forEach(kind=>{
    const url=`${color}_${kind}.png`;
    const img=new Image();
    img.onload=()=>{ if(kind==='open') hasOpen=true; else hasClosed=true; };
    img.src=url;
  });
}
function mouthOrSwayOnce(){
  const img=document.getElementById('char');
  if(hasOpen && hasClosed){
    const color=getColor();
    const closed=`${color}_closed.png`, open=`${color}_open.png`;
    const seq=[open,closed,open,closed];
    let i=0; const tick=()=>{ if(i>=seq.length) return; img.src=seq[i++]; setTimeout(tick,120); }; tick();
  }else{
    img.classList.remove('sway'); void img.offsetWidth; img.classList.add('sway');
  }
}
function nudgeCharacter(){
  const ch=document.getElementById('char');
  const wrap=document.getElementById('charWrap');
  ch.classList.remove('hop'); void ch.offsetWidth; ch.classList.add('hop');
  mouthOrSwayOnce();
  const r=wrap.getBoundingClientRect();
  const dx=(Math.random()<.5?-1:1)*rand(12,28);
  const dy=(Math.random()<.5?-1:1)*rand(12,28);
  const nx=Math.min(innerWidth - r.width - 6, Math.max(6, r.left + dx));
  const ny=Math.min(innerHeight- r.height- 6, Math.max(6, r.top  + dy));
  const prev=getComputedStyle(wrap).getPropertyValue('--dur');
  wrap.style.setProperty('--dur','0.35s'); wrap.style.left=nx+'px'; wrap.style.top=ny+'px';
  setTimeout(()=>wrap.style.setProperty('--dur', prev || '3s'), 380);
}

/* ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ ===== */
const b_hunger=document.getElementById('b_hunger');
const b_energy=document.getElementById('b_energy');
const b_mood=document.getElementById('b_mood');
const b_bond=document.getElementById('b_bond');
const b_hygiene=document.getElementById('b_hygiene');

function renderCareBadges(){
  const s=getState();
  if(b_hunger){ b_hunger.textContent=s.hunger; }
  if(b_energy){ b_energy.textContent=s.energy; }
  if(b_mood){ b_mood.textContent=s.mood; }
  if(b_bond){ b_bond.textContent=s.bond; }
  if(b_hygiene){ b_hygiene.textContent=s.hygiene; }
}

/* ===== ãã‚Œã„åº¦ã®çµŒæ™‚åŠ£åŒ–ï¼ˆ1åˆ† -2ã€ä½ä¸‹æ™‚ã¯æ°—åˆ†-1ï¼‰ ===== */
const HYGIENE_TICK_MS = 60_000;
const HYGIENE_DROP = 2;
setInterval(()=>{
  const s=getState();
  s.hygiene = clamp(s.hygiene - HYGIENE_DROP, 0, 100);
  if(s.hygiene <= 20){ s.mood = clamp(s.mood - 1, 0, 100); }
  setState(s); renderCareBadges();
}, HYGIENE_TICK_MS);

/* ===== ãƒˆã‚¤ãƒ¬æƒé™¤ ===== */
document.getElementById('btnToilet').addEventListener('click', ()=>{
  const s=getState();
  if(s.hygiene >= 95){ alert('ã‚‚ã†ã‚­ãƒ¬ã‚¤ã ã‚ˆï¼'); return; }
  s.hygiene = 100;
  s.mood = clamp(s.mood + 6, 0, 100);
  s.bond = clamp(s.bond + 2, 0, 100);
  setState(s);
  alert('ãŠæƒé™¤å®Œäº†ï¼ãƒ”ã‚«ãƒ”ã‚«âœ¨');
  renderCareBadges();
});

/* ===== ã‚ãã¶ï¼ˆ5ç§’ã‚¿ãƒƒãƒ—ï¼‰ ===== */
const playModal=document.getElementById('playModal');
const pmStart=document.getElementById('pmStart');
const pmTap=document.getElementById('pmTap');
const pmClose=document.getElementById('pmClose');
const pmCount=document.getElementById('pmCount');
const pmLeft=document.getElementById('pmLeft');

let gameOn=false, count=0, t0=0, timerId=null;

document.getElementById('btnPlay').addEventListener('click', ()=>{
  pmCount.textContent='0'; pmLeft.textContent='5.0';
  playModal.classList.add('open');
});
pmClose.addEventListener('click', ()=>{ playModal.classList.remove('open'); stopGame(); });

pmStart.addEventListener('click', ()=>{
  count=0; pmCount.textContent='0';
  t0=performance.now(); gameOn=true;
  const D=5000;
  clearInterval(timerId);
  timerId=setInterval(()=>{
    const left=Math.max(0, D - (performance.now()-t0));
    pmLeft.textContent=(left/1000).toFixed(1);
    if(left<=0){ finishGame(); }
  }, 50);
});

pmTap.addEventListener('click', ()=>{
  if(!gameOn) return;
  count++; pmCount.textContent=String(count);
});

function stopGame(){
  gameOn=false;
  clearInterval(timerId);
  pmLeft.textContent='5.0';
}
function finishGame(){
  stopGame();
  const success = count >= 15;
  const s=getState();
  if(success){
    s.energy = clamp(s.energy + 8, 0, 100);
    s.mood   = clamp(s.mood + 10, 0, 100);
    s.bond   = clamp(s.bond + 1, 0, 100);
    alert(`æˆåŠŸï¼ ${count}å›ã‚¿ãƒƒãƒ—ã§ããŸã‚ˆï¼\nå…ƒæ°—+8 / ã”ãã’ã‚“+10 / æ„›ç€+1`);
  }else{
    s.mood = clamp(s.mood + 2, 0, 100);
    alert(`ã‚‚ã†å°‘ã—ï¼ ${count}å›ã ã£ãŸã‚ˆã€‚\nã”ãã’ã‚“+2`);
  }
  setState(s);
  renderCareBadges();
}

/* ===== èµ·å‹• ===== */
(function init(){
  const color=getColor(); document.getElementById('chipColor').textContent=color;
  probeMouth(color);
  loadCharImage(document.getElementById('char'), color);

  document.getElementById('nameText').textContent=getName();
  document.getElementById('nameHit').onclick=()=>{ setPts(Math.min(getPts()+1,THRESHOLD)); refreshPtsUI(); nudgeCharacter(); };

  refreshPtsUI();
  renderCareBadges();

  roamCharacter(); setInterval(roamCharacter, rand(2200,5200));
  cycleName();     setInterval(cycleName,   3200);
  setTimeout(cycleCheer, 800); setInterval(cycleCheer, 3600);
  addEventListener('resize', roamCharacter);
})();
</script>
</body>
</html>
