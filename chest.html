<!-- FILE: /chest.html（宝箱：24hロック／即時適用） -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WhoAI 宝箱</title>
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;background:#000;
    background-image:url("space_background.png");
    background-size:cover;background-position:center;background-attachment:fixed;
    display:flex;justify-content:center;align-items:center;min-height:100vh;padding:16px
  }
  .wrap{width:min(720px,94vw)}
  .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .ghostbtn{
    background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.18);
    color:#fff;border-radius:12px;padding:10px 12px;cursor:pointer
  }
  .nameBadge{
    background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.18);
    border-radius:12px;padding:8px 12px;font-weight:700
  }
  .card{
    background:rgba(0,0,0,.38);backdrop-filter:blur(4px);
    border:1px solid rgba(255,255,255,.18);border-radius:18px;
    padding:18px;box-shadow:0 10px 26px rgba(0,0,0,.4)
  }
  h1{margin:0 0 10px;font-size:22px}
  .lead{opacity:.95;margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 6px}
  .primary{
    cursor:pointer;border:0;border-radius:14px;padding:12px 16px;font-weight:800;
    background:#6ae28b;color:#062413;box-shadow:0 6px 18px rgba(0,0,0,.35);transition:.06s
  }
  .primary:active{transform:translateY(1px)}
  .meta{opacity:.9}
  .stats{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:12px}
  .pill{
    background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
    border-radius:12px;padding:10px;text-align:center
  }
  .msg{
    margin-top:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
    border-radius:12px;padding:12px;min-height:56px;line-height:1.6
  }
  .footBtns{position:fixed;right:16px;bottom:16px;display:flex;gap:10px}
  .tiny{font-size:12px;opacity:.85}
</style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <button class="ghostbtn" onclick="location.href='observe.html'">← 観察へ</button>
      <div id="nameBadge" class="nameBadge" style="display:none"></div>
    </div>

    <div class="card" role="region" aria-label="daily chest">
      <h1>🎁 宝箱（観察モードでも使えます）</h1>
      <p class="lead">タップした瞬間に中身が出ます。24時間に1回だけ開けられます。</p>

      <div class="row">
        <button id="openBtn" class="primary">宝箱を開ける</button>
        <div id="cooldownInfo" class="meta"></div>
      </div>

      <div class="stats" id="stats"></div>

      <div class="row" style="justify-content:space-between;margin-top:10px">
        <div class="meta">最後のアイテム：<span id="lastItem">—</span></div>
        <div class="meta">最終開封：<span id="lastOpenedAt">—</span></div>
      </div>

      <div id="msg" class="msg">（キャラのひとことが表示されます）</div>
      <div class="tiny" style="margin-top:8px">※ 開封済みのあいだに押すと「まだ開けられないよ！」とだけ表示します。</div>
    </div>
  </div>

  <div class="footBtns">
    <button class="ghostbtn" onclick="location.href='index.html'">🏠 ホーム</button>
    <button class="ghostbtn" onclick="location.href='whoai_talk.html'">💬 会話</button>
  </div>

<script>
/* ===== 共有キー ===== */
const STATE_KEY = "whoai_state_v1";
const KEY_LAST  = "lastChestOpen";

/* ===== 初期ステータス ===== */
const defaultState = { hunger:50, energy:50, mood:50, bond:10, hygiene:100 };
const clamp=(v,min=0,max=100)=>Math.max(min,Math.min(max,v));
function loadState(){
  try{const raw=localStorage.getItem(STATE_KEY);return raw?{...defaultState,...JSON.parse(raw)}:{...defaultState};}
  catch{return {...defaultState};}
}
function saveState(st){ localStorage.setItem(STATE_KEY, JSON.stringify(st)); }

function fmtTime(ms){
  if(!ms) return "—";
  const d=new Date(Number(ms));
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0"), mm=String(d.getMinutes()).padStart(2,"0");
  return `${y}/${m}/${day} ${hh}:${mm}`;
}

/* ===== 24hロック ===== */
function canOpen(){
  const last = localStorage.getItem(KEY_LAST);
  if(!last) return true;
  return Date.now() - Number(last) >= 24*60*60*1000;
}
function timeLeftText(){
  const last = localStorage.getItem(KEY_LAST);
  if(!last) return "";
  const remain = Number(last) + 24*60*60*1000 - Date.now();
  if(remain <= 0) return "開けられます！";
  const h = Math.floor(remain / 3_600_000);
  const m = Math.floor((remain % 3_600_000) / 60_000);
  return `あと ${h}時間${String(m).padStart(2,"0")}分`;
}

/* ===== 抽選 ===== */
function weightedPick(table){
  const total = table.reduce((s,t)=>s+t.w,0);
  let r = Math.random() * total;
  for(const t of table){ if((r -= t.w) < 0) return t.v; }
  return table.at(-1).v;
}
function rollCategory(){ return weightedPick([{v:"food",w:70},{v:"med",w:20},{v:"decor",w:10}]); }
function rollItem(cat){
  if(cat==="food"){
    return weightedPick([
      {v:{id:"onigiri",label:"🍙 おにぎり",kind:"food"},w:50},
      {v:{id:"candy",  label:"🍬 キャンディ",kind:"food"},w:20}
    ]);
  }
  if(cat==="med"){ return {id:"potion",label:"💊 薬",kind:"med"}; }
  return weightedPick([
    {v:{id:"ribbon",label:"🎀 リボン",kind:"decor"},w:50},
    {v:{id:"hat",   label:"🎩 ぼうし",kind:"decor"},w:50}
  ]);
}

/* ===== 効果（即時適用） ===== */
function applyEffect(state,item){
  let say="";
  switch(item.kind){
    case "food":
      if(item.id==="onigiri"){
        state.hunger = clamp(state.hunger + 25);
        state.mood   = clamp(state.mood + 5);
        say="もぐもぐ…おなかいっぱい！ありがとう！";
      }else{
        state.mood   = clamp(state.mood + 18);
        state.energy = clamp(state.energy + 6);
        say="あま〜い！しあわせ…！";
      }
      state.bond = clamp(state.bond + 2);
      break;
    case "med":
      state.energy = clamp(state.energy + 22);
      state.mood   = clamp(state.mood + 10);
      state.bond   = clamp(state.bond + 3);
      say="元気でた！だいじにしてくれてありがとう。";
      break;
    case "decor":
      state.mood   = clamp(state.mood + 8);
      state.bond   = clamp(state.bond + 4);
      say = (item.id==="ribbon") ? "どう？にあうかな？" : "おしゃれ！きょうは特別な気分！";
      break;
  }
  return say;
}

/* ===== UI ===== */
const $stats = document.getElementById("stats");
const $msg = document.getElementById("msg");
const $lastItem = document.getElementById("lastItem");
const $lastOpenedAt = document.getElementById("lastOpenedAt");
const $cooldownInfo = document.getElementById("cooldownInfo");
const $nameBadge = document.getElementById("nameBadge");

function renderStats(st){
  $stats.innerHTML="";
  [["満腹",st.hunger],["元気",st.energy],["ごきげん",st.mood],["愛着",st.bond],["きれい",st.hygiene]].forEach(([label,val])=>{
    const div=document.createElement("div");
    div.className="pill";
    div.innerHTML=`<div>${label}</div><div style="font-size:20px;font-weight:800">${val}</div>`;
    $stats.appendChild(div);
  });
}
function renderMeta(){
  $lastOpenedAt.textContent = fmtTime(localStorage.getItem(KEY_LAST));
  $cooldownInfo.textContent = timeLeftText();
  const nm = localStorage.getItem("whoai_character_name") || localStorage.getItem("whoai_name") || "";
  if(nm){ $nameBadge.textContent = `👤 ${nm}`; $nameBadge.style.display="block"; }
}

/* ===== 起動 ===== */
(function boot(){
  renderStats(loadState());
  renderMeta();
  $lastItem.textContent = localStorage.getItem("whoai_last_item_label") || "—";
  if(!$msg.textContent || $msg.textContent.includes("表示")){
    $msg.textContent="観察中…（静かに見守っています）";
  }
})();

/* ===== 開封 ===== */
document.getElementById("openBtn").addEventListener("click", ()=>{
  if(!canOpen()){
    alert("まだ開けられないよ！");
    renderMeta();
    return;
  }
  const item = rollItem(rollCategory());
  const st = loadState();
  const line = applyEffect(st,item);
  saveState(st);

  localStorage.setItem(KEY_LAST,String(Date.now()));
  localStorage.setItem("whoai_last_item_label",item.label);

  renderStats(st);
  renderMeta();
  $lastItem.textContent = item.label;

  alert(`宝箱を開けた！ → ${item.label}`);
  $msg.textContent = line;
});
</script>
</body>
</html>
