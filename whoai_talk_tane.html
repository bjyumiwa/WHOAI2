<!-- FILE: /WHOAI2/whoai_talk_tane.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WhoAI | ã‚¿ãƒè¦³å¯Ÿï¼ˆéŸ³ç¬¦ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰</title>
<meta name="color-scheme" content="dark light" />
<link rel="icon"
  href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.85em' font-size='80'%3EğŸŒ±%3C/text%3E%3C/svg%3E" />
<style>
  :root{
    --glass: rgba(0,0,0,.35);
    --brd: rgba(255,255,255,.18);
    --ink:#fff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;overflow:hidden}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:var(--ink);
    background:#000 url("space_background.png") center/cover fixed no-repeat;
  }

  /* HUD */
  .chips{position:fixed;left:50%;top:8px;transform:translateX(-50%);
    display:flex;gap:8px;flex-wrap:wrap;justify-content:center;z-index:5}
  .chip{background:var(--glass);backdrop-filter:blur(5px);
    border:1px solid var(--brd);padding:6px 10px;border-radius:999px;font-size:12px}

  .title{position:fixed;left:50%;top:44px;transform:translateX(-50%);font-weight:800;text-align:center;z-index:4}
  .subtitle{position:fixed;left:50%;top:72px;transform:translateX(-50%);font-size:12px;opacity:.9;text-align:center;z-index:4}

  /* ãƒ—ãƒ¬ã‚¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
  .field{position:fixed;inset:0;overflow:hidden}

  /* ã‚¿ãƒæœ¬ä½“ */
  .tane{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    display:flex;flex-direction:column;align-items:center;gap:6px;z-index:2
  }
  .tane img{
    width:min(40vmin,220px);height:auto;
    filter:drop-shadow(0 10px 28px rgba(0,0,0,.55));
    user-select:none;pointer-events:none;transition:transform .18s ease
  }
  @media (max-width:480px){ .tane img{width:min(54vmin,160px)} }
  .pop{animation:pop .25s ease}
  @keyframes pop{0%{transform:scale(1)}60%{transform:scale(1.06)}100%{transform:scale(1)}}

  /* åå‰ã‚¿ã‚° */
  .nameTag{
    margin-top:6px;padding:8px 14px;border-radius:12px;background:var(--glass);
    border:1px solid var(--brd);cursor:pointer;user-select:none;font-weight:800;
    box-shadow:0 8px 20px rgba(0,0,0,.35);opacity:0;transition:opacity .25s
  }
  .nameTag.show{opacity:1}
  .spin{animation:spin 500ms ease both}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* åŠ±ã¾ã—ãƒ•ã‚­ãƒ€ã‚· */
  .bubble{
    position:absolute;left:50%;top:-10px;transform:translate(-50%,-100%);
    background:#0f1220d0;border:1px solid var(--brd);border-radius:14px;
    padding:8px 12px;font-size:13px;box-shadow:0 10px 26px rgba(0,0,0,.5);
    opacity:0;transition:opacity .2s, transform .2s
  }
  .bubble.show{opacity:1;transform:translate(-50%,-115%)}

  /* ãŠä¸–è©±ãƒ‘ãƒãƒ« */
  .panel{position:fixed;left:50%;bottom:8px;transform:translateX(-50%);
    width:min(920px,96vw);display:grid;grid-template-columns:1fr;gap:8px;z-index:6}
  .care{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
  .btncare{background:var(--glass);border:1px solid var(--brd);color:#fff;border-radius:12px;
    padding:8px 12px;font-weight:800;cursor:pointer;font-size:14px}
  .btnreset{background:rgba(255,255,255,.14);border:1px solid var(--brd);color:#fff;border-radius:12px;
    padding:8px 12px;font-weight:800;cursor:pointer}
  .btnspeed{background:rgba(255,255,255,.14);border:1px solid var(--brd);border-radius:10px;
    padding:6px 10px;cursor:pointer;font-size:14px;min-width:40px;text-align:center}

  .gauges{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
  .gbar{position:relative;height:12px;border-radius:999px;background:rgba(255,255,255,.14);
    border:1px solid var(--brd);overflow:hidden}
  .gbar>span{position:absolute;left:0;top:0;bottom:0;width:60%;background:linear-gradient(90deg,#7ac7ff,#bfe6ff);transition:width .3s}
  .glbl{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:11px;text-shadow:0 1px 2px rgba(0,0,0,.4)}
  .btnspeed.active{ background:rgba(255,255,255,.24); border-color:rgba(255,255,255,.6) }

  /* ğŸ’©ï¼†â™ª */
  .poo{position:absolute;z-index:40;cursor:pointer;user-select:none;
    font-size:clamp(28px,4vw,42px);filter:drop-shadow(0 4px 10px rgba(0,0,0,.35))}
  .noteItem{position:absolute;z-index:41;cursor:pointer;user-select:none;
    font-size:clamp(24px,3.2vw,36px);filter:drop-shadow(0 4px 10px rgba(0,0,0,.35))}
  .note-float{position:fixed;z-index:60;pointer-events:none;font-size:clamp(20px,3vw,30px);
    animation:noteFloat 1.2s ease-out forwards}
  @keyframes noteFloat{0%{transform:translateY(0) scale(1);opacity:0}10%{opacity:1}100%{transform:translateY(-120px) scale(1.2);opacity:0}}

  /* ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ ï¼ˆå³ä¸Šï¼‰ */
  .musicDock{
    position:fixed;right:10px;top:102px;z-index:7;
    background:var(--glass);border:1px solid var(--brd);backdrop-filter:blur(6px);
    border-radius:14px;padding:10px 12px;min-width:200px
  }
  .musicDock h4{display:none}
  .scoreRow{display:flex;gap:6px;flex-wrap:wrap}
  .slot{
    min-width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;
    background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.22);position:relative;overflow:hidden
  }
  .slot.on{
    background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.45);
    animation:slotPop .24s ease
  }
  .slot.on::after{
    content:"â™ª"; color:#fff; opacity:.95; text-shadow:0 2px 10px rgba(0,0,0,.35); font-weight:800
  }
  @keyframes slotPop{0%{transform:scale(.85);opacity:.6}100%{transform:scale(1);opacity:1}}
  .slot.on.big{animation:slotPopBig .32s ease}
  @keyframes slotPopBig{0%{transform:scale(.8);opacity:.6}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
</style>
</head>
<body>
  <!-- HUD -->
  <div class="chips">
    <span class="chip">ğŸ‘¤ <span id="chipPlayer">ã‚ãªãŸ</span></span>
    <span class="chip">ğŸ¨ è‰²: <span id="chipColor">pink</span></span>
    <span class="chip">ğŸ€ ãƒ¢ãƒ¼ãƒ‰: ã‚¿ãƒè¦³å¯Ÿ</span>
  </div>
  <div class="title">ã‚¿ãƒã‚’è¦³å¯Ÿã—ã¦è‚²ã¦ã‚ˆã†</div>
  <div class="subtitle">â€œåå‰ã‚¿ãƒƒãƒâ€ã‚„ãŠä¸–è©±ã§éŸ³ç¬¦ã‚’é›†ã‚ã¦ã€æ›²ãŒå®Œæˆã—ãŸã‚‰é€²åŒ–ï¼</div>

  <!-- ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ  -->
  <aside class="musicDock" id="musicDock" aria-live="polite">
    <h4>ğŸ‚ ãƒãƒƒãƒ”ãƒ¼ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼ï¼ˆãƒ•ãƒ«ï¼‰</h4>
    <div class="scoreRow" id="scoreRow"></div>
  </aside>

  <!-- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
  <div class="field" id="field">
    <div class="tane" id="tane">
      <div class="bubble" id="bubble"></div>
      <img id="taneImg" alt="tane">
      <div class="nameTag" id="nameTag"></div>
    </div>
  </div>

  <!-- ãŠä¸–è©±ï¼‹é€Ÿåº¦ï¼‹â™ªãƒªã‚»ãƒƒãƒˆ -->
  <div class="panel">
    <div class="care">
      <button class="btncare" id="btnToilet">ğŸš½ ãƒˆã‚¤ãƒ¬</button>
      <button class="btncare" id="btnBath">ğŸ› ãŠãµã‚</button>
      <button class="btncare" id="btnPlay">ğŸ² ã‚ãã¶</button>
      <button class="btnreset" id="btnNoteReset" title="é›†ã‚ãŸâ™ªã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢">â™ª ãƒªã‚»ãƒƒãƒˆ</button>
      <!-- é€Ÿåº¦ï¼ˆçœŸã‚“ä¸­ã¯1Ã—ã«ï¼‰ -->
      <button class="btnspeed" data-speed="slow"   onclick="setSpeed('slow')"   title="ã‚†ã£ãã‚Š" aria-label="ã‚†ã£ãã‚Š">ğŸ¢</button>
      <button class="btnspeed" data-speed="normal" onclick="setSpeed('normal')" title="ãµã¤ã† (1Ã—)" aria-label="ãµã¤ã† (1Ã—)">1Ã—</button>
      <button class="btnspeed" data-speed="fast"   onclick="setSpeed('fast')"   title="ã¯ã‚„ã„"  aria-label="ã¯ã‚„ã„">ğŸ‡</button>
    </div>
    <div class="gauges">
      <div class="gbar" id="gClean"><span></span><div class="glbl">ãã‚Œã„</div></div>
      <div class="gbar" id="gFun"><span></span><div class="glbl">ãŸã®ã—ã•</div></div>
      <div class="gbar" id="gRelief"><span></span><div class="glbl">ã‚¹ãƒƒã‚­ãƒª</div></div>
    </div>
  </div>

<script>
/* ====== ä¾¿åˆ©é–¢æ•° ====== */
const read = (k, d='') => {
  const v = localStorage.getItem(k);
  return (v===null||v==='undefined'||v==='null')? d : v;
};
const clamp = v => Math.max(0, Math.min(100, v));

/* ====== åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ ====== */
const PLAYER_NAME = read('PLAYER_NAME','ã‚ãªãŸ');
const CHAR_NAME   = read('CHAR_NAME','ã‚¿ãƒ');
const COLOR       = (read('macaronColor','pink')||'pink').trim().toLowerCase();

/* ====== DOM ====== */
const chipPlayer = document.getElementById('chipPlayer');
const chipColor  = document.getElementById('chipColor');
const taneImg    = document.getElementById('taneImg');
const nameTag    = document.getElementById('nameTag');
const bubble     = document.getElementById('bubble');
const field      = document.getElementById('field');
const taneEl     = document.getElementById('tane');
const gClean     = document.getElementById('gClean');
const gFun       = document.getElementById('gFun');
const gRelief    = document.getElementById('gRelief');
const btnToilet  = document.getElementById('btnToilet');
const btnBath    = document.getElementById('btnBath');
const btnPlay    = document.getElementById('btnPlay');
const btnNoteReset = document.getElementById('btnNoteReset');

chipPlayer.textContent = PLAYER_NAME;
chipColor.textContent  = COLOR;

/* ====== ç”»åƒãƒ­ãƒ¼ãƒ€ï¼ˆå¤šæ®µãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‹æœ€çµ‚â™ªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ ====== */
(function setTaneSrc(){
  const color = (window.COLOR || COLOR || 'pink').toLowerCase();
  const candidates = [
    `tane_${color}.png`,
    `images/tane_${color}.png`,
    `img/tane_${color}.png`,
    `assets/tane_${color}.png`,
    'tane_pink.png','images/tane_pink.png','img/tane_pink.png','assets/tane_pink.png',
    'ako.png','images/ako.png','img/ako.png','assets/ako.png'
  ];
  const bust = `?v=${Date.now()}`;

  function usePlaceholder(){
    const img = document.getElementById('taneImg');
    const host = document.getElementById('tane');
    if(img) img.remove();
    const ph = document.createElement('div');
    ph.style.cssText = `
      width:140px;height:140px;border-radius:50%;
      background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);
      display:flex;align-items:center;justify-content:center;
      font-size:54px;backdrop-filter:blur(4px);
    `;
    ph.textContent = 'â™ª';
    host.insertBefore(ph, host.querySelector('.nameTag'));
    console.warn('[tane] ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å€™è£œ:', candidates);
  }

  (function tryNext(i){
    if(i >= candidates.length) return usePlaceholder();
    const url = candidates[i] + bust;
    const test = new Image();
    test.onload = () => { taneImg.src = candidates[i]; };
    test.onerror = () => tryNext(i+1);
    test.src = url;
  })(0);
})();

/* ====== æ›²ï¼ˆæ­£ã—ã„ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ï¼‹é•·ã•ï¼‰ ======
   G4 G4 A4 G4 C5 B4 | G4 G4 A4 G4 D5 C5 |
   G4 G4 G5 E5 C5 B4 A4 | F5 F5 E5 C5 D5 C5
   len: çŸ­=1, ä¸­=2, é•·=3 ç›¸å¯¾é•·
*/
const SONG = [
  {n:"ã‚½4",len:1},{n:"ã‚½4",len:1},{n:"ãƒ©4",len:2},{n:"ã‚½4",len:2},{n:"ãƒ‰5",len:2},{n:"ã‚·4",len:4},
  {n:"ã‚½4",len:1},{n:"ã‚½4",len:1},{n:"ãƒ©4",len:2},{n:"ã‚½4",len:2},{n:"ãƒ¬5",len:2},{n:"ãƒ‰5",len:4},
  {n:"ã‚½4",len:1},{n:"ã‚½4",len:1},{n:"ã‚½5",len:2},{n:"ãƒŸ5",len:2},{n:"ãƒ‰5",len:2},{n:"ã‚·4",len:2},{n:"ãƒ©4",len:5},
  {n:"ãƒ•ã‚¡5",len:1},{n:"ãƒ•ã‚¡5",len:1},{n:"ãƒŸ5",len:2},{n:"ãƒ‰5",len:2},{n:"ãƒ¬5",len:2},{n:"ãƒ‰5",len:4}
];

/* ä¿å­˜ã‚­ãƒ¼ */
const LS_NOTE = { list:'whoai_notes_birthday_full', poo:'whoai_poo_count', done:'whoai_song_complete_full' };
let collected = JSON.parse(localStorage.getItem(LS_NOTE.list) || '[]');
let pooCount  = Number(localStorage.getItem(LS_NOTE.poo) || 0);

/* ====== åå‰ã‚¿ãƒƒãƒã§1éŸ³å‰é€² ====== */
nameTag.textContent = CHAR_NAME;
nameTag.addEventListener('click', ()=>{
  nameTag.classList.remove('spin'); void nameTag.offsetWidth; nameTag.classList.add('spin');
  taneImg.classList.add('pop'); setTimeout(()=>taneImg.classList.remove('pop'), 250);
  grantNextNote();
});
setInterval(()=> nameTag.classList.toggle('show', Math.random()<0.55), 3000);

/* ====== åŠ±ã¾ã— ====== */
const LINES = ['ã„ã„ãƒšãƒ¼ã‚¹ï¼','ãŒã‚“ã°ã£ã¦ã‚‹ã­','ãã®èª¿å­âœ¨','ã‚ã‚ŠãŒã¨ã†ï¼','ä¼‘æ†©ã‚‚å¤§äº‹ã ã‚ˆ','ã‚ã¨å°‘ã—ï¼','ä¸€ç·’ã«ã„ã“ã†'];
function showBubble(){ bubble.textContent = LINES[(Math.random()*LINES.length)|0];
  bubble.classList.add('show'); setTimeout(()=>bubble.classList.remove('show'),2000); }
setInterval(()=>{ if(Math.random()<0.45) showBubble(); }, 5000);

/* ====== ã‚­ãƒ£ãƒ©ç§»å‹• ====== */
const SPEEDS = { slow:0.022, normal:0.036, fast:0.055 };
let curSpeed='slow', vx=0, vy=0;
function rs(){ return Math.random()<0.5?-1:1; }
function setSpeed(mode=curSpeed){
  curSpeed=mode;
  const base = (innerWidth<520)?(mode==='fast'?0.045:mode==='normal'?0.030:0.018):SPEEDS[mode];
  vx=base*(0.9+Math.random()*0.2)*rs();
  vy=base*(0.9+Math.random()*0.2)*rs();
  document.querySelectorAll('.btnspeed').forEach(btn=>{
    const active = btn.dataset.speed === mode;
    btn.classList.toggle('active', active);
    btn.setAttribute('aria-pressed', active ? 'true' : 'false');
  });
}
setSpeed('slow');

let last = performance.now();
let pos  = {x: innerWidth/2, y: innerHeight/2};
function bounds(){
  const rect = field.getBoundingClientRect();
  const w = (taneImg.clientWidth||160), h = (taneImg.clientHeight||160);
  return {minX:10, minY:100, maxX:rect.width-10, maxY:rect.height-140, w, h};
}
function step(now){
  let dt = Math.min(now-last, 40); last = now;
  const b = bounds();
  pos.x += vx*dt; pos.y += vy*dt;
  const hw=b.w/2, hh=b.h/2;
  if(pos.x < b.minX+hw){ pos.x=b.minX+hw; vx*=-1; }
  if(pos.x > b.maxX-hw){ pos.x=b.maxX-hw; vx*=-1; }
  if(pos.y < b.minY+hh){ pos.y=b.minY+hh; vy*=-1; }
  if(pos.y > b.maxY-hh){ pos.y=b.maxY-hh; vy*=-1; }
  taneEl.style.left = `${pos.x}px`; taneEl.style.top = `${pos.y}px`;
  requestAnimationFrame(step);
}
(function initPos(){ const b=bounds(); pos.x=(b.minX+b.maxX)/2; pos.y=(b.minY+b.maxY)/2;
  taneEl.style.left=`${pos.x}px`; taneEl.style.top=`${pos.y}px`; })();
requestAnimationFrame(step);

/* ====== ã‚²ãƒ¼ã‚¸ ====== */
const SKEY = { clean:'taneClean', fun:'taneFun', relief:'taneRelief', last:'taneLastTick' };
let clean  = Number(localStorage.getItem(SKEY.clean)  ?? 70);
let fun    = Number(localStorage.getItem(SKEY.fun)    ?? 70);
let relief = Number(localStorage.getItem(SKEY.relief) ?? 70);
let lastTick = Number(localStorage.getItem(SKEY.last) ?? Date.now());
const DECAY_MS = 2600, DECAY = 1, COOLDOWN = 1200;

function setGauge(el, val){
  const span = el.querySelector('span');
  val = clamp(val);
  span.style.width = `${val}%`;
  span.style.background = val>=66
    ? 'linear-gradient(90deg,#8EE6A2,#c9f9d6)'
    : val>=33
    ? 'linear-gradient(90deg,#FFD36E,#ffe4a8)'
    : 'linear-gradient(90deg,#FF8A8A,#ffc2c2)';
}
function renderGauges(){ setGauge(gClean,clean); setGauge(gFun,fun); setGauge(gRelief,relief); }
function persistGauges(){
  localStorage.setItem(SKEY.clean,clean);
  localStorage.setItem(SKEY.fun,fun);
  localStorage.setItem(SKEY.relief,relief);
  localStorage.setItem(SKEY.last,Date.now());
}
function tick(){
  const now = Date.now();
  if(now - lastTick >= DECAY_MS){
    clean  = clamp(clean  - DECAY);
    fun    = clamp(fun    - DECAY);
    relief = clamp(relief - DECAY);
    lastTick = now; renderGauges(); persistGauges();
  }
  requestAnimationFrame(tick);
}
function cooldown(btn){ btn.disabled=true; setTimeout(()=>btn.disabled=false, COOLDOWN); }
btnToilet.addEventListener('click', ()=>{ cooldown(btnToilet); relief=clamp(relief+18); clean=clamp(clean+4);  renderGauges(); persistGauges(); spawnNoteNearTane(); });
btnBath.addEventListener('click',   ()=>{ cooldown(btnBath);   clean =clamp(clean +22);                    renderGauges(); persistGauges(); spawnNoteNearTane(); });
btnPlay.addEventListener('click',   ()=>{ cooldown(btnPlay);   fun   =clamp(fun   +18);                    renderGauges(); persistGauges(); spawnNoteNearTane(); });

/* ====== ã€Œâ™ª ãƒªã‚»ãƒƒãƒˆã€ï¼šéŸ³ç¬¦ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã ã‘åˆæœŸåŒ– ====== */
btnNoteReset.addEventListener('click', ()=>{
  document.querySelectorAll('.noteItem').forEach(n=>n.remove());
  collected = [];
  localStorage.removeItem(LS_NOTE.list);
  localStorage.removeItem(LS_NOTE.done);
  isSongPlaying = false;
  renderScore();
});

/* ====== ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³UI ====== */
const scoreRow = document.getElementById('scoreRow');
function renderScore(){
  scoreRow.innerHTML = '';
  for(let i=0;i<SONG.length;i++){
    const d=document.createElement('div');
    d.className='slot'+(i<collected.length?' on':'');
    scoreRow.appendChild(d);
  }
}
function bounceLastThree(){
  const nodes = scoreRow.querySelectorAll('.slot');
  const L = nodes.length;
  for(let i=Math.max(0, L-3); i<L; i++){
    nodes[i].classList.remove('big'); void nodes[i].offsetWidth; nodes[i].classList.add('big');
  }
}

/* ====== ğŸ’©ï¼š3.5ç§’ã”ã¨ã«55%ã§æœ€å¤§3å€‹ã€‚10å›ã§ã€Œæ¬¡ãŒãƒ‰ç³»ãªã‚‰ã€è‡ªå‹•ä»˜ä¸ ====== */
const POO_MAX=3;
function spawnPoo(){
  if(field.querySelectorAll('.poo').length>=POO_MAX) return;
  const rect = field.getBoundingClientRect();
  const x = Math.random()*(rect.width-80)+22;
  const y = Math.random()*(rect.height-160)+ (rect.height*0.45);
  const el=document.createElement('div'); el.className='poo'; el.textContent='ğŸ’©';
  el.style.left=`${x}px`; el.style.top=`${y}px`;
  el.addEventListener('click', ()=>{
    el.remove();
    pooCount++; localStorage.setItem(LS_NOTE.poo, String(pooCount));
    floatNote('ğŸ’§', rect.left+x, rect.top+y);
    if(pooCount%10===0){
      const needObj = SONG[collected.length];
      if(needObj && needObj.n.startsWith("ãƒ‰")){ gainNote(needObj.n); }
    }
    relief=clamp(relief+6); clean=clamp(clean+2); renderGauges(); persistGauges();
  });
  field.appendChild(el);
}
setInterval(()=>{ if(Math.random()<0.55) spawnPoo(); }, 3500);

/* ====== â™ªï¼šæ¬¡ã«å¿…è¦ãªéŸ³ã‚’ã‚¹ãƒãƒ¼ãƒ³â†’ã‚¯ãƒªãƒƒã‚¯ã§åé›†ï¼ˆè¡¨ç¤ºã¯â™ªã®ã¿ï¼‰ ====== */
function spawnNoteNearTane(){
  const nextObj = SONG[collected.length];
  if(!nextObj) return;
  const rect = field.getBoundingClientRect();
  const tx = pos.x + (Math.random()*120-60);
  const ty = pos.y + (Math.random()*80-40);
  const x = Math.max(20, Math.min(rect.width-40, tx));
  const y = Math.max(120, Math.min(rect.height-160, ty));
  const el=document.createElement('div'); el.className='noteItem'; el.textContent="â™ª";
  el.style.left=`${x}px`; el.style.top=`${y}px`;
  el.addEventListener('click', ()=>{
    el.remove();
    gainNote(nextObj.n);
    fun=clamp(fun+6); renderGauges(); persistGauges();
  });
  field.appendChild(el);
}

/* ãµã‚ã£ã¨ */
function floatNote(char, x, y){
  const el=document.createElement('div');
  el.className='note-float'; el.textContent=char;
  el.style.left=`${x}px`; el.style.top=`${y}px`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 1200);
}

/* ====== åé›†ãƒ­ã‚¸ãƒƒã‚¯ ====== */
function grantNextNote(){
  if(collected.length<SONG.length){
    gainNote(SONG[collected.length].n);
  }
}
function gainNote(nStr){
  const needObj = SONG[collected.length];
  if(!needObj || nStr!==needObj.n) return; // é †ç•ªåˆ¶
  collected.push(nStr);
  localStorage.setItem(LS_NOTE.list, JSON.stringify(collected));
  renderScore();

  if(collected.length===SONG.length){
    localStorage.setItem(LS_NOTE.done,'1');
    bounceLastThree();
    isSongPlaying = true;
    playSong(SONG).then(()=>{
      isSongPlaying = false;
      // â˜…æ¼”å¥ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰é€²åŒ–ï¼ˆãƒã‚«ãƒ­ãƒ³é¸æŠï¼‰ã¸
      location.href='macaron_select.html';
    });
  }
}

/* ====== å†ç”Ÿï¼ˆWebAudioï¼šã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ï¼‹é•·ã•å¯¾å¿œï¼‰ ====== */
function solfegeToFreq(s){
  const m = s.match(/(ãƒ‰|ãƒ¬|ãƒŸ|ãƒ•ã‚¡|ã‚½|ãƒ©|ã‚·)(\d)/);
  if(!m) return 440;
  const base = {"ãƒ‰":0,"ãƒ¬":2,"ãƒŸ":4,"ãƒ•ã‚¡":5,"ã‚½":7,"ãƒ©":9,"ã‚·":11}[m[1]];
  const oct  = parseInt(m[2],10);
  const midi = 12*(oct+1)+base; // C4=60
  return 440*Math.pow(2,(midi-69)/12);
}
let isSongPlaying = false;
async function playSong(seq){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const UNIT=.33, GAP=.06;
    let t=ctx.currentTime;
    for(const obj of seq){
      const dur = UNIT*(obj.len||1);
      const osc=ctx.createOscillator(), g=ctx.createGain();
      osc.type='sine';
      osc.frequency.value=solfegeToFreq(obj.n);
      g.gain.setValueAtTime(.0001,t);
      g.gain.linearRampToValueAtTime(.18,t+.03);
      g.gain.setTargetAtTime(.0001,t+dur*.8,.06);
      osc.connect(g).connect(ctx.destination);
      osc.start(t); osc.stop(t+dur);
      t+=dur+GAP;
    }
    await new Promise(r=>setTimeout(r,(t-ctx.currentTime)*1000+80));
    ctx.close();
  }catch(e){ console.warn(e); }
}

/* ====== èµ·å‹• ====== */
function refreshAll(){ renderGauges(); renderScore(); }
(function init(){
  chipPlayer.textContent = PLAYER_NAME;
  chipColor.textContent  = COLOR;
  refreshAll();
  requestAnimationFrame(tick);
  nameTag.classList.add('show');

  // æ—¢ã«æ›²å®Œæˆãªã‚‰ã€ãƒšãƒ¼ã‚¸å…¥å ´ã§æ¼”å¥â†’ãã®å¾Œã«é€²åŒ–
  if(localStorage.getItem(LS_NOTE.done)==='1'){
    isSongPlaying = true;
    playSong(SONG).then(()=>{
      isSongPlaying = false;
      location.href='macaron_select.html';
    });
  }
})();
</script>
</body>
</html>
