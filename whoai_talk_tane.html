<!-- FILE: /WHOAI2/whoai_talk_tane.html (fixed) -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>WhoAI | タネ観察（お世話＋ポイント→マカロン）</title>
  <meta name="color-scheme" content="dark light" />
  <!-- 404対策：簡易favicon -->
  <link rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.85em' font-size='80'%3E🍬%3C/text%3E%3C/svg%3E" />
  <style>
    :root{ --glass:rgba(0,0,0,.35); --brd:rgba(255,255,255,.18);
           --ok:#86efac; --warn:#fde047; --bad:#fda4af; --accent:#7ac7ff; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;overflow:hidden}
    body{
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
      background:#000 url("space_background.png") center/cover fixed no-repeat;
      display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    .chip{background:var(--glass);backdrop-filter:blur(4px);border:1px solid var(--brd);padding:6px 10px;border-radius:999px;font-size:12px}
    .title{font-size:22px;font-weight:800;letter-spacing:.04em;margin-top:2px}
    .subtitle{font-size:12px;opacity:.9;margin-top:-4px}

    /* ステージ：クラゲふわふわ */
    .stage{
      position:relative;width:min(92vw,520px);aspect-ratio:1/1;background:rgba(0,0,0,.25);
      border:1px solid var(--brd);border-radius:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;
      animation:jelly 9s ease-in-out infinite; will-change:transform;
    }
    @keyframes jelly{
      0%{transform:translate(0,0) rotate(0deg)}
      25%{transform:translate(-4px,-6px) rotate(-0.6deg)}
      50%{transform:translate(4px,2px) rotate(0.6deg)}
      75%{transform:translate(-3px,4px) rotate(-0.4deg)}
      100%{transform:translate(0,0) rotate(0deg)}
    }
    .tane{position:relative;display:flex;flex-direction:column;align-items:center;gap:6px}
    .tane img{width:min(46vmin,220px);height:auto;filter:drop-shadow(0 8px 22px rgba(0,0,0,.5));user-select:none;transition:transform .2s ease}
    .pop{animation:pop .25s ease}
    @keyframes pop{0%{transform:scale(1)}60%{transform:scale(1.06)}100%{transform:scale(1)}}
    @media (max-width:480px){ .title{font-size:19px} .stage{width:min(94vw,380px)} .tane img{width:min(58vmin,160px)} }

    #char-name{display:none} /* 互換用に残すが非表示 */

    /* 名前タッチ（クリックでくるん） */
    .nameTag{
      position:absolute;left:50%;top:18%;transform:translate(-50%,-50%);
      padding:8px 14px;border-radius:12px;background:var(--glass);border:1px solid var(--brd);
      cursor:pointer;user-select:none;font-weight:800;z-index:6;box-shadow:0 6px 18px rgba(0,0,0,.35)
    }
    .spin{animation:spin 500ms ease both}
    @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

    /* マカロン解放バッジ */
    #unlock{position:absolute;right:10px;top:10px;display:none;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:var(--glass);border:1px solid var(--brd);cursor:pointer;z-index:5}
    #unlock:active{transform:translateY(1px)}

    /* ポイントバー */
    .bar{position:relative;width:min(92vw,520px);height:12px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid var(--brd);overflow:hidden}
    .bar>i{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,var(--ok),#a7f3d0)}
    .barrow{display:flex;align-items:center;gap:8px}
    .pts{font-variant-numeric:tabular-nums;background:var(--glass);border:1px solid var(--brd);padding:6px 10px;border-radius:10px}

    /* お世話（モバイル小さめ） */
    .panel{position:fixed;left:50%;bottom:8px;transform:translateX(-50%);width:min(920px,96vw);display:grid;grid-template-columns:1fr;gap:8px;z-index:7}
    .care{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
    .btncare{background:var(--glass);border:1px solid var(--brd);color:#fff;border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer;font-size:14px}
    .btncare:disabled{opacity:.55;cursor:not-allowed}
    .gauges{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
    .gbar{position:relative;height:12px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid var(--brd);overflow:hidden}
    .gbar>span{position:absolute;left:0;top:0;bottom:0;width:50%;background:linear-gradient(90deg,#7ac7ff,#bfe6ff);transition:width .3s}
    .glbl{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:11px;text-shadow:0 1px 2px rgba(0,0,0,.4)}

    .nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .ghostbtn{background:var(--glass);border:1px solid var(--brd);color:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}

    .toast{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0f1220;border:1px solid var(--brd);border-radius:16px;padding:14px 16px;z-index:50;display:none;box-shadow:0 18px 50px rgba(0,0,0,.5)}
    .toast.show{display:block;animation:pop .25s ease}
  </style>
</head>
<body>
  <div class="chips">
    <span class="chip">👤 <span id="chipPlayer">あなた</span></span>
    <span class="chip">🎨 色: <span id="chipColor">pink</span></span>
    <span class="chip">🍀 モード: タネ観察</span>
  </div>
  <div class="title">タネを観察して育てよう</div>
  <div class="subtitle">“名前タッチ”やお世話でポイントをためると、マカロンが解放されて進化できます</div>

  <div class="stage" id="stage">
    <div id="unlock">🍬 マカロン解放！</div>
    <div class="tane">
      <img id="taneImg" alt="tane">
      <div id="char-name" title="クリックでポイント+1"></div>
    </div>
    <div class="nameTag" id="nameTag" title="タッチでポイント+1"></div>
  </div>

  <div class="barrow" style="margin-top:10px">
    <div class="bar"><i id="bar"></i></div>
    <div class="pts">ポイント: <span id="pts">0</span> / <span id="th">15</span></div>
  </div>

  <div class="panel">
    <div class="care">
      <button class="btncare" id="btnToilet">🚽 トイレ</button>
      <button class="btncare" id="btnBath">🛁 おふろ</button>
      <button class="btncare" id="btnPlay">🎲 あそぶ</button>
    </div>
    <div class="gauges">
      <div class="gbar" id="gClean"><span></span><div class="glbl">きれい</div></div>
      <div class="gbar" id="gFun"><span></span><div class="glbl">たのしさ</div></div>
      <div class="gbar" id="gRelief"><span></span><div class="glbl">スッキリ</div></div>
    </div>
  </div>

  <div class="nav" style="margin-top:6px">
    <button class="ghostbtn" onclick="location.href='color_pick.html'">🔄 色をえらび直す</button>
    <button class="ghostbtn" onclick="location.href='index.html'">🏠 ホーム</button>
  </div>

  <div class="toast" id="toast">ポイントがたまりました！<br/>マカロン選択へ進みます…</div>

<script>
  // ===== 便利ヘルパー =====
  const read = (k, d='') => { const v = localStorage.getItem(k); return (v===null||v==='undefined'||v==='null')? d : v; };

  // 設定・初期値
  const PLAYER_NAME = read('PLAYER_NAME', read('whoai_player_name', 'あなた'));
  const CHAR_NAME   = read('CHAR_NAME',   read('whoai_name', 'タネ'));
  const COLOR       = (read('macaronColor','pink')||'pink').toLowerCase(); // pink/green/blue/purple
  const THRESHOLD   = Number(read('TANE_POINTS_TO_EVOLVE','15'));
  let pts           = Number(read('tanePoints','0'));

  // ===== DOM参照は最初に定義（←ここが修正ポイント）=====
  const chipPlayer = document.getElementById('chipPlayer');
  const chipColor  = document.getElementById('chipColor');
  const taneImg    = document.getElementById('taneImg');
  const nameTag    = document.getElementById('nameTag');
  const ptsEl      = document.getElementById('pts');
  const barFill    = document.getElementById('bar');
  const unlock     = document.getElementById('unlock');
  const gClean     = document.getElementById('gClean');
  const gFun       = document.getElementById('gFun');
  const gRelief    = document.getElementById('gRelief');
  const btnToilet  = document.getElementById('btnToilet');
  const btnBath    = document.getElementById('btnBath');
  const btnPlay    = document.getElementById('btnPlay');
  const toast      = document.getElementById('toast');

  // HUD
  chipPlayer.textContent = PLAYER_NAME;
  chipColor.textContent  = COLOR;
  document.getElementById('th').textContent = THRESHOLD;

  // キャラ画像
  (function setTaneSrc(){
    const file = `tane_${COLOR}.png`;
    const t = new Image();
    t.onload = ()=> (taneImg.src = file);
    t.onerror = ()=> (taneImg.src = 'tane_pink.png');
    t.src = file;
  })();

  // ===== ポイント表示 =====
  function refreshPoints(){
    ptsEl.textContent = String(pts);
    const ratio = Math.max(0, Math.min(1, pts / THRESHOLD));
    barFill.style.width = `${ratio*100}%`;
    barFill.style.background = ratio>0.66? 'linear-gradient(90deg,var(--ok),#a7f3d0)'
                              : ratio>0.33? 'linear-gradient(90deg,var(--warn),#fde68a)'
                                           : 'linear-gradient(90deg,var(--bad),#fecaca)';
    unlock.style.display = (pts >= THRESHOLD) ? 'inline-flex' : 'none';
  }

  // ===== 名前タッチ（くるん回転＋ポイント） =====
  nameTag.textContent = CHAR_NAME;

  function moveNameTagRandom(){
    const pad = 36, avoidBottom = 170;
    const W = window.innerWidth, H = window.innerHeight;
    const x = Math.random() * (W - pad*2) + pad;
    const y = Math.random() * (H - pad*2 - avoidBottom) + pad;
    nameTag.style.left = `${x}px`;
    nameTag.style.top  = `${y}px`;
    nameTag.style.transform = 'translate(-50%,-50%)';
  }
  function popChar(){
    taneImg.classList.add('pop');
    setTimeout(()=>taneImg.classList.remove('pop'), 250);
  }
  function addPoints(n=1){
    pts += n;
    localStorage.setItem('tanePoints', String(pts));
    refreshPoints(); popChar();
    if(pts >= THRESHOLD) evolveToast();
  }
  nameTag.addEventListener('click', ()=>{
    nameTag.classList.remove('spin'); void nameTag.offsetWidth; nameTag.classList.add('spin');
    addPoints(1); moveNameTagRandom();
  });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addPoints(1); } });

  // ===== お世話：ゲージ =====
  const SKEY = { clean:'taneClean', fun:'taneFun', relief:'taneRelief', last:'taneLastTick' };
  let clean  = Number(localStorage.getItem(SKEY.clean)  ?? 70);
  let fun    = Number(localStorage.getItem(SKEY.fun)    ?? 70);
  let relief = Number(localStorage.getItem(SKEY.relief) ?? 70);
  let lastTick = Number(localStorage.getItem(SKEY.last) ?? Date.now());

  const DECAY_MS = 2500, DECAY = 1, COOLDOWN = 1200;
  function clamp(v){ return Math.max(0, Math.min(100, v)); }
  function setGauge(el, val){
    const span = el.querySelector('span');
    val = clamp(val); span.style.width = `${val}%`;
    span.style.background = val>=66 ? 'linear-gradient(90deg,#8EE6A2,#c9f9d6)'
                        : val>=33 ? 'linear-gradient(90deg,#FFD36E,#ffe4a8)'
                                  : 'linear-gradient(90deg,#FF8A8A,#ffc2c2)';
  }
  function renderGauges(){ setGauge(gClean,clean); setGauge(gFun,fun); setGauge(gRelief,relief); }
  function persistGauges(){
    localStorage.setItem(SKEY.clean,clean);
    localStorage.setItem(SKEY.fun,fun);
    localStorage.setItem(SKEY.relief,relief);
    localStorage.setItem(SKEY.last,Date.now());
  }
  function tick(){
    const now = Date.now();
    if(now - lastTick >= DECAY_MS){
      clean=clamp(clean-DECAY); fun=clamp(fun-DECAY); relief=clamp(relief-DECAY);
      lastTick = now; renderGauges(); persistGauges();
    }
    requestAnimationFrame(tick);
  }
  function cooldown(btn){ btn.disabled=true; setTimeout(()=>btn.disabled=false, COOLDOWN); }
  btnToilet.addEventListener('click', ()=>{ cooldown(btnToilet); relief=clamp(relief+18); clean=clamp(clean+4); renderGauges(); persistGauges(); addPoints(2); });
  btnBath.addEventListener('click',   ()=>{ cooldown(btnBath);   clean=clamp(clean+22);                     renderGauges(); persistGauges(); addPoints(2); });
  btnPlay.addEventListener('click',   ()=>{ cooldown(btnPlay);   fun=clamp(fun+18);                         renderGauges(); persistGauges(); addPoints(2); });

  // ===== 進化 =====
  function evolveToast(){ if(pts<THRESHOLD) return; toast.classList.add('show'); setTimeout(()=>{ location.href='macaron_select.html'; }, 900); }
  unlock.addEventListener('click', evolveToast);

  // ===== 起動 =====
  (function init(){
    refreshPoints(); moveNameTagRandom(); renderGauges(); requestAnimationFrame(tick);
  })();
</script>
</body>
</html>
