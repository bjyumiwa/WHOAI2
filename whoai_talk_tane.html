<!-- FILE: /WHOAI2/whoai_talk_tane.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>WhoAI | ã‚¿ãƒè¦³å¯Ÿï¼ˆãŠä¸–è©±ï¼‹ãƒã‚¤ãƒ³ãƒˆâ†’ãƒã‚«ãƒ­ãƒ³ï¼‰</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --glass: rgba(0,0,0,.35);
      --brd: rgba(255,255,255,.18);
      --ok: #86efac; --warn:#fde047; --bad:#fda4af;
      --accent:#7ac7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;overflow:hidden}
    body{
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
      background:#000 url("space_background.png") center/cover fixed no-repeat;
      display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px
    }

    /* ä¸Šéƒ¨æƒ…å ± */
    .chips{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center
    }
    .chip{
      background:var(--glass);backdrop-filter:blur(4px);
      border:1px solid var(--brd);padding:6px 10px;border-radius:999px;font-size:12px
    }

    .title{font-size:22px;font-weight:800;letter-spacing:.04em;margin-top:2px}
    .subtitle{font-size:12px;opacity:.9;margin-top:-4px}

    /* ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆã‚¯ãƒ©ã‚²ã®ã‚ˆã†ã«ãµã‚ãµã‚ï¼‰ */
    .stage{
      position:relative;
      width:min(92vw,520px);
      aspect-ratio:1/1;
      background:rgba(0,0,0,.25);
      border:1px solid var(--brd);
      border-radius:20px;
      display:flex;align-items:center;justify-content:center;overflow:hidden;
      animation:jelly 9s ease-in-out infinite;
      will-change:transform;
    }
    @keyframes jelly{
      0%{transform:translate(0,0) rotate(0deg)}
      25%{transform:translate(-4px,-6px) rotate(-0.6deg)}
      50%{transform:translate(4px,2px) rotate(0.6deg)}
      75%{transform:translate(-3px,4px) rotate(-0.4deg)}
      100%{transform:translate(0,0) rotate(0deg)}
    }

    .tane{
      position:relative;display:flex;flex-direction:column;align-items:center;gap:6px
    }
    .tane img{
      width:min(46vmin,220px);
      height:auto;
      filter:drop-shadow(0 8px 22px rgba(0,0,0,.5));
      user-select:none;transition:transform .2s ease
    }
    .pop{animation:pop .25s ease}
    @keyframes pop{0%{transform:scale(1)}60%{transform:scale(1.06)}100%{transform:scale(1)}}

    /* ãƒ¢ãƒã‚¤ãƒ«ã§ã•ã‚‰ã«å°ã•ã */
    @media (max-width:480px){
      .title{font-size:19px}
      .stage{width:min(94vw,380px)}
      .tane img{width:min(58vmin,160px)}
    }

    /* æ—§ï¼šå›ºå®šåãƒãƒƒã‚¸ã¯éè¡¨ç¤ºï¼ˆäº’æ›ç”¨ã«æ®‹ã™ï¼‰ */
    #char-name{display:none}

    /* æµ®éŠã™ã‚‹â€œåå‰ã‚¿ãƒƒãƒâ€ãƒãƒƒã‚¸ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã‚“å›è»¢ï¼‰ */
    .nameTag{
      position:absolute;left:50%;top:18%;transform:translate(-50%,-50%);
      padding:8px 14px;border-radius:12px;background:var(--glass);border:1px solid var(--brd);
      cursor:pointer;user-select:none;font-weight:800;z-index:6;box-shadow:0 6px 18px rgba(0,0,0,.35)
    }
    .spin{animation:spin 500ms ease both}
    @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

    /* ãƒã‚«ãƒ­ãƒ³è§£æ”¾ãƒãƒƒã‚¸ */
    #unlock{
      position:absolute;right:10px;top:10px;display:none;align-items:center;gap:6px;
      padding:8px 12px;border-radius:999px;background:var(--glass);border:1px solid var(--brd);
      cursor:pointer;z-index:5
    }
    #unlock:active{transform:translateY(1px)}

    /* ãƒã‚¤ãƒ³ãƒˆãƒãƒ¼ */
    .bar{position:relative;width:min(92vw,520px);height:12px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid var(--brd);overflow:hidden}
    .bar>i{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,var(--ok),#a7f3d0)}
    .barrow{display:flex;align-items:center;gap:8px}
    .pts{font-variant-numeric:tabular-nums;background:var(--glass);border:1px solid var(--brd);padding:6px 10px;border-radius:10px}

    /* ãŠä¸–è©±ãƒ‘ãƒãƒ«ï¼ˆãƒ¢ãƒã‚¤ãƒ«å°ã•ã‚ï¼‰ */
    .panel{
      position:fixed;left:50%;bottom:8px;transform:translateX(-50%);
      width:min(920px,96vw);display:grid;grid-template-columns:1fr;gap:8px;z-index:7
    }
    .care{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
    .btncare{
      background:var(--glass);border:1px solid var(--brd);color:#fff;border-radius:12px;
      padding:8px 12px;font-weight:800;cursor:pointer;font-size:14px
    }
    .btncare:disabled{opacity:.55;cursor:not-allowed}
    .gauges{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
    .gbar{position:relative;height:12px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid var(--brd);overflow:hidden}
    .gbar>span{position:absolute;left:0;top:0;bottom:0;width:50%;background:linear-gradient(90deg,#7ac7ff,#bfe6ff);transition:width .3s}
    .glbl{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:11px;text-shadow:0 1px 2px rgba(0,0,0,.4)}

    .nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .ghostbtn{background:var(--glass);border:1px solid var(--brd);color:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}

    /* é€²åŒ–ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:#0f1220;border:1px solid var(--brd);border-radius:16px;
      padding:14px 16px;z-index:50;display:none;box-shadow:0 18px 50px rgba(0,0,0,.5)
    }
    .toast.show{display:block;animation:pop .25s ease}
  </style>
</head>
<body>
  <div class="chips">
    <span class="chip">ğŸ‘¤ <span id="chipPlayer">ã‚ãªãŸ</span></span>
    <span class="chip">ğŸ¨ è‰²: <span id="chipColor">pink</span></span>
    <span class="chip">ğŸ€ ãƒ¢ãƒ¼ãƒ‰: ã‚¿ãƒè¦³å¯Ÿ</span>
  </div>
  <div class="title">ã‚¿ãƒã‚’è¦³å¯Ÿã—ã¦è‚²ã¦ã‚ˆã†</div>
  <div class="subtitle">â€œåå‰ã‚¿ãƒƒãƒâ€ã‚„ãŠä¸–è©±ã§ãƒã‚¤ãƒ³ãƒˆã‚’ãŸã‚ã‚‹ã¨ã€ãƒã‚«ãƒ­ãƒ³ãŒè§£æ”¾ã•ã‚Œã¦é€²åŒ–ã§ãã¾ã™</div>

  <div class="stage" id="stage">
    <div id="unlock">ğŸ¬ ãƒã‚«ãƒ­ãƒ³è§£æ”¾ï¼</div>
    <div class="tane">
      <img id="taneImg" alt="tane">
      <!-- äº’æ›ã®ãŸã‚æ®‹ã™ãŒéè¡¨ç¤º -->
      <div id="char-name" title="ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚¤ãƒ³ãƒˆ+1"></div>
    </div>
    <!-- æµ®éŠã™ã‚‹åå‰ã‚¿ãƒƒãƒ -->
    <div class="nameTag" id="nameTag" title="ã‚¿ãƒƒãƒã§ãƒã‚¤ãƒ³ãƒˆ+1"></div>
  </div>

  <div class="barrow" style="margin-top:10px">
    <div class="bar"><i id="bar"></i></div>
    <div class="pts">ãƒã‚¤ãƒ³ãƒˆ: <span id="pts">0</span> / <span id="th">15</span></div>
  </div>

  <div class="panel">
    <div class="care">
      <button class="btncare" id="btnToilet">ğŸš½ ãƒˆã‚¤ãƒ¬</button>
      <button class="btncare" id="btnBath">ğŸ› ãŠãµã‚</button>
      <button class="btncare" id="btnPlay">ğŸ² ã‚ãã¶</button>
    </div>
    <div class="gauges">
      <div class="gbar" id="gClean"><span></span><div class="glbl">ãã‚Œã„</div></div>
      <div class="gbar" id="gFun"><span></span><div class="glbl">ãŸã®ã—ã•</div></div>
      <div class="gbar" id="gRelief"><span></span><div class="glbl">ã‚¹ãƒƒã‚­ãƒª</div></div>
    </div>
  </div>

  <div class="nav" style="margin-top:6px">
    <button class="ghostbtn" onclick="location.href='color_pick.html'">ğŸ”„ è‰²ã‚’ãˆã‚‰ã³ç›´ã™</button>
    <button class="ghostbtn" onclick="location.href='index.html'">ğŸ  ãƒ›ãƒ¼ãƒ </button>
  </div>

  <div class="toast" id="toast">ãƒã‚¤ãƒ³ãƒˆãŒãŸã¾ã‚Šã¾ã—ãŸï¼<br/>ãƒã‚«ãƒ­ãƒ³é¸æŠã¸é€²ã¿ã¾ã™â€¦</div>

<script>
  // ===== èª­ã¿å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼ =====
  const read = (k, d='') => { const v = localStorage.getItem(k); return (v===null||v==='undefined'||v==='null')? d : v; };

  // è¨­å®šãƒ»åˆæœŸå€¤ï¼ˆæ—¢å­˜ã‚­ãƒ¼äº’æ›ï¼‰
  const PLAYER_NAME = read('PLAYER_NAME', read('whoai_player_name', 'ã‚ãªãŸ'));
  const CHAR_NAME   = read('CHAR_NAME',   read('whoai_name', 'ã‚¿ãƒ'));
  const COLOR       = (read('macaronColor','pink')||'pink').toLowerCase(); // pink/green/blue/purple
  const THRESHOLD   = Number(read('TANE_POINTS_TO_EVOLVE','15')); // æ—¢å­˜ã—ãã„å€¤
  let pts           = Number(read('tanePoints','0'));             // æ—¢å­˜ãƒã‚¤ãƒ³ãƒˆã‚­ãƒ¼

  // HUD
  chipPlayer.textContent = PLAYER_NAME;
  chipColor.textContent  = COLOR;
  document.getElementById('th').textContent = THRESHOLD;

  // ã‚­ãƒ£ãƒ©ç”»åƒï¼štane_{color}.pngï¼ˆç”¨æ„ã•ã‚Œã¦ã„ã‚‹4è‰²ï¼‰
  (function setTaneSrc(){
    const file = `tane_${COLOR}.png`;  // tane_pink/green/blue/purple.png
    const img = document.getElementById('taneImg');
    const t = new Image();
    t.onload = ()=> (img.src = file);
    t.onerror = ()=> (img.src = 'tane_pink.png'); // å¿µã®ãŸã‚
    t.src = file;
  })();

  // ===== ãƒã‚¤ãƒ³ãƒˆï¼†ãƒãƒ¼ =====
  const ptsEl   = document.getElementById('pts');
  const barFill = document.getElementById('bar');
  const unlock  = document.getElementById('unlock');

  function refreshPoints(){
    ptsEl.textContent = String(pts);
    const ratio = Math.max(0, Math.min(1, pts / THRESHOLD));
    barFill.style.width = `${ratio*100}%`;
    barFill.style.background = ratio>0.66? 'linear-gradient(90deg,var(--ok),#a7f3d0)'
                              : ratio>0.33? 'linear-gradient(90deg,var(--warn),#fde68a)'
                                           : 'linear-gradient(90deg,var(--bad),#fecaca)';
    unlock.style.display = (pts >= THRESHOLD) ? 'inline-flex' : 'none';
  }

  // ===== åå‰ã‚¿ãƒƒãƒï¼ˆãã‚‹ã‚“å›è»¢ï¼‹ãƒã‚¤ãƒ³ãƒˆï¼‰ =====
  const nameTag = document.getElementById('nameTag');
  nameTag.textContent = CHAR_NAME;

  function moveNameTagRandom(){
    const pad = 36, avoidBottom = 170; // ç«¯ï¼†ä¸‹ãƒ‘ãƒãƒ«å›é¿ï¼ˆãƒ¢ãƒã‚¤ãƒ«å°ã•ã‚æƒ³å®šï¼‰
    const W = window.innerWidth, H = window.innerHeight;
    const x = Math.random() * (W - pad*2) + pad;
    const y = Math.random() * (H - pad*2 - avoidBottom) + pad;
    nameTag.style.left = `${x}px`;
    nameTag.style.top  = `${y}px`;
    nameTag.style.transform = 'translate(-50%,-50%)';
  }
  function addPoints(n=1){
    pts += n;
    localStorage.setItem('tanePoints', String(pts)); // æ—¢å­˜ã‚­ãƒ¼ã«ä¿å­˜
    refreshPoints();
    popChar();
    if(pts >= THRESHOLD){ evolveToast(); }
  }
  nameTag.addEventListener('click', ()=>{
    // ãã‚‹ã‚“å›è»¢
    nameTag.classList.remove('spin'); // é€£æ‰“å¯¾å¿œ
    void nameTag.offsetWidth;         // reflow
    nameTag.classList.add('spin');

    addPoints(1);
    moveNameTagRandom();
  });

  // Enterã‚­ãƒ¼ã§ã‚‚åŠ ç‚¹
  document.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addPoints(1); } });

  function popChar(){
    const img = document.getElementById('taneImg');
    img.classList.add('pop');
    setTimeout(()=>img.classList.remove('pop'), 250);
  }

  // ===== ãŠä¸–è©±ï¼šã‚²ãƒ¼ã‚¸ç®¡ç† =====
  const SKEY = { clean:'taneClean', fun:'taneFun', relief:'taneRelief', last:'taneLastTick' };
  let clean  = Number(localStorage.getItem(SKEY.clean)  ?? 70);
  let fun    = Number(localStorage.getItem(SKEY.fun)    ?? 70);
  let relief = Number(localStorage.getItem(SKEY.relief) ?? 70);
  let lastTick = Number(localStorage.getItem(SKEY.last) ?? Date.now());

  const gClean  = document.getElementById('gClean');
  const gFun    = document.getElementById('gFun');
  const gRelief = document.getElementById('gRelief');

  const DECAY_MS = 2500;  // æ¸›è¡°é–“éš”
  const DECAY    = 1;     // æ¸›è¡°é‡/ tick
  const COOLDOWN = 1200;  // ãƒ¢ãƒã‚¤ãƒ«å¯„ã‚Šã«çŸ­ç¸®

  function clamp(v){ return Math.max(0, Math.min(100, v)); }
  function setGauge(el, val){
    const span = el.querySelector('span');
    val = clamp(val);
    span.style.width = `${val}%`;
    span.style.background = val>=66
      ? 'linear-gradient(90deg,#8EE6A2,#c9f9d6)'
      : val>=33
      ? 'linear-gradient(90deg,#FFD36E,#ffe4a8)'
      : 'linear-gradient(90deg,#FF8A8A,#ffc2c2)';
  }
  function renderGauges(){
    setGauge(gClean,  clean);
    setGauge(gFun,    fun);
    setGauge(gRelief, relief);
  }
  function persistGauges(){
    localStorage.setItem(SKEY.clean,  clean);
    localStorage.setItem(SKEY.fun,    fun);
    localStorage.setItem(SKEY.relief, relief);
    localStorage.setItem(SKEY.last,   Date.now());
  }
  function tick(){
    const now = Date.now();
    if(now - lastTick >= DECAY_MS){
      clean  = clamp(clean  - DECAY);
      fun    = clamp(fun    - DECAY);
      relief = clamp(relief - DECAY);
      lastTick = now;
      renderGauges(); persistGauges();
    }
    requestAnimationFrame(tick);
  }

  // ãŠä¸–è©±ãƒœã‚¿ãƒ³
  const btnToilet = document.getElementById('btnToilet');
  const btnBath   = document.getElementById('btnBath');
  const btnPlay   = document.getElementById('btnPlay');

  function cooldown(btn){ btn.disabled = true; setTimeout(()=>btn.disabled=false, COOLDOWN); }
  btnToilet.addEventListener('click', ()=>{
    cooldown(btnToilet);
    relief = clamp(relief + 18);
    clean  = clamp(clean + 4);
    renderGauges(); persistGauges();
    addPoints(2);
  });
  btnBath.addEventListener('click', ()=>{
    cooldown(btnBath);
    clean = clamp(clean + 22);
    renderGauges(); persistGauges();
    addPoints(2);
  });
  btnPlay.addEventListener('click', ()=>{
    cooldown(btnPlay);
    fun = clamp(fun + 18);
    renderGauges(); persistGauges();
    addPoints(2);
  });

  // ===== é€²åŒ– =====
  const toast = document.getElementById('toast');
  function evolveToast(){
    if(pts < THRESHOLD) return;
    toast.classList.add('show');
    setTimeout(()=>{ location.href = 'macaron_select.html'; }, 900);
  }
  document.getElementById('unlock').addEventListener('click', evolveToast);

  // ===== èµ·å‹• =====
  function init(){
    document.getElementById('chipPlayer').textContent = PLAYER_NAME;
    document.getElementById('chipColor').textContent  = COLOR;

    refreshPoints();
    moveNameTagRandom();
    renderGauges();
    requestAnimationFrame(tick);
  }
  init();
</script>
</body>
</html>
