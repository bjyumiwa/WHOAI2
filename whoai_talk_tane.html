<!-- FILE: /WHOAI2/whoai_talk_tane.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhoAI | 会話（タネ）＋音符収集：ハッピーバースデー</title>
<meta name="color-scheme" content="dark light" />
<style>
  /* ====== Base ====== */
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;background:#000;
    background-image:url("space_background.png"); /* 仕様：ルート直下参照 */
    background-size:cover;background-position:center;background-attachment:fixed;
  }
  .wrap{
    min-height:100%;display:flex;flex-direction:column;
    backdrop-filter:saturate(110%) blur(0px);
  }
  header{
    display:flex;align-items:center;gap:10px;
    padding:10px 14px;background:rgba(0,0,0,.32);border-bottom:1px solid rgba(255,255,255,.15)
  }
  .badge{
    background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.25);
    padding:.25rem .6rem;border-radius:999px;font-size:12px
  }
  main{flex:1;display:grid;grid-template-rows:1fr auto;row-gap:10px}
  /* ====== Chat tiny UI ====== */
  .chat{
    width:min(1000px,92vw);margin:16px auto 0;display:grid;grid-template-columns:1fr;gap:10px
  }
  .stage{
    position:relative;min-height:46vh;border-radius:20px;
    border:1px solid rgba(255,255,255,.18);
    background:linear-gradient(180deg,rgba(0,0,0,.22),rgba(0,0,0,.35));
    overflow:hidden
  }
  .bubble{
    max-width:min(70ch,86%);padding:.7rem .9rem;border-radius:14px;margin:10px;
    background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.22)
  }
  .me{justify-self:end;background:rgba(255,255,255,.18)}
  .inputRow{
    width:min(1000px,92vw);margin:0 auto 16px;display:grid;grid-template-columns:1fr auto;gap:8px
  }
  input[type="text"]{
    border-radius:12px;border:1px solid rgba(255,255,255,.22);background:rgba(0,0,0,.35);
    padding:.8rem .9rem;color:#fff
  }
  button{
    padding:.8rem 1.1rem;border-radius:12px;border:0;cursor:pointer;font-weight:800
  }
  .primary{background:#f7b0bf;color:#222}
  .ghost{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.22)}

  /* ====== poo / note ====== */
  .poo {
    position:absolute;z-index:40;cursor:pointer;user-select:none;
    font-size:clamp(28px,4vw,42px);
    filter:drop-shadow(0 4px 10px rgba(0,0,0,.35));
  }
  .note-float{
    position:fixed;z-index:60;pointer-events:none;
    font-size:clamp(20px,3vw,30px);
    animation:noteFloat 1.2s ease-out forwards;
  }
  @keyframes noteFloat{
    0%{transform:translateY(0) scale(1);opacity:0}
    10%{opacity:1}
    100%{transform:translateY(-120px) scale(1.2);opacity:0}
  }

  /* ====== collection modal ====== */
  #openCollectBtn{
    position:fixed;right:16px;bottom:16px;z-index:70;
    width:56px;height:56px;border-radius:50%;
    background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);
    color:#fff;font-weight:900;font-size:22px;cursor:pointer;backdrop-filter:blur(6px)
  }
  #songModal{position:fixed;inset:0;z-index:80;display:none;background:rgba(0,0,0,.45)}
  #songSheet{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(92vw,720px);max-height:82vh;overflow:auto;
    background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.25);
    border-radius:16px;padding:16px 16px 20px;backdrop-filter:blur(8px)
  }
  #songSheet h3{margin:0 0 6px}
  .score-row{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:8px 0 12px}
  .note-cell{
    min-width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;
    font-weight:800;letter-spacing:.02em;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2)
  }
  .note-cell.filled{background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.35)}
  .legend{font-size:13px;opacity:.95;margin:6px 0}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .modal-actions .ghost{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.22)}
  .modal-actions .primary{background:#f7b0bf;color:#222}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="badge">タネ会話</div>
    <div class="badge">🎂 ハッピーバースデーを完成させよう</div>
    <div class="badge">💩10回＝「ド」1つ</div>
  </header>

  <main>
    <!-- 観察＋お世話ステージ（💩が湧く） -->
    <section class="chat">
      <div class="stage" id="stage">
        <div class="bubble">やぁ！話しかけたり、お世話をしてくれると、音符が集まるよ♪</div>
      </div>

      <!-- 入力列（Enterで送信→音符が1つ進む） -->
      <div class="inputRow">
        <input id="msg" type="text" placeholder="メッセージを入力（Enterで送信）" />
        <button id="sendBtn" class="primary">送信</button>
      </div>
    </section>
  </main>
</div>

<!-- ♪ コレクション（右下ボタン） -->
<button id="openCollectBtn" title="音符コレクション">♪</button>

<!-- ♪ コレクション・モーダル -->
<div id="songModal" aria-hidden="true">
  <div id="songSheet" role="dialog" aria-label="音符コレクション">
    <h3>🎂 ハッピーバースデー（フル：4フレーズ）</h3>
    <div id="scoreRow" class="score-row"></div>
    <div id="noteSummary" class="legend"></div>
    <div class="modal-actions">
      <button class="ghost" id="resetSongBtn">やり直す</button>
      <button class="primary" id="closeCollectBtn">とじる</button>
    </div>
  </div>
</div>

<script>
/* ===============================
   🎵 Happy Birthday (Full) Setup
   ===============================

   調：C（ハ長調）
   ソ ソ ラ ソ ド シ |
   ソ ソ ラ ソ レ ド |
   ソ ソ ソ ミ ド シ ラ |
   ファ ファ ミ ド レ ド
*/
const SONGS = {
  birthday_full: [
    "ソ","ソ","ラ","ソ","ド","シ",
    "ソ","ソ","ラ","ソ","レ","ド",
    "ソ","ソ","ソ","ミ","ド","シ","ラ",
    "ファ","ファ","ミ","ド","レ","ド"
  ]
};
let currentSong = 'birthday_full';

/* ===== 永続化キー ===== */
const LS = {
  collected: 'whoai_notes_collected_full',
  poo:       'whoai_poo_count',
  ready:     'whoai_song_complete_full'
};

/* ===== 復元 ===== */
let collectedNotes = JSON.parse(localStorage.getItem(LS.collected) || '[]');
let pooCount = Number(localStorage.getItem(LS.poo) || 0);

/* ===== 参照 ===== */
const stage = document.getElementById('stage');
const msg   = document.getElementById('msg');
const sendBtn = document.getElementById('sendBtn');

const openCollectBtn  = document.getElementById('openCollect
