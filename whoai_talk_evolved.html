<!-- FILE: /whoai_talk_evolved.htmlï¼ˆé€²åŒ–å¾Œï¼‰
  è¿½åŠ : ã€Œãƒˆã‚¤ãƒ¬ã€ã€Œã‚ãã¶ã€ã‚±ã‚¢è¦ç´  + ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¿å­˜ï¼ˆlocalStorageï¼‰
  ç”»åƒãƒ«ãƒ¼ãƒ«: èƒŒæ™¯ã¯ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã® space_background.png ã‚’ä½¿ç”¨ã€‚
  ã‚­ãƒ£ãƒ©ç”»åƒ: {color}_open.png / {color}_closed.png ã‚’æƒ³å®šï¼ˆä¾‹: pink_open.pngï¼‰ã€‚
  â€»å­˜åœ¨ã—ãªã„å ´åˆã¯ tane_{color}.png ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¼šè©± | WhoAIï¼ˆé€²åŒ–å¾Œãƒ»ã‚±ã‚¢ï¼‰</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    html,body{height:100%;margin:0;overflow:hidden}
    body{
      position:relative;
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
      background:#000 url("space_background.png") center/cover fixed no-repeat;
    }

    /* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
    .hud{position:fixed;left:50%;top:10px;transform:translateX(-50%);display:flex;gap:8px;flex-wrap:wrap;z-index:50}
    .chip{background:rgba(0,0,0,.35);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px;font-size:12px}

    .stage{position:absolute;inset:64px 12px 148px;/* ä¸Š,å·¦å³,ä¸‹ */
      border-radius:24px;border:1px solid rgba(255,255,255,.16);
      background:radial-gradient(120% 120% at 50% 10%, rgba(255,255,255,.04), rgba(0,0,0,.35));
      overflow:hidden;isolation:isolate
    }

    /* ã‚­ãƒ£ãƒ© */
    .avatar{position:absolute;left:50%;top:50%;translate:-50% -50%;width:min(40vmin,320px);aspect-ratio:1/1;image-rendering:auto;filter:drop-shadow(0 8px 24px rgba(0,0,0,.5));
      transition:transform .2s ease}
    .float{animation:float 6s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(-2%)}50%{transform:translateY(2%)}}

    /* ğŸ’© è¡¨ç¤º */
    .poo{position:absolute;font-size:clamp(28px,4vmin,42px);filter:drop-shadow(0 2px 4px rgba(0,0,0,.6));cursor:pointer;user-select:none}

    /* å¹ãå‡ºã— */
    .bubble{position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);max-width:min(70vw,520px);
      background:rgba(0,0,0,.65);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.25);
      padding:8px 12px;border-radius:12px;font-size:14px;line-height:1.5;opacity:0;translate:0 6px;
      transition:opacity .2s, translate .2s}
    .bubble.show{opacity:1;translate:0 0}

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‰ãƒƒã‚¯ */
    .dock{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);z-index:60;width:min(960px,94vw)}
    .panel{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;background:rgba(0,0,0,.35);backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:10px}
    .btn{display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer;user-select:none;
      border:1px solid rgba(255,255,255,.25);border-radius:12px;padding:12px 10px;font-weight:700;font-size:16px;
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(0,0,0,.06));
      transition:transform .05s ease, background .2s}
    .btn:active{transform:translateY(2px)}
    .btn .emoji{font-size:22px}

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
    .bars{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}
    .bar{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:12px;overflow:hidden}
    .bar b{display:flex;align-items:center;gap:6px;font-size:12px;padding:6px 8px}
    .bar .track{height:8px;background:rgba(255,255,255,.08)}
    .bar .fill{height:100%;width:0%;background:linear-gradient(90deg,rgba(255,255,255,.85),rgba(255,255,255,.45))}

    /* ãƒãƒ£ãƒƒãƒˆï¼ˆç°¡æ˜“ï¼‰ */
    .chat{position:absolute;right:10px;bottom:10px;display:flex;gap:6px;z-index:45}
    .chat input{width:min(46vw,400px);padding:10px;border-radius:999px;border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.4);backdrop-filter:blur(4px);color:#fff}
    .chat button{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.4);color:#fff;cursor:pointer}

    /* ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
    @media (max-width:760px){
      .panel{grid-template-columns:1fr}
      .chat{left:50%;right:auto;transform:translateX(-50%)}
    }
  </style>
</head>
<body>
  <!-- HUD / åå‰ãªã© -->
  <div class="hud" id="hud">
    <div class="chip" id="chipUser">ã‚ãªãŸï¼š-</div>
    <div class="chip" id="chipChar">ã‚­ãƒ£ãƒ©ï¼š-</div>
    <div class="chip" id="chipColor">è‰²ï¼špink</div>
    <div class="chip">é€²åŒ–å¾Œ</div>
  </div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ / ã‚­ãƒ£ãƒ©ãƒ»å¹ãå‡ºã—ãƒ»ğŸ’© -->
  <div class="stage" id="stage">
    <img id="avatar" class="avatar float" alt="character" />
    <div id="bubble" class="bubble" aria-live="polite"></div>
    <!-- ğŸ’© ã¯ JS ã§è¿½åŠ /å‰Šé™¤ -->
  </div>

  <!-- å…¥åŠ›ï¼ˆç°¡æ˜“ãƒãƒ£ãƒƒãƒˆã€‚Enteré€ä¿¡ï¼‰-->
  <div class="chat">
    <input id="chatInput" type="text" placeholder="è©±ã—ã‹ã‘ã‚‹ï¼ˆEnterã§é€ä¿¡ï¼‰" />
    <button id="chatSend">é€ä¿¡</button>
  </div>

  <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‰ãƒƒã‚¯ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ + ãƒœã‚¿ãƒ³ï¼‰-->
  <div class="dock">
    <div class="bars">
      <div class="bar"><b>ãã‚Œã„ã•</b><div class="track"><div class="fill" id="barClean"></div></div></div>
      <div class="bar"><b>ãŸã®ã—ã•</b><div class="track"><div class="fill" id="barFun"></div></div></div>
      <div class="bar"><b>ã’ã‚“ã</b><div class="track"><div class="fill" id="barEnergy"></div></div></div>
    </div>
    <div class="panel">
      <div class="btn" id="btnToilet" title="ãƒˆã‚¤ãƒ¬ã«é€£ã‚Œã¦ã„ã"><span class="emoji">ğŸš½</span>ãƒˆã‚¤ãƒ¬</div>
      <div class="btn" id="btnPlay" title="ã„ã£ã—ã‚‡ã«éŠã¶"><span class="emoji">ğŸ®</span>ã‚ãã¶</div>
    </div>
  </div>

  <script>
  ;(() => {
    // ====== è¨­å®šãƒ»ä¿å­˜ç³» ======
    const LS_KEYS = {
      state: 'whoai.evolved.care.state',
      user: 'your_name',            // ã‚ãªãŸã®åå‰ï¼ˆæ—¢å­˜ä»•æ§˜ã«åˆã‚ã›ã¦ï¼‰
      char: 'char_name',            // ã‚­ãƒ£ãƒ©ã®åå‰
      color: 'macaron_color',       // é¸æŠè‰²ï¼ˆpink/blue/green/purple...ï¼‰
      talkEndpoint: 'TALK_ENDPOINT' // æ—¢å­˜ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ localStorage ã‹ã‚‰èª­ã‚€
    }

    const DEFAULTS = {
      clean: 80, fun: 70, energy: 80, waste: 0, // waste: 0-100 ï¼ˆğŸ’©é‡ï¼‰
      lastTs: Date.now()
    }

    const $ = (sel) => document.querySelector(sel)
    const stage = $('#stage')
    const avatar = $('#avatar')
    const bubble = $('#bubble')

    const barClean = $('#barClean')
    const barFun = $('#barFun')
    const barEnergy = $('#barEnergy')

    const chipUser = $('#chipUser')
    const chipChar = $('#chipChar')
    const chipColor = $('#chipColor')

    const btnToilet = $('#btnToilet')
    const btnPlay = $('#btnPlay')

    const chatInput = $('#chatInput')
    const chatSend = $('#chatSend')

    // åå‰ãƒ»è‰²ã®èª­è¾¼
    const userName = localStorage.getItem(LS_KEYS.user) || 'ã‚ãªãŸ'
    const charName = localStorage.getItem(LS_KEYS.char) || 'ãƒã‚«ãƒ­ãƒ³'
    const color = (localStorage.getItem(LS_KEYS.color) || 'pink').toLowerCase()

    chipUser.textContent = `ã‚ãªãŸï¼š${userName}`
    chipChar.textContent = `ã‚­ãƒ£ãƒ©ï¼š${charName}`
    chipColor.textContent = `è‰²ï¼š${color}`

    // ---- ç”»åƒãƒ­ãƒ¼ãƒ€ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ----
    const srcCandidates = [
      `${color}_open.png`,
      `public/assets/stage2/${color}_open.png`,
      `public/assets/stage1/${color}_open.png`,
      `tane_${color}.png`
    ]
    const srcCandidatesClosed = [
      `${color}_closed.png`,
      `public/assets/stage2/${color}_closed.png`,
      `public/assets/stage1/${color}_closed.png`,
      `tane_${color}.png`
    ]

    let imgOpen = null, imgClosed = null

    function loadWithFallback(candidates){
      return new Promise(resolve => {
        const tryNext = (i) => {
          if(i >= candidates.length){ resolve(null);return }
          const img = new Image()
          img.onload = () => resolve(candidates[i])
          img.onerror = () => tryNext(i+1)
          img.src = candidates[i]
        }
        tryNext(0)
      })
    }

    async function prepareImages(){
      imgOpen = await loadWithFallback(srcCandidates)
      imgClosed = await loadWithFallback(srcCandidatesClosed)
      avatar.src = imgClosed || imgOpen || ''
    }

    // ====== çŠ¶æ…‹ã®ãƒ­ãƒ¼ãƒ‰ãƒ»ä¿å­˜ ======
    let state = DEFAULTS
    try{
      const saved = JSON.parse(localStorage.getItem(LS_KEYS.state) || 'null')
      if(saved){ state = { ...DEFAULTS, ...saved } }
    }catch{}

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŠ£åŒ–ï¼ˆå‰å›ã‹ã‚‰ã®çµŒéã§æ¸›è¡°ï¼‰
    const elapsedMin = Math.max(0, Math.floor((Date.now() - (state.lastTs||Date.now())) / 60000))
    if(elapsedMin > 0){
      // çµŒé1åˆ†ã”ã¨ã«å°‘ã—ãšã¤åŠ£åŒ–
      decay(Math.min(elapsedMin, 240)) // ä¸Šé™4æ™‚é–“ã¶ã‚“
    }

    function clamp(v){ return Math.max(0, Math.min(100, v)) }

    function save(){
      state.lastTs = Date.now()
      localStorage.setItem(LS_KEYS.state, JSON.stringify(state))
    }

    function updateBars(){
      barClean.style.width = clamp(state.clean) + '%'
      barFun.style.width = clamp(state.fun) + '%'
      barEnergy.style.width = clamp(state.energy) + '%'
    }

    function say(text){
      bubble.textContent = text
      bubble.classList.add('show')
      clearTimeout(say._t)
      say._t = setTimeout(()=> bubble.classList.remove('show'), 2400)
    }

    // ğŸ’© ã®è¡¨ç¤ºãƒ»ç®¡ç†
    function ensurePoo(){
      // waste 60 ä»¥ä¸Šã§ 1ã€œ3 å€‹ã¾ã§å‡ºç¾
      const existing = stage.querySelectorAll('.poo').length
      if(state.waste >= 60 && existing === 0){ addPoo() }
      if(state.waste < 60){ stage.querySelectorAll('.poo').forEach(e=>e.remove()) }
    }

    function addPoo(){
      const e = document.createElement('div')
      e.className = 'poo'
      e.textContent = 'ğŸ’©'
      // ã‚¹ãƒ†ãƒ¼ã‚¸å†…ã®ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®
      const rect = stage.getBoundingClientRect()
      const x = Math.random()*(rect.width-40)+20
      const y = Math.random()*(rect.height-80)+40
      e.style.left = x + 'px'
      e.style.top = y + 'px'
      e.addEventListener('click', () => {
        // ç›´æ¥ç‰‡ä»˜ã‘ã¦ã‚‚ OKï¼ˆãã‚Œã„ã• +5ï¼‰
        state.waste = clamp(state.waste - 40)
        state.clean = clamp(state.clean + 5)
        e.remove(); persistAndRefresh(); say('ãŠãã†ã˜ã€ã‚ã‚ŠãŒã¨ã†ï¼')
      })
      stage.appendChild(e)
    }

    function persistAndRefresh(){ save(); updateBars(); ensurePoo() }

    // ====== åŠ£åŒ–ï¼ˆ30ç§’ã”ã¨ï¼‰ ======
    function tick(){
      // 30 ç§’ã”ã¨ã«å°‘ã—ã ã‘åŠ£åŒ–
      decay(1) // 1å˜ä½=30ç§’
      persistAndRefresh()
      mood()
    }

    function decay(units){
      // å˜ä½ã‚ãŸã‚Š:
      // ãƒ»ãŸã®ã—ã• -0.6, ã’ã‚“ã -0.5, ãã‚Œã„ã• -0.4
      // ãƒ»waste +0.8ï¼ˆä¸€å®šä»¥ä¸Šã§ğŸ’©ï¼‰
      state.fun = clamp(state.fun - 0.6*units)
      state.energy = clamp(state.energy - 0.5*units)
      state.clean = clamp(state.clean - 0.4*units)
      state.waste = clamp(state.waste + 0.8*units)
    }

    function mood(){
      if(state.clean < 25) say('ã†ã…â€¦ã¡ã‚‡ã£ã¨ãã•ã„ã‹ã‚‚â€¦')
      else if(state.fun < 25) say('ãŸã„ãã¤â€¦ã‚ãã¼ã†ï¼Ÿ')
      else if(state.energy < 20) say('ã­ã‚€ã„â€¦ã¡ã‚‡ã£ã¨ä¼‘ã¿ãŸã„ãª')
    }

    // ====== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ======
    btnToilet.addEventListener('click', () => {
      if(state.waste <= 10){
        say('ã„ã¾ã¯å¤§ä¸ˆå¤«ï¼')
        // å¤–ã—ãŸå ´åˆã¯å°‘ã—ã ã‘ clean å›å¾©
        state.clean = clamp(state.clean + 2)
      }else{
        state.waste = clamp(state.waste - 60)
        state.clean = clamp(state.clean + 12)
        state.energy = clamp(state.energy + 4)
        stage.querySelectorAll('.poo').forEach(e=>e.remove())
        say('ã™ã£ãã‚Šï¼')
      }
      persistAndRefresh()
    })

    btnPlay.addEventListener('click', () => {
      // ã‚ãã¶: ãŸã®ã—ã•â†‘ ã‚¨ãƒãƒ«ã‚®ãƒ¼â†“ ãŸã¾ã«ğŸ’©èª˜ç™º
      state.fun = clamp(state.fun + 14)
      state.energy = clamp(state.energy - 6)
      if(Math.random()<0.35){ state.waste = clamp(state.waste + 10) }
      // è¦–è¦šåŠ¹æœï¼ˆå°ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰
      avatar.style.transform = 'scale(1.04)'
      setTimeout(()=> avatar.style.transform = '', 160)
      say('ã‚ãƒ¼ã„ï¼')
      persistAndRefresh()
    })

    // ====== ç°¡æ˜“ãƒãƒ£ãƒƒãƒˆï¼ˆæ—¢å­˜ TALK_ENDPOINT ã«å¯¾å¿œï¼‰ ======
    async function sendChat(msg){
      if(!msg) return
      const endpoint = localStorage.getItem(LS_KEYS.talkEndpoint)
      if(endpoint){
        try{
          const res = await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg, name:userName, char:charName, color})})
          const data = await res.json().catch(()=>null)
          say((data && (data.reply||data.message)) || 'â€¦')
        }catch{
          say('ï¼ˆé€šä¿¡ã§ããªã‹ã£ãŸâ€¦ï¼‰')
        }
      }else{
        // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæœªè¨­å®šæ™‚ã¯ç°¡æ˜“ã‚¨ã‚³ãƒ¼
        say(`ã€Œ${msg}ã€â€¦ãµã‚€ãµã‚€ï¼`)
      }
      // è©±ã™é–“ã¯å£ãƒ‘ã‚¯
      mouthOpen(900)
    }

    chatSend.addEventListener('click', ()=>{
      const v = chatInput.value.trim(); if(!v) return; chatInput.value=''; sendChat(v)
    })
    chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); chatSend.click() } })

    // ====== å£ãƒ‘ã‚¯åˆ¶å¾¡ ======
    let mouthTimer = null
    function mouthOpen(ms=900){
      if(imgOpen){ avatar.src = imgOpen }
      clearTimeout(mouthTimer)
      mouthTimer = setTimeout(()=>{ if(imgClosed){ avatar.src = imgClosed } }, ms)
    }

    // ====== ã‚†ã‚‹ã„ãƒ©ãƒ³ãƒ€ãƒ ç§»å‹•ï¼ˆXYï¼‰ ======
    function wander(){
      const r = stage.getBoundingClientRect()
      const ax = Math.random()*(r.width*0.6) + r.width*0.2
      const ay = Math.random()*(r.height*0.6) + r.height*0.2
      avatar.style.left = ax + 'px'
      avatar.style.top  = ay + 'px'
    }

    // ====== åˆæœŸåŒ– ======
    function init(){
      updateBars(); ensurePoo(); mood();
      setInterval(tick, 30000) // 30ç§’ã”ã¨ã«åŠ£åŒ–
      setInterval(()=> mouthOpen(400), 4200) // ãŸã¾ã«å£ã‚’é–‹ã‘ã‚‹
      setInterval(wander, 3800) // ã‚†ã‚‹ç§»å‹•
      persistAndRefresh()
    }

    prepareImages().then(init)

    // ã‚¯ãƒªãƒƒã‚¯ã§ãªã§ã‚‹ï¼ˆå°‘ã—å›å¾©ï¼‰
    avatar.addEventListener('click', ()=>{
      state.fun = clamp(state.fun + 3)
      state.energy = clamp(state.energy + 1)
      say('ãªã§ãªã§â€¦â™¡')
      mouthOpen(600)
      persistAndRefresh()
    })

  })()
  </script>
</body>
</html>
