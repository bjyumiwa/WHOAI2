<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhoAI | 観察シーン</title>
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
    background:#000 url("space_background.png") center/cover fixed no-repeat;
    display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px
  }

  .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .chip{background:rgba(0,0,0,.35);backdrop-filter:blur(3px);
        border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;font-size:12px}

  .stage{
    position:relative; width:min(980px,96vw); height:min(70vh,78vw);
    background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.2);
    border-radius:18px; overflow:hidden;
  }

  /* ガイド */
  .guide{
    position:absolute; left:12px; top:12px;
    background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.25);
    padding:6px 10px; border-radius:10px; font-size:12px; opacity:.95
  }

  /* キャラ（クリック時くるっと） */
  #char{
    position:absolute; left:50%; bottom:8px; transform:translateX(-50%);
    width:min(300px,62vw); height:auto; filter:drop-shadow(0 8px 22px rgba(0,0,0,.55))
  }
  .wiggle{ animation: wiggle .55s ease; }
  @keyframes wiggle{
    0%  { transform:translateX(-50%) rotate(0deg)   scale(1.00) }
    30% { transform:translateX(-50%) rotate(10deg)  scale(1.04) }
    60% { transform:translateX(-50%) rotate(-8deg)  scale(1.02) }
    100%{ transform:translateX(-50%) rotate(0deg)   scale(1.00) }
  }

  /* クリックしやすい “名前”（透明の大きい当たり判定） */
  .floatWrap{
    position:absolute; opacity:0; transition:opacity .35s ease, transform .18s ease;
    pointer-events:none;
  }
  .floatWrap.show{opacity:1; pointer-events:auto;}
  .hit{
    position:relative; display:inline-block; padding:18px 26px;
    background:transparent; border:none; outline:none; box-shadow:none;
    -webkit-tap-highlight-color:transparent;
  }
  #floatName{
    position:absolute; left:0; top:0; transform:translate(18px,12px);
    font-weight:900; font-size:clamp(18px,5vw,28px);
    text-shadow:0 4px 16px rgba(0,0,0,.45); user-select:none; pointer-events:none;
  }

  /* 名前の“エコー”たち（飾り） */
  .nameEcho{
    position:absolute; font-weight:800; opacity:.75; pointer-events:none;
    font-size:clamp(12px,3.5vw,18px); text-shadow:0 4px 16px rgba(0,0,0,.35);
    animation: floaty var(--dur,10s) ease-in-out infinite;
  }
  @keyframes floaty{
    0%{ transform:translate(0,0); opacity:.8 }
    50%{ transform:translate(10px,-14px); opacity:1 }
    100%{ transform:translate(0,0); opacity:.8 }
  }

  /* 短いセリフ（出て消える） */
  .phrase{
    position:absolute; opacity:0; transition:opacity .35s ease, transform .35s ease;
    font-weight:600; font-size:clamp(14px,4.5vw,22px); text-shadow:0 4px 16px rgba(0,0,0,.45);
    pointer-events:none;
  }
  .phrase.show{opacity:1}

  /* 下部操作 */
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .btn{
    padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:800;
    background:#ffd1ec; color:#222;
  }
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .btn-ghost{background:rgba(255,255,255,.14); color:#fff; border:1px solid rgba(255,255,255,.25)}
  .pop{animation: pop .18s ease}
  @keyframes pop{ 0%{transform:scale(1.02)} 100%{transform:scale(1)} }
</style>
</head>
<body>
  <div class="chips">
    <span class="chip">色: <span id="chipColor">-</span></span>
    <span class="chip">段階: evolved</span>
    <span class="chip">pts: <span id="pts">0</span> / 20</span>
  </div>

  <section class="stage" aria-label="観察シーン">
    <div class="guide">名前が出たらクリックしてね（+1pt）｜20ptで「マカロンを選ぶ」</div>

    <img id="char" alt="キャラクター">

    <!-- クリックしやすい名前（透明ヒット領域） -->
    <div id="nameWrap" class="floatWrap">
      <div id="nameHit" class="hit" role="button" aria-label="名前をクリックでポイント"></div>
      <div id="floatName">-</div>
    </div>

    <!-- 短いセリフ（1つずつ出て消える） -->
    <div id="phrase" class="phrase">……</div>

    <!-- 名前エコーたち（飾り） -->
    <div id="echoWrap"></div>
  </section>

  <div class="controls">
    <button class="btn-ghost" onclick="location.href='whoai_talk.html'">会話モードへ</button>
    <button id="btnMacaron" class="btn" disabled onclick="location.href='macaron_select.html'">マカロンを選ぶ</button>
    <button class="btn-ghost" onclick="resetPts()">ptsリセット</button>
  </div>

<script>
/* ===== ステート ===== */
const K = {
  name:"whoai_name", color:"macaronColor", color2:"whoai_color",
  stage:"whoai_stage", pts:"whoai_points", visits:"whoai_observe_visits"
};
const getName = ()=> localStorage.getItem(K.name) || "キャラ";
const getColor= ()=> (localStorage.getItem(K.color) || localStorage.getItem(K.color2) || "pink").toLowerCase();
const getPts  = ()=> parseInt(localStorage.getItem(K.pts) || "0",10);
const setPts  = (n)=> localStorage.setItem(K.pts, String(n));

/* ===== 観察シーン来訪回数でリセット（2回目以降） ===== */
(function manageVisits(){
  const v = parseInt(localStorage.getItem(K.visits) || "0", 10) + 1;
  localStorage.setItem(K.visits, String(v));
  if(v >= 2){ setPts(0); }   // ★ここでリセット
})();

/* ===== 画像（フォールバック） ===== */
function loadCharImage(imgEl, color){
  const cand = [`${color}_open.png`, `${color}_closed.png`, `pink_open.png`];
  (function tryNext(i){
    if(i>=cand.length){ imgEl.alt="画像が見つかりません"; return; }
    const p=cand[i], t=new Image();
    t.onload = ()=> imgEl.src=p;
    t.onerror= ()=> tryNext(i+1);
    t.src=p;
  })(0);
}

/* ===== ユーティリティ ===== */
const rand = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;
function place(el, leftMin,leftMax, topMin,topMax){
  el.style.left = rand(leftMin,leftMax) + '%';
  el.style.top  = rand(topMin, topMax) + '%';
}

/* ===== 名前（出たり消えたり・クリックで+1pt & キャラwiggle） ===== */
function cycleName(){
  const wrap = document.getElementById('nameWrap');
  wrap.classList.remove('show');
  setTimeout(()=>{
    place(wrap, 8,32, 8,28);      // 左上〜中央に出現
    wrap.classList.add('show');
    setTimeout(()=>wrap.classList.remove('show'), rand(1800,3200)); // 1.8〜3.2秒表示
  }, rand(900,1500));             // 1.0〜1.5秒休み
}

/* ===== セリフ（短い固定フレーズのみ） ===== */
const PHRASES = [
  "ここにいるよ","すき","ふわ…","むに","zzz","やっほー","ただいま","こっち",
  "ぱたぱた","hello","うとうと","みてる","だいじょうぶ","きら","ねぇ","すや…"
];
function cyclePhrase(){
  const el=document.getElementById('phrase');
  el.classList.remove('show');
  setTimeout(()=>{
    el.textContent = PHRASES[rand(0,PHRASES.length-1)];
    place(el, 54,80, 24,46);                 // 右側あたり
    el.style.transform = 'translateY(0)';
    el.classList.add('show');
    setTimeout(()=>{ el.style.transform='translateY(-10px)'; }, 400);
    setTimeout(()=>{ el.classList.remove('show'); }, rand(2200,3400));
  }, rand(800,1600));
}

/* ===== 名前エコー（いろんな名前がふわふわ） ===== */
function renderNameEchoes(base){
  const variants = Array.from(new Set([
    base,
    `${base}ちゃん`,
    `${base}さん`,
    `${base}*`,
    `.${base}`,
  ])).slice(0,5);

  const wrap = document.getElementById('echoWrap');
  wrap.innerHTML = "";
  variants.forEach(v=>{
    const d=document.createElement('div');
    d.className='nameEcho';
    d.textContent=v;
    d.style.left = rand(6, 88) + '%';
    d.style.top  = rand(18, 72) + '%';
    d.style.setProperty('--dur', (9 + Math.random()*4).toFixed(1)+'s');
    wrap.appendChild(d);
  });
}

/* ===== ポイント & ボタン ===== */
const THRESHOLD=20;
function refreshPtsUI(){
  const n=getPts();
  document.getElementById('pts').textContent=String(n);
  const btn=document.getElementById('btnMacaron');
  if(n>=THRESHOLD){ btn.disabled=false; btn.classList.add('pop'); setTimeout(()=>btn.classList.remove('pop'),220); }
  else{ btn.disabled=true; }
}
function resetPts(){ setPts(0); refreshPtsUI(); }

/* ===== 起動 ===== */
(function init(){
  const color=getColor();
  document.getElementById('chipColor').textContent=color;
  loadCharImage(document.getElementById('char'), color);

  const name=getName();
  document.getElementById('floatName').textContent=name;

  // クリックで +1 pt ＆ キャラwiggle
  document.getElementById('nameHit').onclick=()=>{
    const n=Math.min(getPts()+1,THRESHOLD);
    setPts(n); refreshPtsUI();
    const ch=document.getElementById('char');
    ch.classList.remove('wiggle'); void ch.offsetWidth; ch.classList.add('wiggle');
  };

  renderNameEchoes(name);
  refreshPtsUI();

  // ループ開始
  cycleName();   setInterval(cycleName,   3200);
  cyclePhrase(); setInterval(cyclePhrase, 3600);
})();
</script>
</body>
</html>
