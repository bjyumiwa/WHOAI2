<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- FILE: /whoai_talk_evolved.html (Observation mode after evolution â†’ rebirth.html) -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¦³å¯Ÿãƒ¢ãƒ¼ãƒ‰ | WhoAIï¼ˆé€²åŒ–å¾Œï¼‰</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{--glass:rgba(0,0,0,.45);--glass-strong:rgba(0,0,0,.6);--text:#fff;--accent:#8de0ff;--shadow:0 10px 40px rgba(0,0,0,.35);--radius:20px}
    html,body{height:100%;margin:0}
    body{font-family:"Noto Sans JP",system-ui,sans-serif;color:var(--text);background:#000 url("assets/stage1/space_background.png") center/cover fixed no-repeat;display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px}

    .topbar{position:fixed;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .badge{background:var(--glass);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);border-radius:14px;padding:8px 12px;box-shadow:var(--shadow);font-weight:700}
    .chips{display:flex;gap:8px;align-items:center}
    .chip{appearance:none;border:0;cursor:pointer;border-radius:999px;padding:6px 10px;font-weight:700;background:var(--glass);color:#fff}
    .chip[aria-pressed="true"]{outline:2px solid var(--accent)}

    main{margin-top:56px;display:grid;grid-template-columns:1fr;place-items:center;gap:12px;width:min(96vw,980px)}

    .stage{width:min(90vw,680px);aspect-ratio:1/1;border-radius:24px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.35);box-shadow:var(--shadow);display:grid;place-items:center;overflow:hidden}
    .stage img{width:85%;height:85%;object-fit:contain;animation:float 4.5s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

    .log{width:min(96vw,980px);max-height:40vh;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:10px}
    .bubble{align-self:center;max-width:720px;background:var(--glass);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:10px 14px}

    .controls{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .btn{appearance:none;border:0;cursor:pointer;border-radius:16px;padding:12px 16px;font-weight:900;background:linear-gradient(135deg,#9df,#fcf);color:#111;box-shadow:var(--shadow)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .meter{height:10px;width:min(96vw,420px);border-radius:999px;background:rgba(255,255,255,.15);overflow:hidden}
    .fill{height:100%;width:0;background:linear-gradient(90deg,#9df,#bdff9d);transition:width .35s ease}

    .note{font-size:12px;opacity:.85;text-align:center}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="badge" id="who">ã‚ãªãŸï¼šâ€” ï¼ ã‚­ãƒ£ãƒ©ï¼šâ€”ï¼ˆé€²åŒ–å¾Œï¼‰</div>
    <div class="chips" role="group" aria-label="Language Switch">
      <button class="chip" data-lang="ja" aria-pressed="true">æ—¥æœ¬èª</button>
      <button class="chip" data-lang="en">English</button>
      <button class="chip" data-lang="zh-CN">ç®€ä½“</button>
      <button class="chip" data-lang="zh-TW">ç¹é«”</button>
      <button class="chip" data-lang="ko">í•œêµ­ì–´</button>
    </div>
  </div>

  <main>
    <section class="stage" aria-live="polite">
      <img id="charImg" src="" alt="evolved character" />
    </section>

    <div class="meter" aria-label="XP">
      <div id="xpFill" class="fill"></div>
    </div>

    <section class="controls">
      <button id="feedBtn" class="btn">ğŸ¬ ãƒã‚«ãƒ­ãƒ³ã‚’ã‚ã’ã‚‹</button>
      <button id="restBtn" class="btn">ğŸ’¤ è¦³å¯Ÿã™ã‚‹ï¼ˆè‡ªå‹•ï¼‰</button>
    </section>

    <section id="log" class="log" aria-live="polite"></section>

    <p id="footNote" class="note">â€» è¦³å¯Ÿãƒ¢ãƒ¼ãƒ‰ã€‚ä¸€å®šã®XPã§ã€Œå¾©æ´»ã®å„€å¼ã€ã¸é€²ã¿ã¾ã™ï¼ˆåå‰å¤‰æ›´ or å§¿å¤‰æ›´ï¼‰ã€‚</p>
  </main>

  <script>
    // ===== Keys & i18n =====
    const KEY = {
      lang:  'whoai_lang',
      you:   'whoai_player_name',
      buddy: 'whoai_char_name',
      color: 'whoai_color',
      xp2:   'whoai_xp_evolved',   // é€²åŒ–å¾Œã®XPã¯åˆ¥ã‚«ã‚¦ãƒ³ã‚¿ã«
      log:   'whoai_log',
      stage: 'whoai_stage'
    };

    const I18N = {
      'ja': {
        feed: 'ğŸ¬ ãƒã‚«ãƒ­ãƒ³ã‚’ã‚ã’ã‚‹', rest: 'ğŸ’¤ è¦³å¯Ÿã™ã‚‹ï¼ˆè‡ªå‹•ï¼‰',
        lines: [
          'â€¦ ã•ã£ãã‚ˆã‚Šã‚­ãƒ©ã‚­ãƒ©ã—ã¦ã‚‹',
          'ãµã‚ã£ï¼ˆé€²åŒ–ã®ä½™éŸ»ï¼‰',
          'ï¼ˆã‚ãªãŸã®æ‰‹å…ƒã‚’è¦‹ã¦ã„ã‚‹ï¼‰',
          'ãã‚‹ã‚Šâ€”',
          'ã™ã‚„â€¦ã§ã‚‚è€³ã¯ã´ãã‚Š'
        ],
        react: ['ãã‚…ã‚“ï¼','ã±ã¡ã±ã¡ï¼','ãã‚‹ã‚“ï¼','ã«ã£ã“ã‚Š'],
        evoReady: 'å„€å¼ã®æ°—é…â€¦ï¼ˆã‚‚ã†å°‘ã—ã§æ¬¡ã®é¸æŠã¸ï¼‰',
        evoGo: 'æº–å‚™å®Œäº†ï¼ ã€Œå¾©æ´»ã®å„€å¼ã€ã«é€²ã¿ã¾ã™ã€‚'
      },
      'en': {
        feed: 'ğŸ¬ Give a macaron', rest: 'ğŸ’¤ Observe (auto)',
        lines: ['â€¦shinier than before','floating (afterglow)','(watching your hands)','twirlâ€”','dozing, ears twitch'],
        react: ['spark!','clap clap!','spin!','smile'],
        evoReady: 'The ritual draws nearâ€¦',
        evoGo: 'Ready! Heading to the ritual.'
      }
    };

    function r(a){return a[Math.floor(Math.random()*a.length)]}

    const chips=[...document.querySelectorAll('.chip')];
    const who=document.getElementById('who');
    const img=document.getElementById('charImg');
    const logEl=document.getElementById('log');
    const feedBtn=document.getElementById('feedBtn');
    const restBtn=document.getElementById('restBtn');
    const xpFill=document.getElementById('xpFill');
    const foot=document.getElementById('footNote');

    function detectLang(){
      const saved=localStorage.getItem(KEY.lang); if(saved && I18N[saved]) return saved;
      const nav=(navigator.language||'ja').toLowerCase();
      if(nav.startsWith('en')) return 'en';
      return 'ja';
    }

    let lang = detectLang();
    function applyLang(newLang){
      lang=newLang; localStorage.setItem(KEY.lang, lang);
      feedBtn.textContent = I18N[lang].feed; restBtn.textContent = I18N[lang].rest; foot.textContent = lang==='ja'? 'â€» è¦³å¯Ÿãƒ¢ãƒ¼ãƒ‰ã€‚ä¸€å®šã®XPã§ã€Œå¾©æ´»ã®å„€å¼ã€ã¸é€²ã¿ã¾ã™ï¼ˆåå‰å¤‰æ›´ or å§¿å¤‰æ›´ï¼‰ã€‚' : 'Observation mode. Reaches the ritual at certain XP (rename or change appearance).';
      chips.forEach(ch=>ch.setAttribute('aria-pressed',String(ch.dataset.lang===lang)));
    }
    chips.forEach(ch=>ch.addEventListener('click',()=>applyLang(ch.dataset.lang)));
    applyLang(lang);

    // Names & header
    const you = localStorage.getItem(KEY.you)||'â€”';
    const buddy = localStorage.getItem(KEY.buddy)||'â€”';
    who.textContent = `ã‚ãªãŸï¼š${you} ï¼ ã‚­ãƒ£ãƒ©ï¼š${buddy}ï¼ˆé€²åŒ–å¾Œï¼‰`;

    // Stage & assets
    localStorage.setItem(KEY.stage,'evolved');
    const color = localStorage.getItem(KEY.color)||'pink';
    const imgPath = `assets/stage2/tane_${color}.png`; // é€²åŒ–å¾Œã‚‚å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«é‹ç”¨
    img.src = imgPath;

    // XP (é€²åŒ–å¾Œç”¨ã«åˆ¥ã‚­ãƒ¼)
    let xp = parseInt(localStorage.getItem(KEY.xp2) ?? '0', 10);
    const XP_TO_RITUAL = 10; // â˜…é€²åŒ–å¾Œãƒ•ã‚§ãƒ¼ã‚ºã®é–¾å€¤ï¼ˆå¿…è¦ãªã‚‰å¤‰æ›´ï¼‰

    function saveXP(){ localStorage.setItem(KEY.xp2, String(xp)); }
    function setFill(){ xpFill.style.width = Math.max(0, Math.min(100, Math.round((xp/XP_TO_RITUAL)*100))) + '%'; }
    setFill();

    function pushLine(text){
      const b = document.createElement('div'); b.className='bubble'; b.textContent=text; logEl.appendChild(b); logEl.scrollTop=logEl.scrollHeight;
      try{ const arr = JSON.parse(localStorage.getItem(KEY.log)||'[]'); arr.push({t:Date.now(), s:'sys', msg:text}); localStorage.setItem(KEY.log, JSON.stringify(arr).slice(-5000)); }catch(e){}
    }

    // Idle auto lines
    let autoTimer=null;
    function startAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer = setInterval(()=>{ pushLine(r(I18N[lang].lines)); }, 4200); }
    startAuto();

    // Feed action
    function feed(){
      pushLine(r(I18N[lang].react));
      xp++; setFill(); saveXP();
      if(xp===XP_TO_RITUAL-1){ pushLine(I18N[lang].evoReady); }
      if(xp>=XP_TO_RITUAL){
        pushLine(I18N[lang].evoGo);
        setTimeout(()=>{ location.href = 'rebirth.html'; }, 1200);
      }
    }

    feedBtn.addEventListener('click', feed);
    restBtn.addEventListener('click', ()=>{ startAuto(); });

    // First line greet
    pushLine(r(I18N[lang].lines));
  </script>
</body>
</html>
