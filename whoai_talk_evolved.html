<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‰ºöË©± | WhoAIÔºàÈÄ≤ÂåñÂæåÔºâ</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    html,body{height:100%;margin:0;overflow:hidden}
    body{
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
      background:#000 url("space_background.png") center/cover fixed no-repeat;
      display:flex;align-items:center;justify-content:center;padding:12px;
    }
    .stage{
      position:relative;width:min(92vw,820px);aspect-ratio:1/0.75;overflow:hidden;
      border-radius:24px;background:rgba(0,0,0,.22);
      backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px);
      border:1px solid rgba(255,255,255,.18);
      box-shadow:inset 0 10px 28px rgba(0,0,0,.25),0 10px 28px rgba(0,0,0,.25);
    }
    .charWrap{
      position:absolute;left:50%;top:70%;
      transform:translate(-50%,-50%);
      z-index:2;animation:roamPath 36s ease-in-out 1.6s infinite alternate;
    }
    .charImg{
      width:min(22vw,220px);max-width:40vmin;object-fit:contain;
      filter:drop-shadow(0 10px 22px rgba(0,0,0,.45));
      animation:bob 7s ease-in-out infinite;
    }
    @keyframes bob{0%,100%{transform:translateY(-8px)}50%{transform:translateY(8px)}}
    @keyframes roamPath{
      0%{left:20%;top:72%}20%{left:34%;top:56%}
      40%{left:74%;top:62%}60%{left:68%;top:30%}
      80%{left:26%;top:32%}100%{left:20%;top:72%}
    }
    .bubble{
      position:absolute;z-index:5;background:rgba(0,0,0,.55);color:#fff;
      padding:8px 12px;border-radius:14px;font-size:.95rem;opacity:0;
      transition:opacity .4s ease,left 1.1s ease,top 1.1s ease;user-select:none;
      box-shadow:0 6px 14px rgba(0,0,0,.25);
    }
    .floatBtn{
      position:absolute;z-index:5;background:rgba(255,255,255,.9);color:#111;
      font-weight:700;border:none;border-radius:14px;padding:8px 12px;cursor:pointer;
      opacity:.95;box-shadow:0 6px 18px rgba(0,0,0,.28);
      transition:left 1.1s ease,top 1.1s ease,opacity .4s ease;
    }
    .safety{
      position:fixed;right:14px;bottom:14px;z-index:10;background:rgba(255,255,255,.95);
      color:#111;border:none;border-radius:14px;padding:10px 14px;font-weight:700;font-size:.95rem;
      cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.32);
    }
  </style>
</head>
<body>
  <main class="stage" aria-live="polite">
    <div class="charWrap"><img id="charImg" class="charImg" alt="„Ç≠„É£„É©" /></div>
    <div id="bubble" class="bubble"></div>
    <button id="floatFeedBtn" class="floatBtn" type="button" style="left:16px;top:16px">üç¨ „Éû„Ç´„É≠„É≥„Çí„ÅÇ„Åí„Çã</button>
  </main>
  <button id="safetyBtn" class="safety" type="button">üç¨ „Éû„Ç´„É≠„É≥</button>

  <script>
  (function(){
    // ===== Âü∫Êú¨Áä∂ÊÖã =====
    const params = new URLSearchParams(location.search);
    const forceForm = params.get('form');   // "tane" „Å™„Çâ„Çø„ÉçÂõ∫ÂÆöË°®Á§∫
    const color = (localStorage.getItem('whoai_color') || localStorage.getItem('macaronColor') || 'pink').toLowerCase();

    const imgEl   = document.getElementById('charImg');
    const bubble  = document.getElementById('bubble');
    const floatBtn= document.getElementById('floatFeedBtn');
    const safetyBtn=document.getElementById('safetyBtn');
    const stage   = document.querySelector('.stage');
    const wrap    = document.querySelector('.charWrap');

    // ===== ÁîªÂÉèÂàáÊõøÔºàÂè£„Éë„ÇØ or „Çø„ÉçÂõ∫ÂÆöÔºâ =====
    const openSrc    = `${color}_open.png`;
    const closedSrc  = `${color}_closed.png`;
    const taneSrc    = `tane_${color}.png`;
    let hasOpen=false, hasClosed=false, isOpen=false, useTaneOnly = (forceForm === 'tane');

    function probe(url, cb){ const t=new Image(); t.onload=()=>cb(true); t.onerror=()=>cb(false); t.src=url; }

    if (!useTaneOnly) {
      probe(openSrc,   ok=>{hasOpen=ok;});
      probe(closedSrc, ok=>{hasClosed=ok;});
    }

    function setImg(url){ imgEl.src=url; }

    // ÂàùÊúüË°®Á§∫
    if (useTaneOnly) {
      // „Çø„ÉçÂÑ™ÂÖà / ÁÑ°„Åë„Çå„Å∞Ê±éÁî®„Å´‰ªª„Åõ„Çã
      const t1=new Image(); t1.onload=()=>setImg(taneSrc); t1.onerror=()=>setImg(`tane.png`); t1.src=taneSrc;
    } else {
      if (hasClosed) setImg(closedSrc);
      else {
        // ÈÄ≤ÂåñÁµµ„ÅåÁÑ°„Åë„Çå„Å∞„Çø„Éç„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        const t1=new Image(); t1.onload=()=>setImg(taneSrc); t1.onerror=()=>setImg(`tane.png`); t1.src=taneSrc;
      }
      // 1Áßí„Åî„Å®„Å´Âè£„Éë„ÇØÔºà„Å©„Å°„Çâ„ÅãÊ¨†„Åë„Å¶„ÅÑ„Å¶„ÇÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
      setInterval(()=>{
        if (useTaneOnly) return;
        isOpen = !isOpen;
        if (isOpen) setImg(hasOpen ? openSrc : (hasClosed ? closedSrc : taneSrc));
        else        setImg(hasClosed ? closedSrc : (hasOpen  ? openSrc  : taneSrc));
      }, 1000);
    }

    // ===== Âä±„Åæ„Åó„Éê„Éñ„É´ =====
    const LINES=[
      '„Å†„ÅÑ„Åò„Çá„ÅÜ„Å∂„ÄÅ„ÇÜ„Å£„Åè„Çä„Åß„ÅÑ„ÅÑ„Çà','‰ªäÊó•„ÅÆ„Åå„Çì„Å∞„Çä„ÄÅË¶ã„Å¶„Åü„Çà','Ê∑±ÂëºÂê∏„ÄÅ„ÅÑ„Å£„Åã„ÅÑ„Å≠',
      '„Åç„Åø„ÅÆ„Éö„Éº„Çπ„ÅßÈÄ≤„ÇÇ„ÅÜ','„Éü„Çπ„ÅØÈÄ≤Âåñ„ÅÆ„Çø„Éç„Å†„Çà','„ÇÇ„ÅÜ‰∏ÄÊ≠©„Å†„Åë„ÄÅ„ÅÑ„Å£„Åó„Çá„Å´',
      '‰ºë„ÇÄ„ÅÆ„ÇÇ„ÄÅÂº∑„Åï„Å†„Çà','Â∞è„Åï„Å™‰∏ÄÊ≠©„ÄÅ„Åà„Çâ„ÅÑÔºÅ'
    ];
    const pick=a=>a[Math.floor(Math.random()*a.length)];
    let W=stage.offsetWidth,H=stage.offsetHeight;
    addEventListener('resize',()=>{W=stage.offsetWidth;H=stage.offsetHeight;});

    function charCenter(){
      const r=wrap.getBoundingClientRect(), s=stage.getBoundingClientRect();
      return {x:r.left-s.left+r.width/2, y:r.top-s.top+r.height/2};
    }
    function farPos(minD,margin=14){
      const c=charCenter(); let x,y,g=0;
      do{ x=Math.random()*(W-margin*2)+margin; y=Math.random()*(H-margin*2)+margin; g++; if(g>200)break;}
      while(Math.hypot(x-c.x,y-c.y)<minD);
      return {left:x,top:y};
    }
    function showLine(t){
      bubble.textContent=t;
      const p=farPos(160);
      bubble.style.left=p.left+'px'; bubble.style.top=p.top+'px';
      bubble.style.opacity=1; setTimeout(()=>bubble.style.opacity=0,2400);
    }
    setTimeout(()=>showLine(pick(LINES)),1500);
    setInterval(()=>showLine(pick(LINES)),4200);

    // ===== „Éû„Ç´„É≠„É≥ÔºàÂÜçÈÅ∏Êäû„Å∏ÈÅ∑ÁßªÔºâ =====
    function toMacaron(){ location.href='macaron_select.html'; }
    floatBtn.addEventListener('click', toMacaron);
    safetyBtn.addEventListener('click', toMacaron);
    addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='m') toMacaron(); });

  })();
  </script>
</body>
</html>
