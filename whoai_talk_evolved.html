<!-- FILE: /whoai_talk_evolved.html（進化後）
  追加: 「トイレ」「あそぶ」ケア要素 + ステータス保存（localStorage）
  画像ルール: 背景はルート直下の space_background.png を使用。
  キャラ画像: {color}_open.png / {color}_closed.png を想定（例: pink_open.png）。
  ※存在しない場合は tane_{color}.png をフォールバック。
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>会話 | WhoAI（進化後・ケア）</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    html,body{height:100%;margin:0;overflow:hidden}
    body{
      position:relative;
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
      background:#000 url("space_background.png") center/cover fixed no-repeat;
    }

    /* ===== レイアウト ===== */
    .hud{position:fixed;left:50%;top:10px;transform:translateX(-50%);display:flex;gap:8px;flex-wrap:wrap;z-index:50}
    .chip{background:rgba(0,0,0,.35);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px;font-size:12px}

    .stage{position:absolute;inset:64px 12px 148px;/* 上,左右,下 */
      border-radius:24px;border:1px solid rgba(255,255,255,.16);
      background:radial-gradient(120% 120% at 50% 10%, rgba(255,255,255,.04), rgba(0,0,0,.35));
      overflow:hidden;isolation:isolate
    }

    /* キャラ */
    .avatar{position:absolute;left:50%;top:50%;translate:-50% -50%;width:min(40vmin,320px);aspect-ratio:1/1;image-rendering:auto;filter:drop-shadow(0 8px 24px rgba(0,0,0,.5));
      transition:transform .2s ease}
    .float{animation:float 6s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(-2%)}50%{transform:translateY(2%)}}

    /* 💩 表示 */
    .poo{position:absolute;font-size:clamp(28px,4vmin,42px);filter:drop-shadow(0 2px 4px rgba(0,0,0,.6));cursor:pointer;user-select:none}

    /* 吹き出し */
    .bubble{position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);max-width:min(70vw,520px);
      background:rgba(0,0,0,.65);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.25);
      padding:8px 12px;border-radius:12px;font-size:14px;line-height:1.5;opacity:0;translate:0 6px;
      transition:opacity .2s, translate .2s}
    .bubble.show{opacity:1;translate:0 0}

    /* アクションドック */
    .dock{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);z-index:60;width:min(960px,94vw)}
    .panel{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;background:rgba(0,0,0,.35);backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:10px}
    .btn{display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer;user-select:none;
      border:1px solid rgba(255,255,255,.25);border-radius:12px;padding:12px 10px;font-weight:700;font-size:16px;
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(0,0,0,.06));
      transition:transform .05s ease, background .2s}
    .btn:active{transform:translateY(2px)}
    .btn .emoji{font-size:22px}

    /* ステータスバー */
    .bars{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}
    .bar{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:12px;overflow:hidden}
    .bar b{display:flex;align-items:center;gap:6px;font-size:12px;padding:6px 8px}
    .bar .track{height:8px;background:rgba(255,255,255,.08)}
    .bar .fill{height:100%;width:0%;background:linear-gradient(90deg,rgba(255,255,255,.85),rgba(255,255,255,.45))}

    /* チャット（簡易） */
    .chat{position:absolute;right:10px;bottom:10px;display:flex;gap:6px;z-index:45}
    .chat input{width:min(46vw,400px);padding:10px;border-radius:999px;border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.4);backdrop-filter:blur(4px);color:#fff}
    .chat button{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.4);color:#fff;cursor:pointer}

    /* モバイル調整 */
    @media (max-width:760px){
      .panel{grid-template-columns:1fr}
      .chat{left:50%;right:auto;transform:translateX(-50%)}
    }
  </style>
</head>
<body>
  <!-- HUD / 名前など -->
  <div class="hud" id="hud">
    <div class="chip" id="chipUser">あなた：-</div>
    <div class="chip" id="chipChar">キャラ：-</div>
    <div class="chip" id="chipColor">色：pink</div>
    <div class="chip">進化後</div>
  </div>

  <!-- ステージ / キャラ・吹き出し・💩 -->
  <div class="stage" id="stage">
    <img id="avatar" class="avatar float" alt="character" />
    <div id="bubble" class="bubble" aria-live="polite"></div>
    <!-- 💩 は JS で追加/削除 -->
  </div>

  <!-- 入力（簡易チャット。Enter送信）-->
  <div class="chat">
    <input id="chatInput" type="text" placeholder="話しかける（Enterで送信）" />
    <button id="chatSend">送信</button>
  </div>

  <!-- アクションドック（ステータス + ボタン）-->
  <div class="dock">
    <div class="bars">
      <div class="bar"><b>きれいさ</b><div class="track"><div class="fill" id="barClean"></div></div></div>
      <div class="bar"><b>たのしさ</b><div class="track"><div class="fill" id="barFun"></div></div></div>
      <div class="bar"><b>げんき</b><div class="track"><div class="fill" id="barEnergy"></div></div></div>
    </div>
    <div class="panel">
      <div class="btn" id="btnToilet" title="トイレに連れていく"><span class="emoji">🚽</span>トイレ</div>
      <div class="btn" id="btnPlay" title="いっしょに遊ぶ"><span class="emoji">🎮</span>あそぶ</div>
    </div>
  </div>

  <script>
  ;(() => {
    // ====== 設定・保存系 ======
    const LS_KEYS = {
      state: 'whoai.evolved.care.state',
      user: 'your_name',            // あなたの名前（既存仕様に合わせて）
      char: 'char_name',            // キャラの名前
      color: 'macaron_color',       // 選択色（pink/blue/green/purple...）
      talkEndpoint: 'TALK_ENDPOINT' // 既存のエンドポイントを localStorage から読む
    }

    const DEFAULTS = {
      clean: 80, fun: 70, energy: 80, waste: 0, // waste: 0-100 （💩量）
      lastTs: Date.now()
    }

    const $ = (sel) => document.querySelector(sel)
    const stage = $('#stage')
    const avatar = $('#avatar')
    const bubble = $('#bubble')

    const barClean = $('#barClean')
    const barFun = $('#barFun')
    const barEnergy = $('#barEnergy')

    const chipUser = $('#chipUser')
    const chipChar = $('#chipChar')
    const chipColor = $('#chipColor')

    const btnToilet = $('#btnToilet')
    const btnPlay = $('#btnPlay')

    const chatInput = $('#chatInput')
    const chatSend = $('#chatSend')

    // 名前・色の読込
    const userName = localStorage.getItem(LS_KEYS.user) || 'あなた'
    const charName = localStorage.getItem(LS_KEYS.char) || 'マカロン'
    const color = (localStorage.getItem(LS_KEYS.color) || 'pink').toLowerCase()

    chipUser.textContent = `あなた：${userName}`
    chipChar.textContent = `キャラ：${charName}`
    chipColor.textContent = `色：${color}`

    // ---- 画像ローダ（フォールバック） ----
    const srcCandidates = [
      `${color}_open.png`,
      `public/assets/stage2/${color}_open.png`,
      `public/assets/stage1/${color}_open.png`,
      `tane_${color}.png`
    ]
    const srcCandidatesClosed = [
      `${color}_closed.png`,
      `public/assets/stage2/${color}_closed.png`,
      `public/assets/stage1/${color}_closed.png`,
      `tane_${color}.png`
    ]

    let imgOpen = null, imgClosed = null

    function loadWithFallback(candidates){
      return new Promise(resolve => {
        const tryNext = (i) => {
          if(i >= candidates.length){ resolve(null);return }
          const img = new Image()
          img.onload = () => resolve(candidates[i])
          img.onerror = () => tryNext(i+1)
          img.src = candidates[i]
        }
        tryNext(0)
      })
    }

    async function prepareImages(){
      imgOpen = await loadWithFallback(srcCandidates)
      imgClosed = await loadWithFallback(srcCandidatesClosed)
      avatar.src = imgClosed || imgOpen || ''
    }

    // ====== 状態のロード・保存 ======
    let state = DEFAULTS
    try{
      const saved = JSON.parse(localStorage.getItem(LS_KEYS.state) || 'null')
      if(saved){ state = { ...DEFAULTS, ...saved } }
    }catch{}

    // オフライン劣化（前回からの経過で減衰）
    const elapsedMin = Math.max(0, Math.floor((Date.now() - (state.lastTs||Date.now())) / 60000))
    if(elapsedMin > 0){
      // 経過1分ごとに少しずつ劣化
      decay(Math.min(elapsedMin, 240)) // 上限4時間ぶん
    }

    function clamp(v){ return Math.max(0, Math.min(100, v)) }

    function save(){
      state.lastTs = Date.now()
      localStorage.setItem(LS_KEYS.state, JSON.stringify(state))
    }

    function updateBars(){
      barClean.style.width = clamp(state.clean) + '%'
      barFun.style.width = clamp(state.fun) + '%'
      barEnergy.style.width = clamp(state.energy) + '%'
    }

    function say(text){
      bubble.textContent = text
      bubble.classList.add('show')
      clearTimeout(say._t)
      say._t = setTimeout(()=> bubble.classList.remove('show'), 2400)
    }

    // 💩 の表示・管理
    function ensurePoo(){
      // waste 60 以上で 1〜3 個まで出現
      const existing = stage.querySelectorAll('.poo').length
      if(state.waste >= 60 && existing === 0){ addPoo() }
      if(state.waste < 60){ stage.querySelectorAll('.poo').forEach(e=>e.remove()) }
    }

    function addPoo(){
      const e = document.createElement('div')
      e.className = 'poo'
      e.textContent = '💩'
      // ステージ内のランダム位置
      const rect = stage.getBoundingClientRect()
      const x = Math.random()*(rect.width-40)+20
      const y = Math.random()*(rect.height-80)+40
      e.style.left = x + 'px'
      e.style.top = y + 'px'
      e.addEventListener('click', () => {
        // 直接片付けても OK（きれいさ +5）
        state.waste = clamp(state.waste - 40)
        state.clean = clamp(state.clean + 5)
        e.remove(); persistAndRefresh(); say('おそうじ、ありがとう！')
      })
      stage.appendChild(e)
    }

    function persistAndRefresh(){ save(); updateBars(); ensurePoo() }

    // ====== 劣化（30秒ごと） ======
    function tick(){
      // 30 秒ごとに少しだけ劣化
      decay(1) // 1単位=30秒
      persistAndRefresh()
      mood()
    }

    function decay(units){
      // 単位あたり:
      // ・たのしさ -0.6, げんき -0.5, きれいさ -0.4
      // ・waste +0.8（一定以上で💩）
      state.fun = clamp(state.fun - 0.6*units)
      state.energy = clamp(state.energy - 0.5*units)
      state.clean = clamp(state.clean - 0.4*units)
      state.waste = clamp(state.waste + 0.8*units)
    }

    function mood(){
      if(state.clean < 25) say('うぅ…ちょっとくさいかも…')
      else if(state.fun < 25) say('たいくつ…あそぼう？')
      else if(state.energy < 20) say('ねむい…ちょっと休みたいな')
    }

    // ====== アクション ======
    btnToilet.addEventListener('click', () => {
      if(state.waste <= 10){
        say('いまは大丈夫！')
        // 外した場合は少しだけ clean 回復
        state.clean = clamp(state.clean + 2)
      }else{
        state.waste = clamp(state.waste - 60)
        state.clean = clamp(state.clean + 12)
        state.energy = clamp(state.energy + 4)
        stage.querySelectorAll('.poo').forEach(e=>e.remove())
        say('すっきり！')
      }
      persistAndRefresh()
    })

    btnPlay.addEventListener('click', () => {
      // あそぶ: たのしさ↑ エネルギー↓ たまに💩誘発
      state.fun = clamp(state.fun + 14)
      state.energy = clamp(state.energy - 6)
      if(Math.random()<0.35){ state.waste = clamp(state.waste + 10) }
      // 視覚効果（小ジャンプ）
      avatar.style.transform = 'scale(1.04)'
      setTimeout(()=> avatar.style.transform = '', 160)
      say('わーい！')
      persistAndRefresh()
    })

    // ====== 簡易チャット（既存 TALK_ENDPOINT に対応） ======
    async function sendChat(msg){
      if(!msg) return
      const endpoint = localStorage.getItem(LS_KEYS.talkEndpoint)
      if(endpoint){
        try{
          const res = await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg, name:userName, char:charName, color})})
          const data = await res.json().catch(()=>null)
          say((data && (data.reply||data.message)) || '…')
        }catch{
          say('（通信できなかった…）')
        }
      }else{
        // エンドポイント未設定時は簡易エコー
        say(`「${msg}」…ふむふむ！`)
      }
      // 話す間は口パク
      mouthOpen(900)
    }

    chatSend.addEventListener('click', ()=>{
      const v = chatInput.value.trim(); if(!v) return; chatInput.value=''; sendChat(v)
    })
    chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); chatSend.click() } })

    // ====== 口パク制御 ======
    let mouthTimer = null
    function mouthOpen(ms=900){
      if(imgOpen){ avatar.src = imgOpen }
      clearTimeout(mouthTimer)
      mouthTimer = setTimeout(()=>{ if(imgClosed){ avatar.src = imgClosed } }, ms)
    }

    // ====== ゆるいランダム移動（XY） ======
    function wander(){
      const r = stage.getBoundingClientRect()
      const ax = Math.random()*(r.width*0.6) + r.width*0.2
      const ay = Math.random()*(r.height*0.6) + r.height*0.2
      avatar.style.left = ax + 'px'
      avatar.style.top  = ay + 'px'
    }

    // ====== 初期化 ======
    function init(){
      updateBars(); ensurePoo(); mood();
      setInterval(tick, 30000) // 30秒ごとに劣化
      setInterval(()=> mouthOpen(400), 4200) // たまに口を開ける
      setInterval(wander, 3800) // ゆる移動
      persistAndRefresh()
    }

    prepareImages().then(init)

    // クリックでなでる（少し回復）
    avatar.addEventListener('click', ()=>{
      state.fun = clamp(state.fun + 3)
      state.energy = clamp(state.energy + 1)
      say('なでなで…♡')
      mouthOpen(600)
      persistAndRefresh()
    })

  })()
  </script>
</body>
</html>
