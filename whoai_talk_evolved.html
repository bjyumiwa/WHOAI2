<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>会話 | WhoAI（進化後・ケア機能）</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --glass-bg: rgba(0,0,0,.35);
      --glass-brd: rgba(255,255,255,.2);
      --accent: #8ad5ff;
      --ok: #6ee7b7;
      --warn: #fbbf24;
      --bad: #fb7185;
    }
    html,body{height:100%;margin:0;overflow:hidden}
    body{
      position:relative;
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
      background:#000 url("space_background.png") center/cover fixed no-repeat;
      user-select:none;
    }
    /* Top chips */
    .chips{position:fixed;left:50%;top:10px;transform:translateX(-50%);display:flex;gap:8px;flex-wrap:wrap;z-index:30}
    .chip{background:var(--glass-bg);backdrop-filter:blur(3px);border:1px solid var(--glass-brd);padding:6px 10px;border-radius:999px;font-size:12px}

    /* Floating character */
    .stage{position:absolute;inset:0}
    .char{position:absolute;width:min(22vmin,200px);aspect-ratio:1/1.05;z-index:5;filter:drop-shadow(0 8px 24px rgba(0,0,0,.45));transition:transform .12s ease}
    .char img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}
    .name-tag{position:absolute;left:50%;top:-22px;transform:translateX(-50%);padding:4px 10px;border-radius:999px;border:1px solid var(--glass-brd);background:var(--glass-bg);backdrop-filter:blur(3px);font-size:12px;white-space:nowrap}

    /* Speech bubble */
    .bubble{position:absolute;left:50%;top:-72px;transform:translateX(-50%);max-width:min(70vw,380px);padding:10px 12px;border-radius:14px;border:1px solid var(--glass-brd);background:var(--glass-bg);backdrop-filter:blur(4px);font-size:14px;opacity:0;pointer-events:none;transition:opacity .2s}
    .bubble.show{opacity:1}

    /* Poop */
    .poop{position:absolute;font-size:clamp(20px,4vmin,34px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.5))}

    /* Bottom panel */
    .panel{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);display:flex;flex-direction:column;gap:8px;align-items:center;z-index:40;width:min(960px,94vw)}
    .status{display:grid;grid-template-columns:120px 1fr 52px;gap:8px;align-items:center;width:100%;}
    .status .label{font-size:12px;opacity:.9}
    .bar{height:12px;border-radius:999px;background:rgba(255,255,255,.12);position:relative;overflow:hidden;border:1px solid var(--glass-brd)}
    .bar > i{position:absolute;left:0;top:0;bottom:0;width:50%;border-radius:999px}
    .val{font-variant-numeric:tabular-nums;font-size:12px;opacity:.9;text-align:right}

    .buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .btn{border:1px solid var(--glass-brd);background:var(--glass-bg);backdrop-filter:blur(3px);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:active{transform:translateY(1px)}

    /* Chat */
    .chat{display:grid;grid-template-columns:1fr auto;gap:8px;width:100%}
    .chat input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--glass-brd);background:rgba(0,0,0,.25);color:#fff}
    .chat button{padding:12px 16px;border-radius:12px;border:1px solid var(--glass-brd);background:var(--glass-bg);color:#fff;font-weight:700;cursor:pointer}

    /* Hint */
    .hint{position:fixed;left:12px;top:12px;font-size:12px;background:var(--glass-bg);border:1px solid var(--glass-brd);padding:6px 10px;border-radius:10px;z-index:50}

    /* Safe area */
    @media (max-width:480px){
      .char{width:min(28vmin,160px)}
      .status{grid-template-columns:88px 1fr 46px}
    }
  </style>
</head>
<body>
  <div class="hint">キャラをクリック：なでる / 🚽トイレ / 🎮あそぶ</div>
  <div class="chips" id="chips"></div>

  <div class="stage" id="stage"></div>

  <div class="panel">
    <div class="status">
      <div class="label">きれいさ</div>
      <div class="bar"><i id="bar-clean"></i></div>
      <div class="val" id="val-clean">--%</div>

      <div class="label">たのしさ</div>
      <div class="bar"><i id="bar-fun"></i></div>
      <div class="val" id="val-fun">--%</div>

      <div class="label">げんき</div>
      <div class="bar"><i id="bar-energy"></i></div>
      <div class="val" id="val-energy">--%</div>
    </div>

    <div class="buttons">
      <button class="btn" id="btn-toilet">🚽 トイレ</button>
      <button class="btn" id="btn-play">🎮 あそぶ</button>
      <button class="btn" id="btn-rest">💤 ねる</button>
      <button class="btn" id="btn-snack">🍪 おやつ</button>
      <button class="btn" id="btn-bath">🛁 おふろ</button>
    </div>

    <div class="chat">
      <input id="chat-input" placeholder="話しかける… (Enterで送信)" />
      <button id="chat-send">送信</button>
    </div>
  </div>

  <script>
    // ====== 基本設定・状態管理 ======
    const LS_COLOR_KEYS = ["macaronColor","MACARON_COLOR","color"];
    const LS_PLAYER_KEYS = ["playerName","PLAYER_NAME","あなたの名前"];
    const LS_CHAR_KEYS = ["characterName","CHAR_NAME","キャラの名前","キャラクターの名前"];
    const TALK_ENDPOINT = localStorage.getItem("TALK_ENDPOINT") || ""; // 既存APIあれば利用

    function readFirst(keys, fallback=""){
      for(const k of keys){
        const v = localStorage.getItem(k);
        if(v && v !== "undefined" && v !== "null") return v;
      }
      return fallback;
    }

    const color = (readFirst(LS_COLOR_KEYS, "pink")||"pink").toLowerCase();
    const playerName = readFirst(LS_PLAYER_KEYS, "あなた");
    const charName = readFirst(LS_CHAR_KEYS, "マカロン");

    // 状態（保存）
    const STATE_KEY = "whoai_state_evolved";
    const now = () => Date.now();
    function loadState(){
      try{
        const obj = JSON.parse(localStorage.getItem(STATE_KEY) || "null");
        if(!obj) return null;
        return obj;
      }catch{ return null }
    }
    function saveState(){
      state.updatedAt = now();
      localStorage.setItem(STATE_KEY, JSON.stringify(state));
    }

    let state = loadState() || {
      clean: 80,   // 0-100
      fun: 70,
      energy: 75,
      waste: 0,   // 0-100（💩発生量）
      poops: [],  // {x,y} 配置
      updatedAt: now()
    };

    // 経過時間で自然劣化（1分あたり）
    function applyDecayByElapsed(){
      const minutes = Math.max(0, (now() - state.updatedAt) / 60000);
      if(minutes > 0){
        state.clean = clamp(state.clean - 2*minutes, 0, 100);
        state.fun   = clamp(state.fun   - 1.2*minutes, 0, 100);
        state.energy= clamp(state.energy- 1.0*minutes, 0, 100);
        state.waste = clamp(state.waste + 1.5*minutes, 0, 100);
        // 💩しきい値
        maybeSpawnPoop();
      }
    }

    function clamp(v,min,max){return Math.max(min, Math.min(max, v));}

    // ====== UI生成：キャラ ======
    const stage = document.getElementById('stage');
    const chips = document.getElementById('chips');

    // chips
    chips.innerHTML = `
      <div class="chip">👤 ${playerName}</div>
      <div class="chip">✨ 進化後：${charName}</div>
      <div class="chip">🍬 色：${color}</div>
      ${TALK_ENDPOINT?'<div class="chip">API接続: ON</div>':'<div class="chip">API接続: OFF</div>'}
    `;

    // キャラDOM
    const char = document.createElement('div');
    char.className = 'char';
    char.style.left = '50%';
    char.style.top = '52%';
    char.style.transform = 'translate(-50%,-50%)';

    const imgClosed = document.createElement('img');
    const imgOpen = document.createElement('img');
    imgClosed.alt = 'character';
    imgOpen.alt = 'character';
    imgClosed.src = `${color}_closed.png`;
    imgOpen.src = `${color}_open.png`;
    imgOpen.style.opacity = 0;

    // フォールバック（tane_*）
    imgClosed.onerror = () => { imgClosed.onerror=null; imgClosed.src = `tane_${color}.png`; };
    imgOpen.onerror   = () => { imgOpen.onerror=null; imgOpen.src   = `tane_${color}.png`; };

    const nameTag = document.createElement('div');
    nameTag.className = 'name-tag';
    nameTag.textContent = charName;

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    char.appendChild(imgClosed);
    char.appendChild(imgOpen);
    char.appendChild(nameTag);
    char.appendChild(bubble);
    stage.appendChild(char);

    // クリックでなでる
    char.addEventListener('click', () => {
      speak(randomPick([
        'なでなで…♪','うれしい！','もっと～','ふにゃ…','ごきげん！'
      ]));
      gain({fun:+6, energy:+2});
      mouthOpen(260);
    });

    // ゆる移動（画面内ランダム）
    let vx = 0.08, vy = -0.06; // vmin/フレーム相当
    function loop(){
      const rect = stage.getBoundingClientRect();
      const cw = char.offsetWidth, ch = char.offsetHeight;
      let x = char.offsetLeft, y = char.offsetTop;
      x += vx; y += vy;
      if(x < 10){x=10; vx*=-1} if(y < 10){y=10; vy*=-1}
      if(x > rect.width - cw - 10){x=rect.width - cw - 10; vx*=-1}
      if(y > rect.height - ch - 10){y=rect.height - ch - 10; vy*=-1}
      char.style.left = x + 'px';
      char.style.top = y + 'px';
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // ====== ステータスUI ======
    const barClean = document.getElementById('bar-clean');
    const barFun = document.getElementById('bar-fun');
    const barEnergy = document.getElementById('bar-energy');
    const valClean = document.getElementById('val-clean');
    const valFun = document.getElementById('val-fun');
    const valEnergy = document.getElementById('val-energy');

    function setBar(el, v){
      el.style.width = `${v}%`;
      el.style.background = gradientFor(v);
    }
    function gradientFor(v){
      // good->warn->bad の簡易グラデ
      if(v>66) return `linear-gradient(90deg, var(--ok), #a7f3d0)`;
      if(v>33) return `linear-gradient(90deg, var(--warn), #fde68a)`;
      return `linear-gradient(90deg, var(--bad), #fecaca)`;
    }
    function refreshBars(){
      setBar(barClean, state.clean);
      setBar(barFun, state.fun);
      setBar(barEnergy, state.energy);
      valClean.textContent = `${Math.round(state.clean)}%`;
      valFun.textContent = `${Math.round(state.fun)}%`;
      valEnergy.textContent = `${Math.round(state.energy)}%`;
    }

    // 💩描画
    function renderPoops(){
      // 既存削除
      stage.querySelectorAll('.poop').forEach(n=>n.remove());
      state.poops.forEach(p=>{
        const d = document.createElement('div');
        d.className = 'poop';
        d.textContent = '💩';
        d.style.left = p.x + 'px';
        d.style.top = p.y + 'px';
        stage.appendChild(d);
      });
    }

    // 💩出現ロジック
    function maybeSpawnPoop(){
      if(state.waste >= 30){
        // 足元に💩生成
        const rect = stage.getBoundingClientRect();
        const x = clamp(char.offsetLeft + char.offsetWidth/2 + (Math.random()*40-20), 10, rect.width-30);
        const y = clamp(char.offsetTop + char.offsetHeight - 10, 10, rect.height-30);
        state.poops.push({x,y});
        state.waste = 0; // 一度出たらリセット
        speak('うう…出ちゃった…');
      }
    }

    // ====== 行動ボタン ======
    document.getElementById('btn-toilet').addEventListener('click', ()=>{
      // 💩掃除＆きれいさ回復
      const cleaned = state.poops.length;
      state.poops = [];
      state.clean = clamp(state.clean + 10 + cleaned*5, 0, 100);
      state.waste = 0;
      speak(cleaned>0?`おトイレ完了！${cleaned}こ片付けたよ！`:'スッキリ！');
      mouthOpen(420);
      saveAndRender();
    });

    document.getElementById('btn-play').addEventListener('click', ()=>{
      // 遊ぶ：楽しい↑ 元気↓ たまに💩増
      state.fun = clamp(state.fun + 12, 0, 100);
      state.energy = clamp(state.energy - 6, 0, 100);
      state.waste = clamp(state.waste + (Math.random()<0.5?10:4), 0, 100);
      speak('あそぼあそぼ！');
      mouthOpen(500);
      maybeSpawnPoop();
      saveAndRender();
    });

    document.getElementById('btn-rest').addEventListener('click', ()=>{
      state.energy = clamp(state.energy + 16, 0, 100);
      state.fun = clamp(state.fun - 4, 0, 100);
      speak('すやぁ… (回復中)');
      mouthOpen(300);
      saveAndRender();
    });

    document.getElementById('btn-snack').addEventListener('click', ()=>{
      state.fun = clamp(state.fun + 8, 0, 100);
      state.energy = clamp(state.energy + 4, 0, 100);
      state.waste = clamp(state.waste + 8, 0, 100);
      speak('もぐもぐ♪');
      mouthOpen(300);
      maybeSpawnPoop();
      saveAndRender();
    });

    document.getElementById('btn-bath').addEventListener('click', ()=>{
      state.clean = clamp(state.clean + 18, 0, 100);
      speak('さっぱり～！');
      mouthOpen(360);
      saveAndRender();
    });

    // ====== 口パク ======
    let mouthTimer=null;
    function mouthOpen(ms=300){
      if(mouthTimer) clearTimeout(mouthTimer);
      imgOpen.style.opacity = 1;
      imgClosed.style.opacity = 0;
      mouthTimer = setTimeout(()=>{
        imgOpen.style.opacity = 0;
        imgClosed.style.opacity = 1;
      }, ms);
    }

    // ====== セリフ ======
    let bubbleTimer=null;
    function speak(text){
      bubble.textContent = text;
      bubble.classList.add('show');
      if(bubbleTimer) clearTimeout(bubbleTimer);
      bubbleTimer = setTimeout(()=> bubble.classList.remove('show'), 2400);
    }
    function statusSpeak(){
      const msgs=[];
      if(state.clean<35) msgs.push('おそうじしたい…');
      if(state.fun<35) msgs.push('たいくつだよ…');
      if(state.energy<35) msgs.push('ちょっと休みたい…');
      if(state.poops.length>0) msgs.push('足元に何かある…💩');
      if(!msgs.length) msgs.push('今日はいい感じ！');
      speak(randomPick(msgs));
    }

    function randomPick(arr){return arr[Math.floor(Math.random()*arr.length)];}

    // ====== 自然劣化タイマー ======
    function tick(){
      state.clean = clamp(state.clean - 1, 0, 100);
      state.fun   = clamp(state.fun   - 0.6, 0, 100);
      state.energy= clamp(state.energy- 0.5, 0, 100);
      state.waste = clamp(state.waste + 0.8, 0, 100);
      maybeSpawnPoop();
      if(Math.random()<0.25) statusSpeak();
      saveAndRender();
    }

    function saveAndRender(){
      saveState();
      refreshBars();
      renderPoops();
    }

    // ====== チャット送信 ======
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');

    chatSend.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); } });

    async function sendChat(){
      const text = chatInput.value.trim();
      if(!text) return;
      chatInput.value = '';
      mouthOpen(300);
      speak(`${playerName}：${text}`);

      try{
        if(TALK_ENDPOINT){
          const res = await fetch(TALK_ENDPOINT, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({role:'user', name: playerName, content: text, charName, color})});
          const data = await res.json().catch(()=>({reply:'…'}));
          const reply = data.reply || data.content || JSON.stringify(data).slice(0,180);
          setTimeout(()=>{ speak(`${charName}：${reply}`); mouthOpen(500); }, 450);
        }else{
          // 簡易エコー
          setTimeout(()=>{ speak(`${charName}：${text.replace(/\?$/,'！')}`); mouthOpen(400); }, 420);
        }
        // 会話でちょい回復
        gain({fun:+4});
      }catch(err){
        speak('通信できなかったみたい…');
      }finally{
        saveAndRender();
      }
    }

    function gain({clean=0,fun=0,energy=0}){
      state.clean = clamp(state.clean + clean, 0, 100);
      state.fun = clamp(state.fun + fun, 0, 100);
      state.energy = clamp(state.energy + energy, 0, 100);
    }

    // ====== 初期化 ======
    applyDecayByElapsed();
    saveAndRender();
    statusSpeak();

    // 30秒ごとに自然劣化
    setInterval(tick, 30000);

    // 初回描画後、💩も表示
    renderPoops();
  </script>
</body>
</html>
