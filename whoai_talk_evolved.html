<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhoAI | 進化シーン（ふわふわ）</title>
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
    background:#000 url("space_background.png") center/cover fixed no-repeat;
    display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px
  }

  .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .chip{background:rgba(0,0,0,.35);backdrop-filter:blur(3px);
        border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;font-size:12px}

  .stage{
    position:relative; width:min(980px,96vw); height:min(70vh,78vw);
    background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.2);
    border-radius:18px; overflow:hidden;
  }
  #char{position:absolute; left:50%; bottom:8px; transform:translateX(-50%);
        width:min(300px,62vw); height:auto; filter:drop-shadow(0 8px 22px rgba(0,0,0,.55))}

  /* クリックしやすい “名前”（透明の大きい当たり判定） */
  .floatWrap{
    position:absolute; opacity:0; transition:opacity .35s ease, transform .18s ease;
    pointer-events:none; /* 非表示時は拾わない */
  }
  .floatWrap.show{opacity:1; pointer-events:auto;}
  .hit{position:relative; display:inline-block; padding:14px 22px;} /* 透明のクリック領域 */
  #floatName{
    position:absolute; left:0; top:0; transform:translate(14px,10px);
    font-weight:900; font-size:clamp(18px,5vw,28px); cursor:pointer;
    text-shadow:0 4px 16px rgba(0,0,0,.45); user-select:none; pointer-events:none; /* テキストは透過、イベントは .hit で拾う */
  }

  /* ランダムに出る短いセリフ */
  .phrase{
    position:absolute; opacity:0; transition:opacity .35s ease, transform .35s ease;
    font-weight:600; font-size:clamp(14px,4.5vw,22px); text-shadow:0 4px 16px rgba(0,0,0,.45);
    pointer-events:none;
  }
  .phrase.show{opacity:1}

  /* 小さなささやき（飾り） */
  .whisp{position:absolute; font-size:12px; opacity:.85; pointer-events:none;
         animation: floaty 10s ease-in-out infinite;}
  @keyframes floaty{
    0%{ transform:translate(0,0); opacity:.8 }
    50%{ transform:translate(10px,-14px); opacity:1 }
    100%{ transform:translate(0,0); opacity:.8 }
  }

  /* 下部操作 */
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .btn{
    padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:800;
    background:#ffd1ec; color:#222;
  }
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .btn-ghost{background:rgba(255,255,255,.14); color:#fff; border:1px solid rgba(255,255,255,.25)}
  .pop{animation: pop .18s ease}
  @keyframes pop{ 0%{transform:scale(1.02)} 100%{transform:scale(1)} }
</style>
</head>
<body>
  <div class="chips">
    <span class="chip">色: <span id="chipColor">-</span></span>
    <span class="chip">段階: evolved</span>
    <span class="chip">pts: <span id="pts">0</span> / 20</span>
  </div>

  <section class="stage" aria-label="進化シーン">
    <img id="char" alt="キャラクター">

    <!-- クリックしやすい名前：大きめの透明ボタン(.hit)の上に文字 -->
    <div id="nameWrap" class="floatWrap">
      <button id="nameHit" class="hit" aria-label="名前をクリックでポイント"></button>
      <div id="floatName">-</div>
    </div>

    <!-- 短いセリフ（1つずつ出て消える） -->
    <div id="phrase" class="phrase">……</div>

    <!-- 小さな囁き -->
    <div id="whisps"></div>
  </section>

  <div class="controls">
    <button class="btn-ghost" onclick="location.href='whoai_talk.html'">会話モードへ</button>
    <button id="btnMacaron" class="btn" disabled onclick="location.href='macaron_select.html'">マカロンを選ぶ</button>
    <button class="btn-ghost" onclick="resetPts()">ptsリセット</button>
  </div>

<script>
/* ===== ステート ===== */
const K = { name:"whoai_name", color:"macaronColor", color2:"whoai_color", stage:"whoai_stage", pts:"whoai_points" };
const getName = ()=> localStorage.getItem(K.name) || "キャラ";
const getColor= ()=> (localStorage.getItem(K.color) || localStorage.getItem(K.color2) || "pink").toLowerCase();
const getPts  = ()=> parseInt(localStorage.getItem(K.pts) || "0",10);
const setPts  = (n)=> localStorage.setItem(K.pts, String(n));

/* ===== 画像（フォールバック） ===== */
function loadCharImage(imgEl, color){
  const cand = [`${color}_open.png`, `${color}_closed.png`, `pink_open.png`];
  (function tryNext(i){
    if(i>=cand.length){ imgEl.alt="画像が見つかりません"; return; }
    const p=cand[i], t=new Image();
    t.onload = ()=> imgEl.src=p;
    t.onerror= ()=> tryNext(i+1);
    t.src=p;
  })(0);
}

/* ===== ユーティリティ ===== */
const rand = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;
function place(el, leftMin,leftMax, topMin,topMax){
  el.style.left = rand(leftMin,leftMax) + '%';
  el.style.top  = rand(topMin, topMax) + '%';
}

/* ===== 名前：出たり消えたり（クリックしやすい） ===== */
function cycleName(){
  const wrap = document.getEl
