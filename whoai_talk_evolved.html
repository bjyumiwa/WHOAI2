<!-- FILE: /WHOAI2/whoai_care_evolved.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WhoAI | é€²åŒ–å¾Œã®ãŠä¸–è©±ï¼ˆãã‚‰ãã‚‰æ˜Ÿï¼‰</title>
<meta name="color-scheme" content="dark light" />
<link rel="icon"
  href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.85em' font-size='80'%3EğŸŒŸ%3C/text%3E%3C/svg%3E" />
<style>
  :root{ --glass: rgba(0,0,0,.35); --brd: rgba(255,255,255,.18); --ink:#fff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;overflow:hidden}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:var(--ink);
    background:#000 url("space_background.png") center/cover fixed no-repeat;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .topbar{position:fixed;left:0;right:0;top:0;display:flex;align-items:center;gap:8px;padding:8px;z-index:20}
  .btn{background:var(--glass);border:1px solid var(--brd);color:#fff;border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer;font-size:14px}
  .btn.small{padding:6px 10px;font-size:13px;border-radius:10px}
  .spacer{flex:1}
  .chip{background:var(--glass);border:1px solid var(--brd);padding:6px 10px;border-radius:999px;font-size:12px}

  .title{position:fixed;left:50%;top:48px;transform:translateX(-50%);font-weight:800;text-align:center;z-index:4}
  .subtitle{position:fixed;left:50%;top:76px;transform:translateX(-50%);font-size:12px;opacity:.9;text-align:center;z-index:4}

  /* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
  .field{position:fixed;inset:0;overflow:hidden}

  /* ã‚­ãƒ£ãƒ© */
  .tane{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:6px;z-index:2}
  .tane img{width:min(40vmin,220px);height:auto;filter:drop-shadow(0 10px 28px rgba(0,0,0,.55));user-select:none;pointer-events:none;transition:transform .18s ease}
  @media (max-width:480px){ .tane img{width:min(54vmin,160px)} }
  .pop{animation:pop .25s ease}@keyframes pop{0%{transform:scale(1)}60%{transform:scale(1.06)}100%{transform:scale(1)}}
  .nameTag{margin-top:6px;padding:8px 14px;border-radius:12px;background:var(--glass);border:1px solid var(--brd);cursor:pointer;user-select:none;font-weight:800;box-shadow:0 8px 20px rgba(0,0,0,.35);opacity:0;transition:opacity .25s}
  .nameTag.show{opacity:1}
  .spin{animation:spin 500ms ease both}@keyframes spin{to{transform:rotate(360deg)}}

  /* ãƒ•ã‚­ãƒ€ã‚· */
  .bubble{position:absolute;left:50%;top:-10px;transform:translate(-50%,-100%);background:#0f1220d0;border:1px solid var(--brd);border-radius:14px;padding:8px 12px;font-size:13px;box-shadow:0 10px 26px rgba(0,0,0,.5);opacity:0;transition:opacity .2s, transform .2s}
  .bubble.show{opacity:1;transform:translate(-50%,-115%)}

  /* ãŠä¸–è©±ãƒ‘ãƒãƒ« */
  .panel{position:fixed;left:50%;bottom:8px;transform:translateX(-50%);width:min(920px,96vw);display:grid;grid-template-columns:1fr;gap:8px;z-index:6}
  .care{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
  .btnspeed{background:rgba(255,255,255,.14);border:1px solid var(--brd);border-radius:10px;padding:6px 10px;cursor:pointer;font-size:14px;min-width:40px;text-align:center}
  .btnspeed.active{background:rgba(255,255,255,.24);border-color:rgba(255,255,255,.6)}

  .gauges{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
  .gbar{position:relative;height:12px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid var(--brd);overflow:hidden}
  .gbar>span{position:absolute;left:0;top:0;bottom:0;width:60%;background:linear-gradient(90deg,#7ac7ff,#bfe6ff);transition:width .3s}
  .glbl{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:11px;text-shadow:0 1px 2px rgba(0,0,0,.4)}

  /* ğŸ’©ï¼†â™ª */
  .poo{position:absolute;z-index:40;cursor:pointer;user-select:none;font-size:clamp(28px,4vw,42px);filter:drop-shadow(0 4px 10px rgba(0,0,0,.35))}
  .noteItem{position:absolute;z-index:41;cursor:pointer;user-select:none;font-size:clamp(24px,3.2vw,36px);filter:drop-shadow(0 4px 10px rgba(0,0,0,.35))}
  .note-float{position:fixed;z-index:60;pointer-events:none;font-size:clamp(20px,3vw,30px);animation:noteFloat 1.2s ease-out forwards}
  @keyframes noteFloat{0%{transform:translateY(0) scale(1);opacity:0}10%{opacity:1}100%{transform:translateY(-120px) scale(1.2);opacity:0}}

  /* ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ ï¼ˆè¦‹ãˆã‚„ã™ãå¼·åŒ–ï¼‰ */
  .musicDock{position:fixed;right:10px;top:106px;z-index:999;background:rgba(0,0,0,.45);border:2px solid rgba(255,255,255,.55);backdrop-filter:blur(8px);border-radius:14px;padding:12px 14px;min-width:236px;box-shadow:0 12px 30px rgba(0,0,0,.5)}
  .musicDock h4{margin:0 0 6px;font-size:13px;opacity:.95}
  .scoreRow{display:flex;gap:6px;flex-wrap:wrap}
  .slot{min-width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.6);position:relative;overflow:hidden}
  .slot.on{background:rgba(255,255,255,.28);border-color:rgba(255,255,255,.9);animation:slotPop .24s ease}
  .slot.on::after{content:"â™ª"; color:#fff; opacity:.98; text-shadow:0 2px 10px rgba(0,0,0,.35); font-weight:800}
  @keyframes slotPop{0%{transform:scale(.85);opacity:.6}100%{transform:scale(1);opacity:1}}
  .slot.on.big{animation:slotPopBig .32s ease}
  @keyframes slotPopBig{0%{transform:scale(.8);opacity:.6}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
</style>
</head>
<body>
  <!-- ä¸Šéƒ¨ï¼šæˆ»ã‚‹ï¼æ›²ãƒªã‚»ãƒƒãƒˆ -->
  <div class="topbar">
    <button class="btn small" id="btnBack">â† ã‚‚ã©ã‚‹</button>
    <span class="chip">é€²åŒ–ã‚¹ãƒ†ãƒ¼ã‚¸ï¼šãã‚‰ãã‚‰æ˜Ÿ</span>
    <div class="spacer"></div>
    <button class="btn small" id="btnResetSong" title="é›†ã‚ãŸâ™ªã‚’ãƒªã‚»ãƒƒãƒˆ">â™ª ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div class="title">éŸ³ç¬¦ã‚’é›†ã‚ã‚ˆã†</div>
  <div class="subtitle">ãŠä¸–è©±ãƒ»åå‰ã‚¿ãƒƒãƒã§éŸ³ç¬¦ãŒå‡ºç¾ã€‚å®Œæˆã—ãŸã‚‰è‡ªå‹•å†ç”Ÿâ†’æ¬¡ã®é€²åŒ–ã¸ã€‚</div>

  <!-- ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ -->
  <aside class="musicDock" id="musicDock" aria-live="polite">
    <h4>ğŸµ ãã‚‰ãã‚‰æ˜Ÿï¼ˆå‰åŠ2ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰</h4>
    <div class="scoreRow" id="scoreRow"></div>
  </aside>

  <!-- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
  <div class="field" id="field">
    <div class="tane" id="tane">
      <div class="bubble" id="bubble"></div>
      <img id="taneImg" alt="tane">
      <div class="nameTag" id="nameTag"></div>
    </div>
  </div>

  <!-- ãŠä¸–è©±ï¼‹é€Ÿåº¦ -->
  <div class="panel">
    <div class="care">
      <button class="btn" id="btnToilet">ğŸš½ ãƒˆã‚¤ãƒ¬</button>
      <button class="btn" id="btnBath">ğŸ› ãŠãµã‚</button>
      <button class="btn" id="btnPlay">ğŸ² ã‚ãã¶</button>
      <button class="btnspeed" data-speed="slow"   onclick="setSpeed('slow')">ğŸ¢</button>
      <button class="btnspeed" data-speed="normal" onclick="setSpeed('normal')">1Ã—</button>
      <button class="btnspeed" data-speed="fast"   onclick="setSpeed('fast')">ğŸ‡</button>
    </div>
    <div class="gauges">
      <div class="gbar" id="gClean"><span></span><div class="glbl">ãã‚Œã„</div></div>
      <div class="gbar" id="gFun"><span></span><div class="glbl">ãŸã®ã—ã•</div></div>
      <div class="gbar" id="gRelief"><span></span><div class="glbl">ã‚¹ãƒƒã‚­ãƒª</div></div>
    </div>
  </div>

<script>
/* ====== å°é“å…· ====== */
const clamp = v => Math.max(0, Math.min(100, v));
const read = (k,d='') => { const v = localStorage.getItem(k); return (v===null||v==='undefined'||v==='null')? d : v; };

/* ====== åŸºæœ¬ ====== */
const PLAYER_NAME = read('PLAYER_NAME','ã‚ãªãŸ');
const CHAR_NAME   = read('CHAR_NAME','ã‚¿ãƒ');
const COLOR       = (read('macaronColor','pink')||'pink').trim().toLowerCase();

/* ====== DOM ====== */
const taneImg  = document.getElementById('taneImg');
const nameTag  = document.getElementById('nameTag');
const bubble   = document.getElementById('bubble');
const field    = document.getElementById('field');
const taneEl   = document.getElementById('tane');
const gClean   = document.getElementById('gClean');
const gFun     = document.getElementById('gFun');
const gRelief  = document.getElementById('gRelief');
const btnToilet= document.getElementById('btnToilet');
const btnBath  = document.getElementById('btnBath');
const btnPlay  = document.getElementById('btnPlay');
const btnBack  = document.getElementById('btnBack');
const btnResetSong = document.getElementById('btnResetSong');
const scoreRow = document.getElementById('scoreRow');

/* ====== ç”»åƒãƒ­ãƒ¼ãƒ€ï¼ˆå¤šæ®µãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ====== */
(function setTaneSrc(){
  const color = (window.COLOR || COLOR || 'pink').toLowerCase();
  const candidates = [
    `tane_${color}.png`,`images/tane_${color}.png`,`img/tane_${color}.png`,`assets/tane_${color}.png`,
    'tane_pink.png','images/tane_pink.png','img/tane_pink.png','assets/tane_pink.png',
    'ako.png','images/ako.png','img/ako.png','assets/ako.png'
  ];
  const bust=`?v=${Date.now()}`;
  function fallback(){
    const img=taneImg, host=taneEl; if(img) img.remove();
    const ph=document.createElement('div');
    ph.style.cssText='width:140px;height:140px;border-radius:50%;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;font-size:54px;backdrop-filter:blur(4px)';
    ph.textContent='â™ª'; host.insertBefore(ph, host.querySelector('.nameTag'));
  }
  (function tryNext(i){
    if(i>=candidates.length) return fallback();
    const url=candidates[i]+bust; const t=new Image();
    t.onload=()=>{ taneImg.src=candidates[i]; }; t.onerror=()=>tryNext(i+1); t.src=url;
  })(0);
})();

/* ====== æ›²ï¼šãã‚‰ãã‚‰æ˜Ÿï¼ˆCãƒ¡ã‚¸ãƒ£ãƒ¼ãƒ»å‰åŠï¼‰ ======
   C4 C4 G4 G4 A4 A4 G4 | F4 F4 E4 E4 D4 D4 C4
   len: 1=å››åˆ†, 2=äºŒåˆ†
*/
const SONG = [
  {n:"ãƒ‰4",len:1},{n:"ãƒ‰4",len:1},{n:"ã‚½4",len:1},{n:"ã‚½4",len:1},{n:"ãƒ©4",len:1},{n:"ãƒ©4",len:1},{n:"ã‚½4",len:2},
  {n:"ãƒ•ã‚¡4",len:1},{n:"ãƒ•ã‚¡4",len:1},{n:"ãƒŸ4",len:1},{n:"ãƒŸ4",len:1},{n:"ãƒ¬4",len:1},{n:"ãƒ¬4",len:1},{n:"ãƒ‰4",len:2}
];

/* ä¿å­˜ã‚­ãƒ¼ï¼ˆã“ã®ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼‰ */
const LS = { list:'whoai_notes_twinkle', poo:'whoai_poo_count2', done:'whoai_song_twinkle_done' };
let collected = JSON.parse(localStorage.getItem(LS.list) || '[]');
let pooCount  = Number(localStorage.getItem(LS.poo) || 0);

/* ====== UIï¼šæˆ»ã‚‹ãƒ»ãƒªã‚»ãƒƒãƒˆ ====== */
btnBack.onclick = ()=>{ location.href = 'naming.html'; }; // 404å›é¿ï¼šå‘½åã‚·ãƒ¼ãƒ³ã¸
btnResetSong.onclick = ()=>{
  document.querySelectorAll('.noteItem').forEach(n=>n.remove());
  collected = [];
  localStorage.removeItem(LS.list);
  localStorage.removeItem(LS.done);
  renderScore();
};

/* ====== åå‰ã‚¿ãƒƒãƒã§1éŸ³å‰é€² ====== */
nameTag.textContent = CHAR_NAME;
nameTag.addEventListener('click', ()=>{
  nameTag.classList.remove('spin'); void nameTag.offsetWidth; nameTag.classList.add('spin');
  taneImg.classList.add('pop'); setTimeout(()=>taneImg.classList.remove('pop'), 250);
  grantNextNote();
});
setInterval(()=> nameTag.classList.toggle('show', Math.random()<0.55), 3000);

/* ====== åŠ±ã¾ã— ====== */
const LINES = ['ã„ã„ãƒšãƒ¼ã‚¹ï¼','ãŒã‚“ã°ã£ã¦ã‚‹ã­','ãã®èª¿å­âœ¨','ã‚ã‚ŠãŒã¨ã†ï¼','ä¼‘æ†©ã‚‚å¤§äº‹ã ã‚ˆ','ã‚ã¨å°‘ã—ï¼','ä¸€ç·’ã«ã„ã“ã†'];
function showBubble(){ bubble.textContent = LINES[(Math.random()*LINES.length)|0];
  bubble.classList.add('show'); setTimeout(()=>bubble.classList.remove('show'),2000); }
setInterval(()=>{ if(Math.random()<0.45) showBubble(); }, 5000);

/* ====== ã‚­ãƒ£ãƒ©ç§»å‹• ====== */
const SPEEDS={slow:0.022,normal:0.036,fast:0.055}; let curSpeed='slow',vx=0,vy=0;
function rs(){return Math.random()<0.5?-1:1}
function setSpeed(mode=curSpeed){
  curSpeed=mode; const base=(innerWidth<520)?(mode==='fast'?0.045:mode==='normal'?0.030:0.018):SPEEDS[mode];
  vx=base*(0.9+Math.random()*0.2)*rs(); vy=base*(0.9+Math.random()*0.2)*rs();
  document.querySelectorAll('.btnspeed').forEach(b=>{const on=b.dataset.speed===mode;b.classList.toggle('active',on);b.setAttribute('aria-pressed',on?'true':'false');});
}
setSpeed('slow');
let last=performance.now(); let pos={x:innerWidth/2,y:innerHeight/2};
function bounds(){ const r=field.getBoundingClientRect(); const w=taneImg.clientWidth||160,h=taneImg.clientHeight||160; return {minX:10,minY:100,maxX:r.width-10,maxY:r.height-140,w,h}; }
function step(now){
  let dt=Math.min(now-last,40); last=now; const b=bounds();
  pos.x+=vx*dt; pos.y+=vy*dt; const hw=b.w/2,hh=b.h/2;
  if(pos.x<b.minX+hw){pos.x=b.minX+hw;vx*=-1} if(pos.x>b.maxX-hw){pos.x=b.maxX-hw;vx*=-1}
  if(pos.y<b.minY+hh){pos.y=b.minY+hh;vy*=-1} if(pos.y>b.maxY-hh){pos.y=b.maxY-hh;vy*=-1}
  taneEl.style.left=`${pos.x}px`; taneEl.style.top=`${pos.y}px`;
  requestAnimationFrame(step);
}
(function initPos(){const b=bounds();pos.x=(b.minX+b.maxX)/2;pos.y=(b.minY+b.maxY)/2;taneEl.style.left=`${pos.x}px`;taneEl.style.top=`${pos.y}px`;})();requestAnimationFrame(step);

/* ====== ã‚²ãƒ¼ã‚¸ ====== */
const SKEY={clean:'e_clean',fun:'e_fun',relief:'e_relief',last:'e_last'};
let clean=Number(localStorage.getItem(SKEY.clean)??70);
let fun=Number(localStorage.getItem(SKEY.fun)??70);
let relief=Number(localStorage.getItem(SKEY.relief)??70);
let lastTick=Number(localStorage.getItem(SKEY.last)??Date.now());
const DECAY_MS=2600,DECAY=1,COOLDOWN=1200;
function setGauge(el,v){v=clamp(v);const s=el.querySelector('span');s.style.width=`${v}%`;s.style.background=v>=66?'linear-gradient(90deg,#8EE6A2,#c9f9d6)':v>=33?'linear-gradient(90deg,#FFD36E,#ffe4a8)':'linear-gradient(90deg,#FF8A8A,#ffc2c2)';}
function renderGauges(){setGauge(gClean,clean);setGauge(gFun,fun);setGauge(gRelief,relief);}
function persistGauges(){localStorage.setItem(SKEY.clean,clean);localStorage.setItem(SKEY.fun,fun);localStorage.setItem(SKEY.relief,relief);localStorage.setItem(SKEY.last,Date.now());}
function tick(){const now=Date.now(); if(now-lastTick>=DECAY_MS){clean=clamp(clean-DECAY);fun=clamp(fun-DECAY);relief=clamp(relief-DECAY);lastTick=now;renderGauges();persistGauges()} requestAnimationFrame(tick);}
function cooldown(b){b.disabled=true;setTimeout(()=>b.disabled=false,COOLDOWN);}
btnToilet.onclick=()=>{cooldown(btnToilet);relief=clamp(relief+18);clean=clamp(clean+4);renderGauges();persistGauges();spawnNoteNearTane();}
btnBath.onclick=()=>{cooldown(btnBath);clean=clamp(clean+22);renderGauges();persistGauges();spawnNoteNearTane();}
btnPlay.onclick=()=>{cooldown(btnPlay);fun=clamp(fun+18);renderGauges();persistGauges();spawnNoteNearTane();}

/* ====== ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºï¼ˆå¿…ãšè¦‹ãˆã‚‹ï¼‰ ====== */
function renderScore(){ scoreRow.innerHTML=''; for(let i=0;i<SONG.length;i++){ const d=document.createElement('div'); d.className='slot'+(i<collected.length?' on':''); scoreRow.appendChild(d); } }
function bounceLastThree(){ const nodes=scoreRow.querySelectorAll('.slot'); const L=nodes.length; for(let i=Math.max(0,L-3);i<L;i++){nodes[i].classList.remove('big');void nodes[i].offsetWidth;nodes[i].classList.add('big');}}

/* ====== ğŸ’©ï¼š55%/3.5sãƒ»10å›ã§æ¬¡ãŒãƒ‰ç³»ãªã‚‰è‡ªå‹•å‰é€² ====== */
const POO_MAX=3;
function spawnPoo(){
  if(field.querySelectorAll('.poo').length>=POO_MAX) return;
  const r=field.getBoundingClientRect(); const x=Math.random()*(r.width-80)+22; const y=Math.random()*(r.height-160)+(r.height*0.45);
  const el=document.createElement('div'); el.className='poo'; el.textContent='ğŸ’©'; el.style.left=`${x}px`; el.style.top=`${y}px`;
  el.onclick=()=>{el.remove(); pooCount++; localStorage.setItem(LS.poo,String(pooCount)); floatNote('ğŸ’§', r.left+x, r.top+y);
    const need=SONG[collected.length]; if(pooCount%10===0 && need && /^ãƒ‰/.test(need.n)) gainNote(need.n);
    relief=clamp(relief+6); clean=clamp(clean+2); renderGauges(); persistGauges();
  };
  field.appendChild(el);
}
setInterval(()=>{ if(Math.random()<0.55) spawnPoo(); }, 3500);

/* ====== â™ªï¼šæ¬¡ã®å¿…è¦éŸ³ã‚’ã‚¹ãƒãƒ¼ãƒ³ï¼ˆè¡¨ç¤ºã¯â™ªã®ã¿ï¼‰ ====== */
function spawnNoteNearTane(){
  const next=SONG[collected.length]; if(!next) return;
  const r=field.getBoundingClientRect(); const tx=pos.x+(Math.random()*120-60); const ty=pos.y+(Math.random()*80-40);
  const x=Math.max(20,Math.min(r.width-40,tx)); const y=Math.max(120,Math.min(r.height-160,ty));
  const el=document.createElement('div'); el.className='noteItem'; el.textContent='â™ª'; el.style.left=`${x}px`; el.style.top=`${y}px`;
  el.onclick=()=>{el.remove(); gainNote(next.n); fun=clamp(fun+6); renderGauges(); persistGauges();};
  field.appendChild(el);
}

/* ãµã‚ã£ã¨ */
function floatNote(char,x,y){ const el=document.createElement('div'); el.className='note-float'; el.textContent=char; el.style.left=`${x}px`; el.style.top=`${y}px`; document.body.appendChild(el); setTimeout(()=>el.remove(),1200); }

/* ====== åé›†ãƒ­ã‚¸ãƒƒã‚¯ ====== */
function grantNextNote(){ if(collected.length<SONG.length) gainNote(SONG[collected.length].n); }
function gainNote(nStr){
  const need=SONG[collected.length]; if(!need || nStr!==need.n) return;
  collected.push(nStr); localStorage.setItem(LS.list, JSON.stringify(collected)); renderScore();
  if(collected.length===SONG.length){
    localStorage.setItem(LS.done,'1'); bounceLastThree();
    playSong(SONG).then(()=>{ prepareNextStageRandomSong(); goEvolveFlow(); });
  }
}

/* ====== å†ç”Ÿï¼ˆWebAudioï¼‰ ====== */
function solfegeToFreq(s){
  const m=s.match(/(ãƒ‰|ãƒ¬|ãƒŸ|ãƒ•ã‚¡|ã‚½|ãƒ©|ã‚·)(\d)/); if(!m) return 440;
  const base={"ãƒ‰":0,"ãƒ¬":2,"ãƒŸ":4,"ãƒ•ã‚¡":5,"ã‚½":7,"ãƒ©":9,"ã‚·":11}[m[1]]; const oct=parseInt(m[2],10);
  const midi=12*(oct+1)+base; return 440*Math.pow(2,(midi-69)/12);
}
async function playSong(seq){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const UNIT=.34, GAP=.06; let t=ctx.currentTime;
    for(const obj of seq){
      const dur=UNIT*(obj.len||1);
      const osc=ctx.createOscillator(), g=ctx.createGain();
      osc.type='sine'; osc.frequency.value=solfegeToFreq(obj.n);
      g.gain.setValueAtTime(.0001,t); g.gain.linearRampToValueAtTime(.18,t+.03); g.gain.setTargetAtTime(.0001,t+dur*.8,.06);
      osc.connect(g).connect(ctx.destination); osc.start(t); osc.stop(t+dur); t+=dur+GAP;
    }
    await new Promise(r=>setTimeout(r,(t-ctx.currentTime)*1000+80));
    ctx.close();
  }catch(e){ console.warn(e); }
}

/* ====== æ¬¡ã‚¹ãƒ†ãƒ¼ã‚¸ã®æ›²ã‚’ãƒ©ãƒ³ãƒ€ãƒ æ±ºå®šï¼ˆ1ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰ ====== */
function prepareNextStageRandomSong(){
  const packs = {
    silent_night: {name:"ãã‚ˆã—ã“ã®å¤œ", seq:[
      {n:"ã‚½4",len:2},{n:"ãƒ©4",len:1},{n:"ã‚½4",len:2},{n:"ãƒŸ4",len:3},
      {n:"ã‚½4",len:2},{n:"ãƒ©4",len:1},{n:"ã‚½4",len:2},{n:"ãƒŸ4",len:3}
    ]},
  
    london_bridge: {name:"ãƒ­ãƒ³ãƒ‰ãƒ³æ©‹", seq:[
      {n:"ã‚½4",len:2},{n:"ãƒ©4",len:1},{n:"ã‚½4",len:2},{n:"ãƒ•ã‚¡4",len:2},{n:"ãƒŸ4",len:2},{n:"ãƒ•ã‚¡4",len:2},{n:"ã‚½4",len:4}
    ]}
  };
  const keys = Object.keys(packs);
  const pick = packs[keys[(Math.random()*keys.length)|0]];
  localStorage.setItem('EVOLVE_NEXT_SONG_KEY', pick.name);
  localStorage.setItem('EVOLVE_NEXT_SONG_SEQ', JSON.stringify(pick.seq));
}

/* ====== å®Œäº†å¾Œãƒ•ãƒ­ãƒ¼ï¼šãƒã‚«ãƒ­ãƒ³â†’å‘½åâ†’ãƒ¢ãƒ¼ãƒ‰é¸æŠã«æˆ»ã™ ====== */
function goEvolveFlow(){
  localStorage.setItem('FLOW_AFTER_MACARON', 'naming.html');
  localStorage.setItem('FLOW_AFTER_NAMING',  'whoai_select_mode.html');
  localStorage.setItem('FLOW_FALLBACK', 'index.html');
  location.href = 'macaron_select.html';
}

/* ====== èµ·å‹•ï¼šå¿…ãšè¦‹ãˆã‚‹ï¼†â™ªãŒå‡ºã‚‹ ====== */
function renderAll(){ renderGauges(); renderScore(); }
(function init(){
  renderAll(); requestAnimationFrame(tick);
  nameTag.classList.add('show');

  // èµ·å‹•æ™‚ã«æœ€åˆã®â™ªã‚’å¿…ãšå‡ºã™
  setTimeout(()=>{ if(collected.length<SONG.length) spawnNoteNearTane(); }, 800);
  // 7ç§’ã”ã¨ã«ä¿é™ºã‚¹ãƒãƒ¼ãƒ³ï¼ˆæ—¢ã«â™ªãŒç„¡ã‘ã‚Œã°ï¼‰
  setInterval(()=>{
    if(collected.length<SONG.length && !document.querySelector('.noteItem')) spawnNoteNearTane();
  }, 7000);
  // ã©ã“ã‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰â™ªã‚’å‡ºã™ï¼ˆé™ã‹ãªæ™‚ã®æ•‘æ¸ˆï¼‰
  field.addEventListener('click', (e)=>{
    if(e.target.closest('.noteItem,.poo,.btn,.btnspeed,.nameTag')) return;
    if(collected.length<SONG.length) spawnNoteNearTane();
  });

  // å®Œæˆæ¸ˆã¿ãªã‚‰æ¼”å¥â†’æ¬¡ãƒ•ãƒ­ãƒ¼
  if(localStorage.getItem(LS.done)==='1'){ playSong(SONG).then(()=>{ prepareNextStageRandomSong(); goEvolveFlow(); }); }
})();
</script>
</body>
</html>
